<audio title="11_è®¾ç½®å·¥ä½œæ¨¡å¼ä¸ç¯å¢ƒï¼ˆä¸­ï¼‰ï¼šå»ºé€ äºŒçº§å¼•å¯¼å™¨" src="https://static001.geekbang.org/resource/audio/b4/55/b4bef1d15a7b2e8daa0946aayyb6df55.mp3" controls="controls"></audio> 
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯LMOSã€‚</p><p>ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬å»ºé€ äº†å±äºæˆ‘ä»¬çš„â€œè®¡ç®—æœºâ€ï¼Œå¹¶ä¸”åœ¨ä¸Šé¢å®‰è£…å¥½äº†GRUBã€‚è¿™èŠ‚è¯¾æˆ‘ä¼šå¸¦ä½ ä¸€èµ·å®ç°äºŒçº§å¼•å¯¼å™¨è¿™ä¸ªå…³é”®ç»„ä»¶ã€‚</p><p>çœ‹åˆ°è¿™å„¿ä½ å¯èƒ½ä¼šé—®ï¼ŒGRUBä¸æ˜¯å·²ç»æŠŠæˆ‘ä»¬çš„æ“ä½œç³»ç»ŸåŠ è½½åˆ°å†…å­˜ä¸­äº†å—ï¼Ÿæˆ‘ä»¬æœ‰äº†GRUBï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆè¿˜è¦å®ç°äºŒçº§å¼•å¯¼å™¨å‘¢ï¼Ÿ</p><p>è¿™é‡Œæˆ‘è¦ç»™ä½ è¯´è¯´æˆ‘çš„è§‚ç‚¹ï¼ŒäºŒçº§å¼•å¯¼å™¨ä½œä¸ºæ“ä½œç³»ç»Ÿçš„å…ˆé©±ï¼Œå®ƒéœ€è¦<strong>æ”¶é›†æœºå™¨ä¿¡æ¯</strong>ï¼Œç¡®å®šè¿™ä¸ªè®¡ç®—æœºèƒ½ä¸èƒ½è¿è¡Œæˆ‘ä»¬çš„æ“ä½œç³»ç»Ÿï¼Œå¯¹CPUã€å†…å­˜ã€æ˜¾å¡è¿›è¡Œä¸€äº›åˆçº§çš„é…ç½®ï¼Œæ”¾ç½®å¥½å†…æ ¸ç›¸å…³çš„æ–‡ä»¶ã€‚</p><p>å› ä¸ºæˆ‘ä»¬äºŒçº§å¼•å¯¼å™¨ä¸æ˜¯æ‰§è¡Œå…·ä½“çš„åŠ è½½ä»»åŠ¡çš„ï¼Œè€Œæ˜¯è§£æå†…æ ¸æ–‡ä»¶ã€æ”¶é›†æœºå™¨ç¯å¢ƒä¿¡æ¯ï¼Œå®ƒå…·ä½“æ”¶é›†å“ªäº›ä¿¡æ¯ï¼Œæˆ‘ä¼šåœ¨ä¸‹èŠ‚è¯¾è¯¦ç»†å±•å¼€ã€‚</p><h2>è®¾è®¡æœºå™¨ä¿¡æ¯ç»“æ„</h2><p>äºŒçº§å¼•å¯¼å™¨æ”¶é›†çš„ä¿¡æ¯ï¼Œéœ€è¦åœ°ç‚¹å­˜æ”¾ï¼Œæˆ‘ä»¬éœ€è¦è®¾è®¡ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚ä¿¡æ¯æ”¾åœ¨è¿™ä¸ªæ•°æ®ç»“æ„ä¸­ï¼Œè¿™ä¸ªç»“æ„æ”¾åœ¨å†…å­˜1MBçš„åœ°æ–¹ï¼Œæ–¹ä¾¿ä»¥åä¼ ç»™æˆ‘ä»¬çš„æ“ä½œç³»ç»Ÿã€‚</p><p>ä¸ºäº†è®©ä½ æŠ“ä½é‡ç‚¹ï¼Œæˆ‘é€‰å–äº†è¿™ä¸ªæ•°æ®ç»“æ„çš„<strong>å…³é”®ä»£ç </strong>ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰åˆ—å‡ºè¯¥ç»“æ„çš„æ‰€æœ‰å­—æ®µï¼ˆCosmos/initldr/include/ldrtype.hï¼‰ï¼Œè¿™ä¸ªç»“æ„å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>typedef struct s_MACHBSTART
{
    u64_t   mb_krlinitstack;//å†…æ ¸æ ˆåœ°å€
    u64_t   mb_krlitstacksz;//å†…æ ¸æ ˆå¤§å°
    u64_t   mb_imgpadr;//æ“ä½œç³»ç»Ÿæ˜ åƒ
    u64_t   mb_imgsz;//æ“ä½œç³»ç»Ÿæ˜ åƒå¤§å°
    u64_t   mb_bfontpadr;//æ“ä½œç³»ç»Ÿå­—ä½“åœ°å€
    u64_t   mb_bfontsz;//æ“ä½œç³»ç»Ÿå­—ä½“å¤§å°
    u64_t   mb_fvrmphyadr;//æœºå™¨æ˜¾å­˜åœ°å€
    u64_t   mb_fvrmsz;//æœºå™¨æ˜¾å­˜å¤§å°
    u64_t   mb_cpumode;//æœºå™¨CPUå·¥ä½œæ¨¡å¼
    u64_t   mb_memsz;//æœºå™¨å†…å­˜å¤§å°
    u64_t   mb_e820padr;//æœºå™¨e820æ•°ç»„åœ°å€
    u64_t   mb_e820nr;//æœºå™¨e820æ•°ç»„å…ƒç´ ä¸ªæ•°
    u64_t   mb_e820sz;//æœºå™¨e820æ•°ç»„å¤§å°
    //â€¦â€¦
    u64_t   mb_pml4padr;//æœºå™¨é¡µè¡¨æ•°æ®åœ°å€
    u64_t   mb_subpageslen;//æœºå™¨é¡µè¡¨ä¸ªæ•°
    u64_t   mb_kpmapphymemsz;//æ“ä½œç³»ç»Ÿæ˜ å°„ç©ºé—´å¤§å°
    //â€¦â€¦
    graph_t mb_ghparm;//å›¾å½¢ä¿¡æ¯
}__attribute__((packed)) machbstart_t;
</code></pre><h2>è§„åˆ’äºŒçº§å¼•å¯¼å™¨</h2><p>åœ¨å¼€å§‹å†™ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ä»æ•´ä½“åˆ’åˆ†ä¸€ä¸‹äºŒçº§å¼•å¯¼å™¨çš„åŠŸèƒ½æ¨¡å—ï¼Œä»å…¨å±€äº†è§£ä¸‹åŠŸèƒ½åº”è¯¥æ€ä¹ˆåˆ’åˆ†ï¼Œè¿™é‡Œæˆ‘ç‰¹æ„ä¸ºä½ æ¢³ç†äº†ä¸€ä¸ªè¡¨æ ¼ã€‚</p><!-- [[[read_end]]] --><p><img src="https://static001.geekbang.org/resource/image/31/1e/3169e9db4549ab036c2de269788a281e.jpg?wh=1636*846" alt="" title="äºŒçº§å¼•å¯¼å™¨åŠŸèƒ½åˆ’åˆ†è¡¨"></p><p>å‰é¢è¡¨æ ¼é‡Œçš„è¿™äº›æ–‡ä»¶ï¼Œæˆ‘éƒ½æ”¾åœ¨äº†è¯¾ç¨‹é…å¥—æºç ä¸­äº†ï¼Œä½ å¯ä»¥ä»<a href="https://gitee.com/lmos/cosmos/tree/master/lesson10~11">è¿™é‡Œ</a>ä¸‹è½½ã€‚</p><p>ä¸Šè¿°è¿™äº›æ–‡ä»¶éƒ½åœ¨lesson10ï½11/Cosmos/initldr/ldrkrlç›®å½•ä¸­ï¼Œå®ƒä»¬åœ¨ç¼–è¯‘ä¹‹åä¼šå½¢æˆä¸‰ä¸ªæ–‡ä»¶ï¼Œç¼–è¯‘è„šæœ¬æˆ‘å·²ç»å†™å¥½äº†ï¼Œä¸‹é¢æˆ‘ä»¬ç”¨ä¸€å¹…å›¾æ¥å±•ç¤ºè¿™ä¸ªç¼–è¯‘è¿‡ç¨‹ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/bd/40/bd55f67d02edff4415f06c914403bc40.jpg?wh=5005*3110" alt="" title="äºŒçº§å¼•å¯¼å™¨ç¼–è¯‘è¿‡ç¨‹ç¤ºæ„å›¾"></p><p>è¿™æœ€åä¸‰ä¸ªæ–‡ä»¶ç”¨æˆ‘ä»¬å‰é¢è¯´çš„æ˜ åƒå·¥å…·æ‰“åŒ…æˆæ˜ åƒæ–‡ä»¶ï¼Œå…¶æŒ‡ä»¤å¦‚ä¸‹ã€‚</p><pre><code>lmoskrlimg -m k -lhf initldrimh.bin -o Cosmos.eki -f initldrkrl.bin initldrsve.bin
</code></pre><h2>å®ç°GRUBå¤´</h2><p>æˆ‘ä»¬çš„GRUBå¤´æœ‰ä¸¤ä¸ªæ–‡ä»¶ç»„æˆï¼Œ<strong>ä¸€ä¸ªimginithead.asmæ±‡ç¼–æ–‡ä»¶</strong>ï¼Œå®ƒæœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼Œæ—¢èƒ½è®©GRUBè¯†åˆ«ï¼Œåˆèƒ½è®¾ç½®Cè¯­è¨€è¿è¡Œç¯å¢ƒï¼Œç”¨äºè°ƒç”¨Cå‡½æ•°ï¼›<strong>ç¬¬äºŒå°±æ˜¯inithead.cæ–‡ä»¶</strong>ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½æ˜¯æŸ¥æ‰¾äºŒçº§å¼•å¯¼å™¨çš„æ ¸å¿ƒæ–‡ä»¶â€”â€”initldrkrl.binï¼Œç„¶åæŠŠå®ƒæ”¾ç½®åˆ°ç‰¹å®šçš„å†…å­˜åœ°å€ä¸Šã€‚</p><p>æˆ‘ä»¬å…ˆæ¥å®ç°imginithead.asmï¼Œå®ƒä¸»è¦å·¥ä½œæ˜¯åˆå§‹åŒ–CPUçš„å¯„å­˜å™¨ï¼ŒåŠ è½½GDTï¼Œåˆ‡æ¢åˆ°CPUçš„ä¿æŠ¤æ¨¡å¼ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥å®ç°ã€‚</p><p>é¦–å…ˆæ˜¯GRUB1å’ŒGRUB2éœ€è¦çš„ä¸¤ä¸ªå¤´ç»“æ„ï¼Œä»£ç å¦‚ä¸‹ã€‚</p><pre><code>MBT_HDR_FLAGS	EQU 0x00010003
MBT_HDR_MAGIC	EQU 0x1BADB002
MBT2_MAGIC	EQU 0xe85250d6
global _start
extern inithead_entry
[section .text]
[bits 32]
_start:
	jmp _entry
align 4
mbt_hdr:
	dd MBT_HDR_MAGIC
	dd MBT_HDR_FLAGS
	dd -(MBT_HDR_MAGIC+MBT_HDR_FLAGS)
	dd mbt_hdr
	dd _start
	dd 0
	dd 0
	dd _entry
ALIGN 8
mbhdr:
	DD	0xE85250D6
	DD	0
	DD	mhdrend - mbhdr
	DD	-(0xE85250D6 + 0 + (mhdrend - mbhdr))
	DW	2, 0
	DD	24
	DD	mbhdr
	DD	_start
	DD	0
	DD	0
	DW	3, 0
	DD	12
	DD	_entry 
	DD  0  
	DW	0, 0
	DD	8
mhdrend:
</code></pre><p>ç„¶åæ˜¯å…³ä¸­æ–­å¹¶åŠ è½½GDTï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>_entry:
	cli           ï¼›å…³ä¸­æ–­
	in al, 0x70 
	or al, 0x80	
	out 0x70,al  ï¼›å…³æ‰ä¸å¯å±è”½ä¸­æ–­   
	lgdt [GDT_PTR] ï¼›åŠ è½½GDTåœ°å€åˆ°GDTRå¯„å­˜å™¨
	jmp dword 0x8 :_32bits_mode ï¼›é•¿è·³è½¬åˆ·æ–°CSå½±å­å¯„å­˜å™¨
  ;â€¦â€¦â€¦â€¦â€¦â€¦
;GDTå…¨å±€æ®µæè¿°ç¬¦è¡¨
GDT_START:
knull_dsc: dq 0
kcode_dsc: dq 0x00cf9e000000ffff
kdata_dsc: dq 0x00cf92000000ffff
k16cd_dsc: dq 0x00009e000000ffff ï¼›16ä½ä»£ç æ®µæè¿°ç¬¦
k16da_dsc: dq 0x000092000000ffff ï¼›16ä½æ•°æ®æ®µæè¿°ç¬¦
GDT_END:
GDT_PTR:
GDTLEN	dw GDT_END-GDT_START-1	;GDTç•Œé™
GDTBASE	dd GDT_START
</code></pre><p>æœ€åæ˜¯åˆå§‹åŒ–æ®µå¯„å­˜å™¨å’Œé€šç”¨å¯„å­˜å™¨ã€æ ˆå¯„å­˜å™¨ï¼Œè¿™æ˜¯ä¸ºäº†ç»™è°ƒç”¨inithead_entryè¿™ä¸ªCå‡½æ•°åšå‡†å¤‡ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>_32bits_modeï¼š
	mov ax, 0x10
	mov ds, ax
	mov ss, ax
	mov es, ax
	mov fs, ax
	mov gs, ax
	xor eax,eax
	xor ebx,ebx
	xor ecx,ecx
	xor edx,edx
	xor edi,edi
	xor esi,esi
	xor ebp,ebp
	xor esp,esp
	mov esp,0x7c00 ï¼›è®¾ç½®æ ˆé¡¶ä¸º0x7c00
	call inithead_entry ï¼›è°ƒç”¨inithead_entryå‡½æ•°åœ¨inithead.cä¸­å®ç°
	jmp 0x200000  ï¼›è·³è½¬åˆ°0x200000åœ°å€
</code></pre><p>ä¸Šè¿°ä»£ç çš„æœ€åè°ƒç”¨äº†inithead_entryå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æˆ‘ä»¬éœ€è¦å¦å¤–åœ¨inithead.cä¸­å®ç°ï¼Œæˆ‘ä»¬è¿™å°±æ¥å®ç°å®ƒï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>#define MDC_ENDGIC 0xaaffaaffaaffaaff
#define MDC_RVGIC 0xffaaffaaffaaffaa
#define REALDRV_PHYADR 0x1000
#define IMGFILE_PHYADR 0x4000000
#define IMGKRNL_PHYADR 0x2000000
#define LDRFILEADR IMGFILE_PHYADR
#define MLOSDSC_OFF (0x1000)
#define MRDDSC_ADR (mlosrddsc_t*)(LDRFILEADR+0x1000)

void inithead_entry()
{
    write_realintsvefile();
    write_ldrkrlfile();
    return;
}
//å†™initldrsve.binæ–‡ä»¶åˆ°ç‰¹å®šçš„å†…å­˜ä¸­
void write_realintsvefile()
{
    fhdsc_t *fhdscstart = find_file(&quot;initldrsve.bin&quot;);
    if (fhdscstart == NULL)
    {
        error(&quot;not file initldrsve.bin&quot;);
    }
    m2mcopy((void *)((u32_t)(fhdscstart-&gt;fhd_intsfsoff) + LDRFILEADR),
            (void *)REALDRV_PHYADR, (sint_t)fhdscstart-&gt;fhd_frealsz);
    return;
}
//å†™initldrkrl.binæ–‡ä»¶åˆ°ç‰¹å®šçš„å†…å­˜ä¸­
void write_ldrkrlfile()
{
    fhdsc_t *fhdscstart = find_file(&quot;initldrkrl.bin&quot;);
    if (fhdscstart == NULL)
    {
        error(&quot;not file initldrkrl.bin&quot;);
    }
    m2mcopy((void *)((u32_t)(fhdscstart-&gt;fhd_intsfsoff) + LDRFILEADR),
            (void *)ILDRKRL_PHYADR, (sint_t)fhdscstart-&gt;fhd_frealsz);
    return;
}
//åœ¨æ˜ åƒæ–‡ä»¶ä¸­æŸ¥æ‰¾å¯¹åº”çš„æ–‡ä»¶
fhdsc_t *find_file(char_t *fname)
{
    mlosrddsc_t *mrddadrs = MRDDSC_ADR;
    if (mrddadrs-&gt;mdc_endgic != MDC_ENDGIC ||
        mrddadrs-&gt;mdc_rv != MDC_RVGIC ||
        mrddadrs-&gt;mdc_fhdnr &lt; 2 ||
        mrddadrs-&gt;mdc_filnr &lt; 2)
    {
        error(&quot;no mrddsc&quot;);
    }
    s64_t rethn = -1;
    fhdsc_t *fhdscstart = (fhdsc_t *)((u32_t)(mrddadrs-&gt;mdc_fhdbk_s) + LDRFILEADR);
    for (u64_t i = 0; i &lt; mrddadrs-&gt;mdc_fhdnr; i++)
    {
        if (strcmpl(fname, fhdscstart[i].fhd_name) == 0)
        {
            rethn = (s64_t)i;
            goto ok_l;
        }
    }
    rethn = -1;
ok_l:
    if (rethn &lt; 0)
    {
        error(&quot;not find file&quot;);
    }
    return &amp;fhdscstart[rethn];
}
</code></pre><p>æˆ‘ä»¬å®ç°äº†inithead_entryå‡½æ•°ï¼Œå®ƒä¸»è¦å¹²äº†ä¸¤ä»¶äº‹ï¼Œå³åˆ†åˆ«è°ƒç”¨write_realintsvefile();ã€write_ldrkrlfile()å‡½æ•°ï¼ŒæŠŠæ˜ åƒæ–‡ä»¶ä¸­çš„initldrsve.binæ–‡ä»¶å’Œinitldrkrl.binæ–‡ä»¶å†™å…¥åˆ°ç‰¹å®šçš„å†…å­˜åœ°å€ç©ºé—´ä¸­ï¼Œå…·ä½“åœ°å€åœ¨ä¸Šé¢ä»£ç ä¸­çš„å®æœ‰è¯¦ç»†å®šä¹‰ã€‚</p><p>è¿™ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«ä¾èµ–äºfind_fileå’Œm2mcopyå‡½æ•°ã€‚</p><p>æ­£å¦‚å…¶åï¼Œfind_fileå‡½æ•°è´Ÿè´£æ‰«ææ˜ åƒæ–‡ä»¶ä¸­çš„æ–‡ä»¶å¤´æè¿°ç¬¦ï¼Œå¯¹æ¯”å…¶ä¸­çš„æ–‡ä»¶åï¼Œç„¶åè¿”å›å¯¹åº”çš„æ–‡ä»¶å¤´æè¿°ç¬¦çš„åœ°å€ï¼Œè¿™æ ·å°±å¯ä»¥å¾—åˆ°æ–‡ä»¶åœ¨æ˜ åƒæ–‡ä»¶ä¸­çš„ä½ç½®å’Œå¤§å°äº†ã€‚</p><p>find_fileå‡½æ•°çš„æ¥åŠ›é˜Ÿå‹å°±æ˜¯m2mcopyå‡½æ•°ï¼Œå› ä¸ºæŸ¥æ‰¾å¯¹æ¯”ä¹‹åï¼Œæœ€åå°±æ˜¯m2mcopyå‡½æ•°è´Ÿè´£æŠŠæ˜ åƒæ–‡ä»¶å¤åˆ¶åˆ°å…·ä½“çš„å†…å­˜ç©ºé—´é‡Œã€‚</p><p>ä»£ç ä¸­çš„å…¶å®ƒå‡½æ•°æˆ‘å°±ä¸å±•å¼€äº†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦è¯·è‡ªè¡Œç ”ç©¶ï¼Œæˆ–è€…è‡ªå·±æ”¹å†™ã€‚</p><h2>è¿›å…¥äºŒçº§å¼•å¯¼å™¨</h2><p>ä½ åº”è¯¥è¿˜æœ‰å°è±¡ï¼Œåˆšæ‰è¯´çš„å®ç°GRUBå¤´è¿™ä¸ªéƒ¨åˆ†ï¼Œåœ¨imghead.asmæ±‡ç¼–æ–‡ä»¶ä»£ç ä¸­ï¼Œæˆ‘ä»¬çš„æœ€åä¸€æ¡æŒ‡ä»¤æ˜¯â€œ<strong>jmp 0x200000</strong>â€ï¼Œå³è·³è½¬åˆ°ç‰©ç†å†…å­˜çš„0x200000åœ°å€å¤„ã€‚</p><p>è¯·ä½ æ³¨æ„ï¼Œè¿™æ—¶åœ°å€è¿˜æ˜¯ç‰©ç†åœ°å€ï¼Œè¿™ä¸ªåœ°å€æ­£æ˜¯åœ¨inithead.cä¸­ç”±write_ldrkrlfile()å‡½æ•°æ”¾ç½®çš„initldrkrl.binæ–‡ä»¶ï¼Œè¿™ä¸€è·³å°±è¿›å…¥äº†äºŒçº§å¼•å¯¼å™¨çš„ä¸»æ¨¡å—äº†ã€‚</p><p>ç”±äºæ¨¡å—çš„æ”¹å˜ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å†™ä¸€å°æ®µæ±‡ç¼–ä»£ç ï¼Œå»ºç«‹ä¸‹é¢è¿™ä¸ªinitldr32.asmï¼ˆé…å¥—ä»£ç åº“ä¸­å¯¹åº”ldrkrl32.asmï¼‰æ–‡ä»¶ï¼Œå¹¶å†™ä¸Šå¦‚ä¸‹ä»£ç ã€‚</p><pre><code>_entry:
	cli
	lgdt [GDT_PTR]ï¼›åŠ è½½GDTåœ°å€åˆ°GDTRå¯„å­˜å™¨
	lidt [IDT_PTR]ï¼›åŠ è½½IDTåœ°å€åˆ°IDTRå¯„å­˜å™¨
	jmp dword 0x8 :_32bits_modeï¼›é•¿è·³è½¬åˆ·æ–°CSå½±å­å¯„å­˜å™¨
_32bits_mode:
	mov ax, 0x10	; æ•°æ®æ®µé€‰æ‹©å­(ç›®çš„)
	mov ds, ax
	mov ss, ax
	mov es, ax
	mov fs, ax
	mov gs, ax
	xor eax,eax
	xor ebx,ebx
	xor ecx,ecx
	xor edx,edx
	xor edi,edi
	xor esi,esi
	xor ebp,ebp
	xor esp,esp
	mov esp,0x90000 ï¼›ä½¿å¾—æ ˆåº•æŒ‡å‘äº†0x90000
	call ldrkrl_entry ï¼›è°ƒç”¨ldrkrl_entryå‡½æ•°
	xor ebx,ebx
	jmp 0x2000000 ï¼›è·³è½¬åˆ°0x2000000çš„å†…å­˜åœ°å€
	jmp $
GDT_START:
knull_dsc: dq 0
kcode_dsc: dq 0x00cf9a000000ffff ;a-e
kdata_dsc: dq 0x00cf92000000ffff
k16cd_dsc: dq 0x00009a000000ffff ï¼›16ä½ä»£ç æ®µæè¿°ç¬¦
k16da_dsc: dq 0x000092000000ffff ï¼›16ä½æ•°æ®æ®µæè¿°ç¬¦
GDT_END:
GDT_PTR:
GDTLEN	dw GDT_END-GDT_START-1	;GDTç•Œé™
GDTBASE	dd GDT_START

IDT_PTR:
IDTLEN	dw 0x3ff
IDTBAS	dd 0  ï¼›è¿™æ˜¯BIOSä¸­æ–­è¡¨çš„åœ°å€å’Œé•¿åº¦
</code></pre><p>æˆ‘æ¥ç»™ä½ åšä¸ªè§£è¯»ï¼Œä»£ç çš„1ï½4è¡Œæ˜¯åœ¨åŠ è½½GDTRå’ŒIDTRå¯„å­˜å™¨ï¼Œç„¶ååˆå§‹åŒ–CPUç›¸å…³çš„å¯„å­˜å™¨ã€‚</p><p>å’Œå…ˆå‰ä¸€æ ·ï¼Œå› ä¸ºä»£ç æ¨¡å—çš„æ”¹å˜ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŠŠGDTã€IDTï¼Œå¯„å­˜å™¨è¿™äº›ä¸œè¥¿é‡æ–°åˆå§‹åŒ–ï¼Œæœ€åå†å»è°ƒç”¨äºŒçº§å¼•å¯¼å™¨çš„ä¸»å‡½æ•°ldrkrl_entryã€‚</p><h2>å·§å¦™è°ƒç”¨BIOSä¸­æ–­</h2><p>æˆ‘ä»¬ä¸è¦æ€¥ç€å»å†™ldrkrl_entryå‡½æ•°ï¼Œå› ä¸ºåœ¨åé¢æˆ‘ä»¬è¦è·å¾—å†…å­˜å¸ƒå±€ä¿¡æ¯ï¼Œè¦è®¾ç½®æ˜¾å¡å›¾å½¢æ¨¡å¼ï¼Œè€Œè¿™äº›åŠŸèƒ½ä¾èµ–äºBIOSæä¾›ä¸­æ–­æœåŠ¡ã€‚</p><p>å¯æ˜¯ï¼Œè¦åœ¨Cå‡½æ•°ä¸­è°ƒç”¨BIOSä¸­æ–­æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºCè¯­è¨€ä»£ç å·¥ä½œåœ¨32ä½ä¿æŠ¤æ¨¡å¼ä¸‹ï¼ŒBIOSä¸­æ–­å·¥ä½œåœ¨16ä½çš„å®æ¨¡å¼ã€‚</p><p>æ‰€ä»¥ï¼ŒCè¯­è¨€ç¯å¢ƒä¸‹è°ƒç”¨BIOSä¸­æ–­ï¼Œéœ€è¦å¤„ç†çš„é—®é¢˜å¦‚ä¸‹ï¼š</p><p>1.ä¿å­˜Cè¯­è¨€ç¯å¢ƒä¸‹çš„CPUä¸Šä¸‹æ–‡ ï¼Œå³ä¿æŠ¤æ¨¡å¼ä¸‹çš„æ‰€æœ‰é€šç”¨å¯„å­˜å™¨ã€æ®µå¯„å­˜å™¨ã€ç¨‹åºæŒ‡é’ˆå¯„å­˜å™¨ï¼Œæ ˆå¯„å­˜å™¨ï¼ŒæŠŠå®ƒä»¬éƒ½ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚<br>
2.åˆ‡æ¢å›å®æ¨¡å¼ï¼Œè°ƒç”¨BIOSä¸­æ–­ï¼ŒæŠŠBIOSä¸­æ–­è¿”å›çš„ç›¸å…³ç»“æœï¼Œä¿å­˜åœ¨å†…å­˜ä¸­ã€‚<br>
3.åˆ‡æ¢å›ä¿æŠ¤æ¨¡å¼ï¼Œé‡æ–°åŠ è½½ç¬¬1æ­¥ä¸­ä¿å­˜çš„å¯„å­˜å™¨ã€‚è¿™æ ·Cè¯­è¨€ä»£ç æ‰èƒ½é‡æ–°æ¢å¤æ‰§è¡Œã€‚</p><p>è¦å®Œæˆä¸Šé¢çš„åŠŸèƒ½ï¼Œå¿…é¡»è¦å†™ä¸€ä¸ªæ±‡ç¼–å‡½æ•°æ‰èƒ½å®Œæˆï¼Œæˆ‘ä»¬å°±æŠŠå®ƒå†™åœ¨ldrkrl32.asmæ–‡ä»¶ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤º ã€‚</p><pre><code>realadr_call_entry:
	pushad     ;ä¿å­˜é€šç”¨å¯„å­˜å™¨
	push    ds
	push    es
	push    fs ;ä¿å­˜4ä¸ªæ®µå¯„å­˜å™¨
	push    gs
	call save_eip_jmp ï¼›è°ƒç”¨save_eip_jmp 
	pop	gs
	pop	fs
	pop	es      ;æ¢å¤4ä¸ªæ®µå¯„å­˜å™¨
	pop	ds
	popad       ;æ¢å¤é€šç”¨å¯„å­˜å™¨
	ret
save_eip_jmp:
	pop esi  ï¼›å¼¹å‡ºcall save_eip_jmpæ—¶ä¿å­˜çš„eipåˆ°esiå¯„å­˜å™¨ä¸­ï¼Œ 
	mov [PM32_EIP_OFF],esi ï¼›æŠŠeipä¿å­˜åˆ°ç‰¹å®šçš„å†…å­˜ç©ºé—´ä¸­
	mov [PM32_ESP_OFF],esp ï¼›æŠŠespä¿å­˜åˆ°ç‰¹å®šçš„å†…å­˜ç©ºé—´ä¸­
	jmp dword far [cpmty_mode]ï¼›é•¿è·³è½¬è¿™é‡Œè¡¨ç¤ºæŠŠcpmty_modeå¤„çš„ç¬¬ä¸€ä¸ª4å­—èŠ‚è£…å…¥eipï¼ŒæŠŠå…¶åçš„2å­—èŠ‚è£…å…¥cs
cpmty_mode:
	dd 0x1000
	dw 0x18
	jmp $
</code></pre><p>ä¸Šé¢çš„ä»£ç æˆ‘åˆ—äº†è¯¦ç»†æ³¨é‡Šï¼Œä½ ä¸€çœ‹å°±èƒ½æ˜ç™½ã€‚ä¸è¿‡è¿™é‡Œå”¯ä¸€ä¸å¥½æ‡‚çš„æ˜¯<strong>jmp dword far [cpmty_mode]æŒ‡ä»¤</strong>ï¼Œåˆ«æ‹…å¿ƒï¼Œå¬æˆ‘ç»™ä½ è§£è¯»ä¸€ä¸‹ã€‚</p><p>å…¶å®è¿™ä¸ªæŒ‡ä»¤æ˜¯ä¸€ä¸ª<strong>é•¿è·³è½¬</strong>ï¼Œè¡¨ç¤ºæŠŠ[cpmty_mode]å¤„çš„æ•°æ®è£…å…¥CSï¼šEIPï¼Œä¹Ÿå°±æ˜¯æŠŠ0x18ï¼š0x1000è£…å…¥åˆ°CSï¼šEIPä¸­ã€‚</p><p>è¿™ä¸ª0x18å°±æ˜¯æ®µæè¿°ç´¢å¼•ï¼ˆè¿™ä¸ªçŸ¥è¯†ç‚¹ä¸ç†Ÿæ‚‰çš„è¯ï¼Œä½ å¯ä»¥å›çœ‹æˆ‘ä»¬<a href="https://time.geekbang.org/column/article/375278">ç¬¬äº”èŠ‚è¯¾</a>ï¼‰ï¼Œå®ƒæ­£æ˜¯æŒ‡å‘GDTä¸­çš„16ä½ä»£ç æ®µæè¿°ç¬¦ï¼›0x1000ä»£è¡¨æ®µå†…çš„åç§»åœ°å€ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªåœ°å€ä¸Šï¼Œæˆ‘ä»¬å¿…é¡»æ”¾ä¸€æ®µä»£ç æŒ‡ä»¤ï¼Œä¸ç„¶CPUè·³è½¬åˆ°è¿™é‡Œå°†æ²¡æŒ‡ä»¤å¯ä»¥æ‰§è¡Œï¼Œé‚£æ ·å°±ä¼šå‘ç”Ÿé”™è¯¯ã€‚</p><p>å› ä¸ºè¿™æ˜¯ä¸€ä¸ª16ä½ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ–°å»ºç«‹ä¸€ä¸ªæ–‡ä»¶realintsve.asmï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>[bits 16]
_start:
_16_mode:
	mov	bp,0x20 ;0x20æ˜¯æŒ‡å‘GDTä¸­çš„16ä½æ•°æ®æ®µæè¿°ç¬¦ 
	mov	ds, bp
	mov	es, bp
	mov	ss, bp
	mov	ebp, cr0
	and	ebp, 0xfffffffe
	mov	cr0, ebp ï¼›CR0.P=0 å…³é—­ä¿æŠ¤æ¨¡å¼
	jmp	0:real_entry ï¼›åˆ·æ–°CSå½±å­å¯„å­˜å™¨ï¼ŒçœŸæ­£è¿›å…¥å®æ¨¡å¼
real_entry:
	mov bp, cs
	mov ds, bp
	mov es, bp
	mov ss, bp ï¼›é‡æ–°è®¾ç½®å®æ¨¡å¼ä¸‹çš„æ®µå¯„å­˜å™¨ éƒ½æ˜¯CSä¸­å€¼ï¼Œå³ä¸º0 
	mov sp, 08000h ï¼›è®¾ç½®æ ˆ
	mov bp,func_table
	add bp,ax
	call [bp] ï¼›è°ƒç”¨å‡½æ•°è¡¨ä¸­çš„æ±‡ç¼–å‡½æ•°ï¼Œaxæ˜¯Cå‡½æ•°ä¸­ä¼ é€’è¿›æ¥çš„
	cli
	call disable_nmi
	mov	ebp, cr0
	or	ebp, 1
	mov	cr0, ebp ï¼›CR0.P=1 å¼€å¯ä¿æŠ¤æ¨¡å¼
	jmp dword 0x8 :_32bits_mode
[BITS 32]
_32bits_mode:
	mov bp, 0x10
	mov ds, bp
	mov ss, bpï¼›é‡æ–°è®¾ç½®ä¿æŠ¤æ¨¡å¼ä¸‹çš„æ®µå¯„å­˜å™¨0x10æ˜¯32ä½æ•°æ®æ®µæè¿°ç¬¦çš„ç´¢å¼•
	mov esi,[PM32_EIP_OFF]ï¼›åŠ è½½å…ˆå‰ä¿å­˜çš„EIP
	mov esp,[PM32_ESP_OFF]ï¼›åŠ è½½å…ˆå‰ä¿å­˜çš„ESP
	jmp esi ï¼›eip=esi å›åˆ°äº†realadr_call_entryå‡½æ•°ä¸­

func_table:  ;å‡½æ•°è¡¨
	dw _getmmap ï¼›è·å–å†…å­˜å¸ƒå±€è§†å›¾çš„å‡½æ•°
	dw _read ï¼›è¯»å–ç¡¬ç›˜çš„å‡½æ•°
    dw _getvbemode ï¼›è·å–æ˜¾å¡VBEæ¨¡å¼ 
    dw _getvbeonemodeinfo ï¼›è·å–æ˜¾å¡VBEæ¨¡å¼çš„æ•°æ®
    dw _setvbemode ï¼›è®¾ç½®æ˜¾å¡VBEæ¨¡å¼
</code></pre><p>ä¸Šé¢çš„ä»£ç æˆ‘ä»¬åªè¦å°†å®ƒç¼–è¯‘æˆ16ä½çš„äºŒè¿›åˆ¶çš„æ–‡ä»¶ï¼Œå¹¶æŠŠå®ƒæ”¾åœ¨0x1000å¼€å§‹çš„å†…å­˜ç©ºé—´ä¸­å°±å¯ä»¥äº†ã€‚è¿™æ ·åœ¨realadr_call_entryå‡½æ•°çš„æœ€åï¼Œå°±è¿è¡Œåˆ°è¿™æ®µä»£ç ä¸­æ¥äº†ã€‚</p><p>ä¸Šè¿°çš„ä»£ç çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼šé¦–å…ˆä» _16_mode:æ ‡å·å¤„è¿›å…¥å®æ¨¡å¼ï¼Œç„¶åæ ¹æ®ä¼ é€’è¿›æ¥ï¼ˆç”±axå¯„å­˜å™¨ä¼ å…¥ï¼‰çš„å‡½æ•°å·ï¼Œåˆ°å‡½æ•°è¡¨ä¸­è°ƒç”¨å¯¹åº”çš„å‡½æ•°ï¼Œé‡Œé¢çš„å‡½æ•°æ‰§è¡Œå®Œæˆåï¼Œå†æ¬¡è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼ŒåŠ è½½EIPå’ŒESPå¯„å­˜å™¨ä»è€Œå›åˆ°realadr_call_entryå‡½æ•°ä¸­ã€‚GDTè¿˜æ˜¯imghead.asmæ±‡ç¼–ä»£ç æ–‡ä»¶ä¸­çš„GDTï¼Œè¿™æ²¡æœ‰å˜ï¼Œå› ä¸ºå®ƒæ˜¯ç”±GDTRå¯„å­˜å™¨æŒ‡å‘çš„ã€‚</p><p>è¯´åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ ä¼šç«‹åˆ»æ˜ç™½ï¼Œä¹‹å‰write_realintsvefile()å‡½æ•°çš„åŠŸèƒ½ä¸æ„ä¹‰äº†ã€‚å®ƒä¼šæŠŠ<strong>æ˜ åƒæ–‡ä»¶ä¸­çš„initldrsve.binæ–‡ä»¶å†™å…¥åˆ°ç‰¹å®šçš„å†…å­˜åœ°å€ç©ºé—´ä¸­</strong>ï¼Œè€Œinitldrsve.binæ­£æ˜¯ç”±ä¸Šé¢çš„realintsve.asmæ–‡ä»¶ç¼–è¯‘è€Œæˆçš„ã€‚</p><h2>äºŒçº§å¼•å¯¼å™¨ä¸»å‡½æ•°</h2><p>å¥½ï¼Œç°åœ¨æˆ‘ä»¬å‡†å¤‡å¾—å·®ä¸å¤šäº†ï¼Œä»äºŒçº§å¼•å¯¼å™¨çš„ä¸»å‡½æ•°å¼€å§‹ï¼Œè¿™ä¸ªå‡½æ•°æˆ‘ä»¬è¦ç”¨Cæ¥å†™ï¼Œä¼°è®¡ä½ ä¹Ÿæ„Ÿå—åˆ°äº†å†™æ±‡ç¼–è¯­è¨€çš„å‹åŠ›ï¼Œæ‰€ä»¥ä¸èƒ½è€æ˜¯å†™æ±‡ç¼–ã€‚</p><p>æˆ‘ä»¬å…ˆå»ºç«‹ä¸€ä¸ªCæ–‡ä»¶ldrkrlentry.cï¼Œåœ¨å…¶ä¸­å†™ä¸Šä¸€ä¸ªä¸»å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹ã€‚</p><pre><code>void ldrkrl_entry()
{
    init_bstartparm();
    return;
}
</code></pre><p>ä¸Šè¿°ä»£ç ä¸­çš„ ldrkrl_entry()å‡½æ•°åœ¨initldr32.asmæ–‡ä»¶ï¼ˆé…å¥—ä»£ç åº“ä¸­å¯¹åº”ldrkrl32.asmï¼‰ä¸­è¢«è°ƒç”¨ï¼Œä»é‚£æ¡call ldrkrl_entry æŒ‡ä»¤å¼€å§‹è¿›å…¥äº†ldrkrl_entry()å‡½æ•°ï¼Œåœ¨å…¶ä¸­è°ƒç”¨äº†<strong>init_bstartparm()å‡½æ•°</strong>ï¼Œè¿™ä¸ªå‡½æ•°æˆ‘ä»¬è¿˜æ²¡æœ‰å®ç°ï¼Œä½†é€šè¿‡åå­—æˆ‘ä»¬ä¸éš¾æ¨æµ‹ï¼Œå®ƒæ˜¯è´Ÿè´£å¤„ç†å¼€å§‹å‚æ•°çš„ã€‚</p><p>ä½ è¿˜è®°ä¸è®°å¾—ï¼Œæˆ‘ä»¬å»ºé€ äºŒçº§å¼•å¯¼å™¨çš„ç›®çš„ï¼Œå°±æ˜¯è¦æ”¶é›†æœºå™¨ç¯å¢ƒä¿¡æ¯ã€‚æˆ‘ä»¬è¦æŠŠè¿™äº›ä¿¡æ¯å½¢æˆä¸€ä¸ªæœ‰ç»“æ„çš„å‚æ•°ï¼Œä¼ é€’ç»™æˆ‘ä»¬çš„æ“ä½œç³»ç»Ÿå†…æ ¸ä»¥å¤‡åç»­ä½¿ç”¨ã€‚</p><p>ç”±æ­¤ï¼Œæˆ‘ä»¬èƒ½å¤Ÿç¡®å®šï¼Œ<strong>init_bstartparm()å‡½æ•°æˆäº†æ”¶é›†æœºå™¨ç¯å¢ƒä¿¡æ¯çš„ä¸»å‡½æ•°</strong>ï¼Œä¸‹èŠ‚è¯¾æˆ‘ä»¬å°±ä¼šå»å®ç°å®ƒã€‚</p><h2>é‡ç‚¹å›é¡¾</h2><p>ä»Šå¤©æˆ‘ä»¬å¼€å§‹å®ç°äºŒçº§å¼•å¯¼å™¨äº†ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ²¡æœ‰å®Œå…¨å®ç°ï¼Œæˆ‘ä»¬ä¸‹ä¸€èŠ‚è¯¾å†æ¥ç€ç»§ç»­è¿™é¡¹å·¥ä½œã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹è¿™èŠ‚è¯¾çš„å†…å®¹ï¼Œå›é¡¾ä¸€ä¸‹æˆ‘ä»¬ä»Šå¤©çš„æˆæœã€‚</p><p>1.æˆ‘ä»¬è®¾è®¡äº†æœºå™¨ä¿¡æ¯ç»“æ„ï¼Œç”¨äºå­˜æ”¾åé¢äºŒçº§å¼•å¯¼å™¨æ”¶é›†åˆ°çš„æœºå™¨ä¿¡æ¯ã€‚<br>
2.å¯¹äºŒçº§å¼•å¯¼å™¨ä»£ç æ¨¡å—è¿›è¡Œäº†è§„åˆ’ï¼Œç¡®å®šå„æ¨¡å—çš„ä¸»è¦åŠŸèƒ½ã€‚<br>
3.å®ç°äº†GRUBè§„å®šçš„GRUBå¤´ï¼Œä»¥ä¾¿è¢«GRUBè¯†åˆ«ï¼Œåœ¨GRUBå¤´ä¸­åˆå§‹åŒ–äº†CPUå¯„å­˜å™¨ï¼Œå¹¶ä¸”è·³è½¬åˆ°ç‰©ç†å†…å­˜çš„0x200000åœ°å€å¤„ï¼ŒçœŸæ­£è¿›å…¥åˆ°äºŒçº§å¼•å¯¼å™¨ä¸­å¼€å§‹è¿è¡Œã€‚<br>
4.ä¸ºäº†äºŒçº§å¼•å¯¼å™¨èƒ½å¤Ÿè°ƒç”¨BIOSä¸­æ–­æœåŠ¡ç¨‹åºï¼Œæˆ‘ä»¬å®ç°äº†ä¸“é—¨ç”¨æ¥å®Œæˆè°ƒç”¨BIOSä¸­æ–­æœåŠ¡ç¨‹åºçš„realintsve.asmæ¨¡å—ã€‚<br>
5.æœ€åï¼Œæˆ‘ä»¬å®ç°äº†äºŒçº§å¼•å¯¼å™¨çš„ä¸»å‡½æ•°ï¼Œç”±å®ƒè°ƒç”¨å®Œæˆå…¶å®ƒåŠŸèƒ½çš„å‡½æ•°ã€‚</p><p>è¿™é‡Œæˆ‘è¿˜æƒ³èŠèŠï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¦èŠ±è¿™ä¹ˆå¤šåŠŸå¤«ï¼Œå»è®¾è®¡äºŒçº§å¼•å¯¼å™¨è¿™ä¸ªç»„ä»¶å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬æŠŠè¿™äº›å¤„ç†æ“ä½œç³»ç»Ÿè¿è¡Œç¯å¢ƒçš„å·¥ä½œç‹¬ç«‹å‡ºæ¥ï¼Œäº¤ç»™äºŒçº§å¼•å¯¼å™¨æ¥åšï¼Œè¿™ä¼š<strong>å¤§å¤§é™ä½åé¢å¼€å‘æ“ä½œç³»ç»Ÿçš„éš¾åº¦ï¼Œä¹Ÿèƒ½å¢åŠ æ“ä½œç³»ç»Ÿçš„é€šç”¨æ€§ã€‚</strong>è€Œä¸”ï¼Œé’ˆå¯¹ä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œæˆ‘ä»¬åªè¦å¼€å‘ä¸åŒçš„äºŒçº§å¼•å¯¼å™¨å°±å¥½äº†ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>è¯·é—®GRUBå¤´ä¸­ä¸ºä»€ä¹ˆéœ€è¦_entryæ ‡å·å’Œ_startæ ‡å·çš„åœ°å€ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè·Ÿæˆ‘äº¤æµæ´»åŠ¨ã€‚å¦‚æœä½ èº«è¾¹çš„åŒäº‹ã€æœ‹å‹ï¼Œå¯¹äºŒçº§å¼•å¯¼å™¨çš„å»ºç«‹æœ‰å…´è¶£ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä»–ã€‚</p><p>å¥½ï¼Œæˆ‘æ˜¯LMOSï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼</p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>neohope</span>
  </div>
  <div class="_2_QraFYR_0">å¤§ä½“ä¸Šæ•´ç†äº†ä¸€ä¸‹ï¼š<br><br>1ã€grubå¯åŠ¨åï¼Œé€‰æ‹©å¯¹åº”çš„å¯åŠ¨èœå•é¡¹ï¼Œgrubä¼šé€šè¿‡è‡ªå¸¦æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ï¼Œå®šä½åˆ°å¯¹åº”çš„ekiæ–‡ä»¶<br><br>2ã€grubä¼šå°è¯•åŠ è½½ekiæ–‡ä»¶ã€ekiæ–‡ä»¶éœ€è¦æ»¡è¶³grubå¤šåè®®å¼•å¯¼å¤´çš„æ ¼å¼è¦æ±‚ã€‘<br>è¿™äº›æ˜¯åœ¨imginithead.asmä¸­å®ç°çš„ï¼Œæ‰€ä»¥è¦åŒ…æ‹¬ï¼š<br>Aã€grubæ–‡ä»¶å¤´ï¼ŒåŒ…æ‹¬é­”æ•°ã€grub1å’Œgrub2æ”¯æŒç­‰<br>Bã€å®šä½çš„_startç¬¦å·ç­‰<br><br>3ã€grubæ ¡éªŒæˆåŠŸåï¼Œä¼šè°ƒç”¨_startï¼Œç„¶è·³è½¬åˆ°_entry<br>Aã€_entryä¸­:å…³é—­ä¸­æ–­<br>Bã€åŠ è½½GDT<br>Cã€ç„¶åè¿›å…¥_32bits_modeï¼Œæ¸…ç†å¯„å­˜å™¨ï¼Œè®¾ç½®æ ˆé¡¶<br>Dã€è°ƒç”¨inithead_entryã€Cã€‘<br><br>4ã€inithead_entry.c<br>Aã€ä»imginithead.asmè¿›å…¥åï¼Œé¦–å…ˆè¿›å…¥å‡½æ•°è°ƒç”¨inithead_entry<br>Bã€åˆå§‹åŒ–å…‰æ ‡ï¼Œæ¸…å±<br>Cã€ä»ekiæ–‡ä»¶å†…éƒ¨ï¼Œæ‰¾åˆ°initldrsve.binæ–‡ä»¶ï¼Œå¹¶åˆ†åˆ«æ‹·è´åˆ°å†…å­˜çš„æŒ‡å®šç‰©ç†åœ°å€<br>Dã€ä»ekiæ–‡ä»¶å†…éƒ¨ï¼Œæ‰¾åˆ°initldrkrl.binæ–‡ä»¶ï¼Œå¹¶åˆ†åˆ«æ‹·è´åˆ°å†…å­˜çš„æŒ‡å®šç‰©ç†åœ°å€<br>Eã€è¿”å›imginithead.asm<br><br>5ã€imginithead.asmä¸­ç»§ç»­æ‰§è¡Œ<br>jmp 0x200000<br>è€Œè¿™ä¸ªä½ç½®ï¼Œå°±æ˜¯initldrkrl.binåœ¨å†…å­˜çš„ä½ç½®ILDRKRL_PHYADR<br>æ‰€ä»¥åé¢è¦æ‰§è¡Œinitldrkrl.binçš„å†…å®¹<br><br>6ã€è¿™æ ·å°±åˆ°äº†ldrkrl32.asmçš„_entry<br>Aã€å°†GDTåŠ è½½åˆ°GDTRå¯„å­˜å™¨ã€å†…å­˜ã€‘<br>Bã€å°†IDTåŠ è½½åˆ°IDTRå¯„å­˜å™¨ã€ä¸­æ–­ã€‘<br>Cã€è·³è½¬åˆ°_32bits_mode<br>åˆå§‹å¯„å­˜å™¨<br>åˆå§‹åŒ–æ ˆ<br>è°ƒç”¨ldrkrl_entryã€Cã€‘<br><br>7ã€ldrkrlentry.c<br>Aã€åˆå§‹åŒ–å…‰æ ‡ï¼Œæ¸…å±<br>Bã€æ”¶é›†æœºå™¨å‚æ•°init_bstartparmã€Cã€‘<br><br>8ã€bstartparm.c<br>Aã€åˆå§‹åŒ–machbstart_t<br>Bã€å„ç±»åˆå§‹åŒ–å‡½æ•°ï¼Œå¡«å……machbstart_tçš„å†…å®¹<br>Cã€è¿”å›<br><br>9ã€ldrkrlentry.c<br>Aã€è¿”å›<br><br>10ã€ldrkrl32.asm<br>Aã€è·³è½¬åˆ°0x2000000åœ°å€ç»§ç»­æ‰§è¡Œ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å‰å®³äº†ï¼Œæ€»ç»“ çš„å¥½</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-06-02 14:13:57</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src=""
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>springXu</span>
  </div>
  <div class="_2_QraFYR_0">çœŸå®è¿›å…¥å®é™…å†™ä»£ç çš„è¯¾ç¨‹äº†ã€‚<br>å¯¹äºgrubçš„å¤´æ ¼å¼åœ¨çš„ç¬¬äºŒèŠ‚å†™ä¸ªHelloOS.binå°±å·²ç»æœ‰äº†ï¼Œè¿™æ¬¡å¤´æ ¼å¼è¿˜æ˜¯ä¼šæœ‰ã€‚ç†ç”±æ˜¯grubæ˜¯ä¸€çº§å¼•å¯¼å™¨ã€‚<br>è¿™èŠ‚è¯¾çš„å†…å®¹å°±æ˜¯å›´ç»•ç€ç”±ä¸€çº§è½¬åˆ°äºŒçº§å¼•å¯¼å™¨çš„è¿‡ç¨‹å±•å¼€äº†ã€‚<br>å…³äºäºŒçº§å¼•å¯¼å™¨çš„åŠ è½½è¿‡ç¨‹ï¼Œç®€å•ç‚¹è¯´å°±æ˜¯æŠŠæˆ‘ä»¬å†…æ ¸åŠ è½½åˆ°æŒ‡å®šå†…å­˜çš„ä½ç½®å¹¶æ‰§è¡Œï¼Œè¿™ä¸ªåŠ è½½å‡½æ•°æ ¸å¿ƒæ˜¯m2mcopyå‡½æ•°ï¼Œä¸œå“¥ç•™ç»™æˆ‘ä»¬è‡ªå·±åˆ†æäº†ï¼Œä½†ä¸œå“¥å¼ºè°ƒåˆ†æäº†ä¸‹ä¸ºä»€ä¹ˆä¼šæœ‰32ä½ä¸‹çš„ä»£ç å’Œ16ä½æ±‡ç¼–ä»£ç å…±å­˜çš„ç°è±¡ã€‚ å…¶å®æ˜¯ä¸ºäº†è®©BIOSæä¾›çš„è·å–ç¡¬ä»¶ä¿¡æ¯çš„æ“ä½œå‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯å®æ¨¡å¼ä¸‹çš„BIOSä¸­æ–­å·æ¥è·å–çš„ï¼‰åšæˆäº†cè¯­è¨€ç¯å¢ƒä¸‹ä¹Ÿå¯ä»¥è°ƒç”¨çš„åŠŸèƒ½ã€‚è¿™å°±åƒè·¨è¯­è¨€äº’ç›¸è°ƒç”¨çš„æŠ€æœ¯ã€‚æ±‡ç¼–è°ƒç”¨cè¯­è¨€çš„æ–¹æ³•ï¼Œåè¿‡æ¥cè¯­è¨€è°ƒç”¨æ±‡ç¼–æ–¹æ³•ã€‚ä½†æ›´ä¸ºå¤æ‚äº›ï¼ŒåŸå› æ˜¯ä¿æŠ¤æ¨¡å¼åˆ°å®æ¨¡å¼å†å›åˆ°ä¿æŠ¤æ¨¡å¼çš„åˆ‡æ¢è¿‡ç¨‹ã€‚å†…æ ¸å¯ä»¥è·å–ç¡¬ä»¶ä¿¡æ¯å°±å¯ä»¥æ ¹æ®ç¡¬ä»¶ç¯å¢ƒå‚æ•°ï¼Œé…ç½®è‡ªèº«å‚æ•°å¼€å§‹å·¥ä½œäº†ã€‚å¦‚ä½•é…ç½®å‚æ•°ï¼Œé‚£åˆæ˜¯ä¸‹èŠ‚ç»§ç»­æ’­è®²ã€‚å‘¨äº”è§ã€‚<br>å…³äºæ€è€ƒé¢˜ï¼Œè¿™ä¸ªæ˜¯grubä¹Ÿæ˜¯è¦æŠŠæ§åˆ¶æƒäº¤ç»™æˆ‘ä»¬äºŒçº§å¼•å¯¼å™¨çš„å…¥å£åœ°å€ã€‚ è‡³äºä¸ºä»€ä¹ˆä¸å…‰æœ‰ä¸€ä¸ª_startå°±å¯ä»¥äº†ï¼Œæˆ‘çŒœæµ‹æ˜¯ä¸ºäº†åšéªŒè¯å§ã€‚_startçš„æ“ä½œæ˜¯jmp åœ°å€ã€‚è¿™ä¸ªåœ°å€æ­£å¥½æ˜¯_entryã€‚æœ‰é”™è¯¯è¿˜è¯·ä¸œå“¥æŒ‡æ­£ã€‚å“ˆå“ˆ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ­£ç¡®çš„ </p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-06-02 06:03:12</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/8d/c6/e648d118.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>å—£æ ‘</span>
  </div>
  <div class="_2_QraFYR_0">å›ç­”ä¸€ä¸‹é—®é¢˜ï¼ŒGRUB å¤´ä¸­ä¸ºä»€ä¹ˆéœ€è¦ _entry æ ‡å·å’Œ _start æ ‡å·çš„åœ°å€ï¼Ÿ<br><br>æˆ‘ä»¬å®šä¹‰çš„ flags å€¼ä¸ºï¼š<br>MBT_HDR_FLAGS EQU 0x00010003<br><br>æ ¹æ® Multiboot Specification å®šä¹‰çš„å¤´ç»“æ„<br>Offset	Type	Field Name		Note<br>0		u32		magic			required<br>4		u32		flags			required<br>8		u32		checksum		required<br>12		u32		header_addr		if flags[16] is set<br>16		u32		load_addr		        if flags[16] is set<br>20		u32		load_end_addr	        if flags[16] is set<br>24		u32		bss_end_addr	        if flags[16] is set<br>28		u32		entry_addr		if flags[16] is set<br>32		u32		mode_type		if flags[2] is set<br>36		u32		width			if flags[2] is set<br>40		u32		height			if flags[2] is set<br>44		u32		depth			if flags[2] is set<br><br>flags[16] è§£é‡Šå¦‚ä¸‹ï¼š<br>If bit 16 in the â€˜flagsâ€™ word is set, then the fields at offsets 12-28 in the Multiboot header are valid, and the boot loader should use them instead of the fields in the actual executable header to calculate where to load the OS image. This information does not need to be provided if the kernel image is in ELF format, but it must be provided if the images is in a.out format or in some other format. Compliant boot loaders must be able to load images that either are in ELF format or contain the load address information embedded in the Multiboot header; they may also directly support other executable formats, such as particular a.out variants, but are not required to.<br><br>ä¹Ÿå°±æ˜¯å¦‚æœæˆ‘ä»¬ç”¨çš„æ˜¯æ ‡å‡†çš„ ELF æ–‡ä»¶å°±ä¸éœ€è¦æä¾›é¢å¤–çš„åœ°å€ä¿¡æ¯ï¼Œè€Œæˆ‘ä»¬ç”¨çš„æ˜¯è‡ªå·±å®šä¹‰çš„æ ¼å¼å°±éœ€è¦äººå®¶ä»å“ªé‡ŒåŠ è½½å“ªé‡Œè¿è¡Œï¼Œæ‰€ä»¥éœ€è¦å°† bit 16 ä½¿èƒ½ï¼Œå¡«å……ç›¸åº”çš„å­—æ®µã€‚<br><br>å†è§£é‡Šä¸‹ä¸¤ä¸ªå­—æ®µçš„å«ä¹‰ï¼š<br>load_addr<br>Contains the physical address of the beginning of the text segment. The offset in the OS image file at which to start loading is defined by the offset at which the header was found, minus (header_addr - load_addr). load_addr must be less than or equal to header_addr.<br><br>entry_addr<br>The physical address to which the boot loader should jump in order to start running the operating system.</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å—¯å—¯ æ˜¯çš„ </p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-06-03 17:50:17</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>pedro</span>
  </div>
  <div class="_2_QraFYR_0">æ—©èµ·çœ‹ä¸“æ ï¼<br>å…ˆå›ç­”æ€è€ƒé¢˜ï¼Œgrubæ˜¯multibootè§„èŒƒï¼Œå› æ­¤å¼•å¯¼å™¨å¤´éƒ¨æ•°æ®å¿…é¡»å¾—æ»¡è¶³ä¸€å®šçš„è§„åˆ™æ‰èƒ½è¢«grubæ‰€åŠ è½½ï¼Œæœ¬æ–‡ä¸­çš„MBT_HDR_FLAGSä¸º0x001003ï¼Œç¬¬16ä½è¢«ç½®ä¸º1ï¼Œå› æ­¤load_addrå’Œentry_addréƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œè€Œå®ƒä»¬æ­£å¥½åˆ†åˆ«å¯¹åº”_startå’Œ_entryã€‚<br>å…¶ä¸­load_addræ˜¯å¼•å¯¼å™¨äºŒè¿›åˆ¶æ–‡ä»¶textæ®µçš„èµ·å§‹åœ°å€ï¼Œå³_startï¼Œgrubè§£æå¤´éƒ¨æ•°æ®åï¼Œæ‹¿åˆ°_startåœ°å€ï¼Œå¹¶ä»è¯¥åœ°å€å¤„å¼€å§‹æ‰§è¡ŒäºŒçº§å¼•å¯¼å™¨ä»£ç ã€‚<br>è€Œentry_addrå¯¹åº”çš„æ˜¯æ“ä½œç³»ç»Ÿçš„å…¥å£ç‚¹ï¼Œä¹Ÿå°±æ˜¯_entryã€‚å¼•å¯¼ç¨‹åºæœ€åå°†è·³è½¬åˆ°è¿™é‡Œï¼Œä¸è¿‡æœ¬æ–‡çš„å®ç°å¹¶æ²¡æœ‰å®Œå…¨æŒ‰ç…§è¿™ç§æ€è·¯æ¥ï¼Œ_startç›´æ¥è·³åˆ°_entryï¼Œç„¶åç”±_entryè´Ÿè´£äºŒçº§å¼•å¯¼å·¥ä½œã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å¯¹å•Š <br>å“ˆå“ˆ é“æ±å¥½</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-06-02 07:25:32</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/1a/cf/c5/8691f309.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Amerny</span>
  </div>
  <div class="_2_QraFYR_0">æ„Ÿè§‰ä»£ç ä¹Ÿçœ‹ä¸æ‡‚ï¼Œç¨€é‡Œç³Šæ¶‚çš„ï¼Œæ˜¯ä¸æ˜¯å¾—éœ€è¦æŠŠä»£ç çœ‹æ‡‚äº†æ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥å‘€ï¼Œè„‘å­ä¸å¤Ÿç”¨äº†</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: éœ€è¦å¤šçœ‹å‡ é</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-09-18 02:14:55</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/29/00/eb/5cec6300.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æ™¶</span>
  </div>
  <div class="_2_QraFYR_0">å¯¹åº”grub2çš„ä»£ç å®šä¹‰ç»“æ„ï¼š<br>struct multiboot_header<br>{<br>  multiboot_uint32_t magic; &#47;&#47; é­”æ•° 0xE85250D6	  <br>  multiboot_uint32_t architecture; &#47;&#47; æ¶æ„ 0è¡¨ç¤ºx86<br>  multiboot_uint32_t header_length; &#47;&#47; è¡¨ç¤ºmb header é•¿åº¦<br>  multiboot_uint32_t checksum; &#47;&#47; æ ¡éªŒå’Œ<br>};<br><br>åœ¨ ä¹‹åæ˜¯multiboot_header_tagï¼Œ<br>struct multiboot_header_tag_address<br>{<br>    multiboot_uint16_t type;    &#47;&#47; 2 è¡¨ç¤º  multiboot_header_tag_address<br>    multiboot_uint16_t flags;   &#47;&#47; 0 <br>    multiboot_uint32_t size;    &#47;&#47; 24<br>    multiboot_uint32_t header_addr;  &#47;&#47; mbhdr<br>    multiboot_uint32_t load_addr;    &#47;&#47; _start<br>    multiboot_uint32_t load_end_addr; &#47;&#47; 0 è¡¨ç¤ºæ•°æ®æ®µ å’Œ ä»£ç æ®µä¸€æ · å ç”¨æ•´ä¸ªç©ºé—´<br>    multiboot_uint32_t bss_end_addr;  &#47;&#47; 0 <br>};<br><br>å†ä¹‹åæ˜¯ multiboot_header_tag_entry_address<br>struct multiboot_header_tag_entry_address<br>{<br>  multiboot_uint16_t type;  &#47;&#47; type = 3 è¡¨ç¤º multiboot_header_tag_entry_address<br>  multiboot_uint16_t flags; <br>  multiboot_uint32_t size;<br>  multiboot_uint32_t entry_addr;<br>};<br><br>mbhdr:<br>    DD  0xE85250D6	  magic<br>    DD  0  architecture<br>    DD  mhdrend - mbhdr    header_length<br>    DD  -(0xE85250D6 + 0 + (mhdrend - mbhdr))     checksum<br>   <br>  ï¼›multiboot_header_tag<br>    DW  2, 0    ; type = 2 ;flag  = 0;<br>    DD  24      ; size =24<br>    DD  mbhdr<br>    DD  _start<br>    DD  0<br>    DD  0<br><br>  ;multiboot_header_tag_entry_address<br>    DW  3, 0    ;;type = 3 flag = 0<br>    DD  12<br>    DD  _entry  ; entry_addr = _entry  <br>    <br>  ;<br>    DD      0  <br>    DW  0, 0<br>    DD  8</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ˜¯çš„ </p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-24 10:32:46</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/27/f1/24/07ce02a0.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ç†Šå…‰çº¢</span>
  </div>
  <div class="_2_QraFYR_0">è¯·é—®è€å¸ˆï¼Œå¦‚ä½•è°ƒè¯•å†…æ ¸ï¼Ÿæ€ä¹ˆæ­å»ºè°ƒè¯•ç¯å¢ƒ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: printf èµ°å¤©ä¸‹ </p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-06-03 08:13:24</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/72/c1/59509397.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>æ²ˆç•…</span>
  </div>
  <div class="_2_QraFYR_0">å¦‚æœæˆ‘ä»¬ä¸ç”¨grubä½œä¸ºå¼•å¯¼ç¨‹åºï¼Œè‡ªå·±å†™ä¸€ä¸ªå¼•å¯¼ç¨‹åºï¼Œåœ¨å®æ¨¡å¼ä¸‹ï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥ç›´æ¥è°ƒç”¨boisä¸­æ–­æ”¶é›†ç¡¬ä»¶ä¿¡æ¯ï¼Œè€Œä¸éœ€è¦åé¢åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹åˆ‡æ¢å›å®æ¨¡å¼ï¼Œå†æ”¶é›†ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ˜¯çš„ æ˜¯çš„ </p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-15 22:40:05</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/28/3e/8a/204165cc.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ğŸ‹ ğŸ‹ ğŸ‹</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆ lmoskrlimgï¼šæœªæ‰¾åˆ°å‘½ä»¤   æ˜¯ä¸ºä»€ä¹ˆå‘€</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ²¡åˆ°æ—¶å€™  ç»§ç»­å¾€åçœ‹ </p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-07-27 11:31:11</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/dXf9e0gmVVV1ozqBIiaWiaxz1qgPZrYHT9x3ytnjfZ6quCH7gNtibXhsg66kH1E4FeTVHMB9J3PibNaMN2GthvceqA/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_032c4a</span>
  </div>
  <div class="_2_QraFYR_0">è¯·é—®ä¸‹lmoskrlimgæºä»£ç æ˜¯å“ªä¸ªï¼Œæˆ‘æœäº†ä¸€åœˆæ²¡çœ‹åˆ°å·¥å…·çš„æºä»£ç ï¼Œæ˜¯åªç»™äº†ä¸ªäºŒè¿›åˆ¶å—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ä»£ç ä»“åº“ä¸­æœ‰çš„ pullä¸€ä¸‹</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-06-17 14:18:57</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/10/3e/e7/261711a5.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>blentle</span>
  </div>
  <div class="_2_QraFYR_0">è¶Šæ¥è¶Šæœ‰æ„æ€äº†</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: åé¢è¿˜æœ‰å‘¢</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-06-02 08:50:25</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/31/40/cf/a08ccf59.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>YOLO</span>
  </div>
  <div class="_2_QraFYR_0">&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `lmoskrlimg.o&#39; is incompatible with i386 output<br>&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `imgcore.o&#39; is incompatible with i386 output<br>&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `imgmgrhead.o&#39; is incompatible with i386 output<br>&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `param.o&#39; is incompatible with i386 output<br>&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `file.o&#39; is incompatible with i386 output<br>&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `imgundo.o&#39; is incompatible with i386 output<br>&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `memdisk.o&#39; is incompatible with i386 output<br>&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `mem.o&#39; is incompatible with i386 output<br>&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `limgerror.o&#39; is incompatible with i386 output<br>ç¼–è¯‘è€å¸ˆçš„lmoskrlimgå·¥å…·åŒ…æ—¶æŠ¥çš„è¿™ä¸ªé”™ï¼ŒæŸ¥äº†åæ˜¯å› ä¸ºæˆ‘çš„ç³»ç»Ÿ64ä½ï¼Œè€å¸ˆä»£ç åº“æ˜¯32ä½ï¼Œæˆ‘åœ¨krnllink.mkæ–‡ä»¶CCååŠ äº† -m32ä½†æ²¡ç”¨ï¼Œè¯·é—®è€å¸ˆåº”è¯¥åœ¨å“ªé‡Œåšä¿®æ”¹æ‰èƒ½ç¼–è¯‘æˆåŠŸå‘¢</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-01-16 17:31:31</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/18/21/c5/024e1ef1.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>X</span>
  </div>
  <div class="_2_QraFYR_0">make è€å¸ˆç»™çš„å·¥å…·çš„æ—¶å€™å„ç§é—®é¢˜å•Šã€‚<br><br>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š<br>&#47;usr&#47;include&#47;features.h:367:25: fatal error: sys&#47;cdefs.h: No such file or directory<br>è§£å†³æ–¹æ³•ï¼š<br>ç¬¬ä¸€æ­¥ï¼šsudo apt-get â€“fix-broken installï¼›<br>ç¬¬äºŒæ­¥ï¼šsudo apt-get install libc6-dev-i386ï¼›<br><br>é—®é¢˜å‡ºç°åŸå› æ˜¯è€å¸ˆè¿™ä¸ªå·¥å…·ä¾èµ–çš„åº“æ–‡ä»¶æ˜¯32ä½åº“ï¼Œè‡ªå·±çš„è™šæ‹Ÿæœºæ˜¯64ä½åº“ã€‚<br><br>ç¬¬äºŒä¸ªé—®é¢˜ï¼š<br>&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `lmoskrlimg.o&#39; is incompatible with i386 output<br>&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `imgcore.o&#39; is incompatible with i386 output<br>&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `imgmgrhead.o&#39; is incompatible with i386 output<br>&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `param.o&#39; is incompatible with i386 output<br>&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `file.o&#39; is incompatible with i386 output<br>&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `imgundo.o&#39; is incompatible with i386 output<br>&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `memdisk.o&#39; is incompatible with i386 output<br>&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `mem.o&#39; is incompatible with i386 output<br>&#47;usr&#47;bin&#47;ld: i386:x86-64 architecture of input file `limgerror.o&#39; is incompatible with i386 output<br>è€å¸ˆå·¥å…·ç¼–è¯‘ä¹‹åè¾“å‡ºçš„ç¼–è¯‘æ–‡ä»¶ *.o æ˜¯32ä½çš„ï¼Œå¯æ˜¯æˆ‘è‡ªå·±è™šæ‹Ÿæœºæ˜¯64ä½çš„æ¶æ„ï¼Œldè¿æ¥å™¨è¿æ¥ä¸ä¸Šã€‚<br>æœ‰ç‚¹æ— è¯­ï¼Œä¸€é€šç™¾åº¦æ˜¯gccçš„æ—¶å€™è¦åŠ ä¸Š -m32ï¼Œå¯æ˜¯æ‰¾ä¸åˆ°è€å¸ˆæ˜¯åœ¨å“ªé‡Œgccçš„â€¦â€¦<br><br><br></div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ä½ è¦ç¼–è¯‘lmoskrlimg å·¥å…·</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-07-28 15:08:16</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/26/70/c3/cc46c55a.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>MONKEYG</span>
  </div>
  <div class="_2_QraFYR_0">sudo .&#47;lmoskrlimg -m k -lhf initldrimh.bin -o Cosmos.eki -f initldrkrl.bin initldrsve.bin<br>.&#47;lmoskrlimg: 1: .&#47;lmoskrlimg: ELF: not found<br>.&#47;lmoskrlimg: 1: .&#47;lmoskrlimg: Jï¿½: not found<br>.&#47;lmoskrlimg: 2: .&#47;lmoskrlimg: ï¿½Jï¿½Q: not found<br>.&#47;lmoskrlimg: 1: .&#47;lmoskrlimg: Syntax error: word unexpected (expecting &quot;)&quot;)<br><br>è€å¸ˆèƒ½å¸®å¿™çœ‹çœ‹ä¹ˆï¼Œä¸æ¸…æ¥šä¸ºä»€ä¹ˆä¼šæŠ¥è¿™ä¸ªæ–‡ä»¶æ‰¾ä¸åˆ°</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ç¼–è¾‘å›å¤: é—®è¿‡è€å¸ˆäº†ï¼Œä½ è¿™ä¸ªæ²¡æœ‰lmoskrlimgè½¯ä»¶ï¼Œè¯·Giteeæ‹‰å–æœ€æ–°ä»£ç ï¼Œä»£ç ä»“åº“é‡Œæœ‰æºä»£ç ã€‚è¿™ä¸ªæ˜¯ä¸œå“¥è‡ªå·±å†™çš„ç”Ÿæˆcosmos.efiçš„å·¥å…·ã€‚</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-04-11 22:04:42</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src=""
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_e42826</span>
  </div>
  <div class="_2_QraFYR_0">make æŠ¥é”™æŒ‡å—<br>1, éœ€è¦å…ˆå®‰è£…nasmã€‚sudo apt install nasm <br>```c<br>hello@hello-VirtualBox:~&#47;01OS&#47;01HelloOS&#47;cosmos&#47;lesson10~11&#47;Cosmos$ make all <br>æ¸…ç†å…¨éƒ¨å·²æ„å»ºæ–‡ä»¶... ^_^<br>*********æ­£åœ¨å¼€å§‹ç¼–è¯‘æ„å»ºç³»ç»Ÿ*************<br>make[3]: nasm: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•<br>make[3]: *** [krnlbuidrule.mh:10ï¼šimginithead.o] é”™è¯¯ 127<br>make[2]: *** [Makefile:27ï¼šall] é”™è¯¯ 2<br>make[1]: *** [Makefile.x86:22ï¼šall] é”™è¯¯ 2<br>make: *** [Makefile:58ï¼šall] é”™è¯¯ 2<br>```<br>2ï¼Œéœ€è¦å®‰è£…gccã€‚sudo apt install gcc<br>```c<br>hello@hello-VirtualBox:~&#47;01OS&#47;01HelloOS&#47;cosmos&#47;lesson10~11&#47;Cosmos$ make all <br>æ¸…ç†å…¨éƒ¨å·²æ„å»ºæ–‡ä»¶... ^_^<br>*********æ­£åœ¨å¼€å§‹ç¼–è¯‘æ„å»ºç³»ç»Ÿ*************<br>AS -[M] æ­£åœ¨æ„å»º... ..&#47;ldrkrl&#47;imginithead.asm<br>make[3]: gcc: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•<br>make[3]: *** [krnlbuidrule.mh:13ï¼šinithead.o] é”™è¯¯ 127<br>make[2]: *** [Makefile:27ï¼šall] é”™è¯¯ 2<br>make[1]: *** [Makefile.x86:22ï¼šall] é”™è¯¯ 2<br>make: *** [Makefile:58ï¼šall] é”™è¯¯ 2<br>```<br><br>3ã€makeæˆåŠŸæ˜¾ç¤ºå¦‚ä¸‹<br>```c<br>hello@hello-VirtualBox:~&#47;01OS&#47;01HelloOS&#47;cosmos&#47;lesson10~11&#47;Cosmos$ make all <br>æ¸…ç†å…¨éƒ¨å·²æ„å»ºæ–‡ä»¶... ^_^<br>*********æ­£åœ¨å¼€å§‹ç¼–è¯‘æ„å»ºç³»ç»Ÿ*************<br>AS -[M] æ­£åœ¨æ„å»º... ..&#47;ldrkrl&#47;imginithead.asm<br>CC -[M] æ­£åœ¨æ„å»º... ..&#47;ldrkrl&#47;inithead.c<br>CC -[M] æ­£åœ¨æ„å»º... ..&#47;ldrkrl&#47;vgastr.c<br>AS -[M] æ­£åœ¨æ„å»º... ..&#47;ldrkrl&#47;ldrkrl32.asm<br>CC -[M] æ­£åœ¨æ„å»º... ..&#47;ldrkrl&#47;ldrkrlentry.c<br>CC -[M] æ­£åœ¨æ„å»º... ..&#47;ldrkrl&#47;fs.c<br>CC -[M] æ­£åœ¨æ„å»º... ..&#47;ldrkrl&#47;chkcpmm.c<br>CC -[M] æ­£åœ¨æ„å»º... ..&#47;ldrkrl&#47;graph.c<br>CC -[M] æ­£åœ¨æ„å»º... ..&#47;ldrkrl&#47;bstartparm.c<br>AS -[M] æ­£åœ¨æ„å»º... ..&#47;ldrkrl&#47;realintsve.asm<br>OBJCOPY -[M] æ­£åœ¨æ„å»º... initldrimh.bin<br>OBJCOPY -[M] æ­£åœ¨æ„å»º... initldrkrl.bin<br>OBJCOPY -[M] æ­£åœ¨æ„å»º... initldrsve.bin<br>æ–‡ä»¶æ•°ï¼š2<br>æ˜ åƒæ–‡ä»¶å¤§å°ï¼š20480<br>æ­å–œæˆ‘ï¼Œç³»ç»Ÿç¼–è¯‘æ„å»ºå®Œæˆï¼ ^_^<br>æ­å–œæˆ‘ï¼Œç³»ç»Ÿç¼–è¯‘æ„å»ºå®Œæˆï¼ ^_^<br>æ­å–œæˆ‘ï¼Œç³»ç»Ÿç¼–è¯‘æ„å»ºå®Œæˆï¼ ^_^<br>hello@hello-VirtualBox:~&#47;01OS&#47;01HelloOS&#47;cosmos&#47;less<br>```<br></div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ­å–œ</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-12-07 23:29:48</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/1f/9e/ba/4b60c587.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Jayying</span>
  </div>
  <div class="_2_QraFYR_0">ä¸å¤§ä¼šæ±‡ç¼–è¯­è¨€ï¼Œæ„Ÿè§‰çœ‹æ±‡ç¼–è¿˜æœ‰äº›éš¾åº¦</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ç¼–è¾‘å›å¤: åˆ°åä¸‰èŠ‚è¯¾ä»¥åä¸»è¦å°±æ˜¯Cå•¦ï¼ŒåŠ æ²¹ï½</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-07-31 15:02:13</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/dXf9e0gmVVV1ozqBIiaWiaxz1qgPZrYHT9x3ytnjfZ6quCH7gNtibXhsg66kH1E4FeTVHMB9J3PibNaMN2GthvceqA/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_032c4a</span>
  </div>
  <div class="_2_QraFYR_0">imginithead.asmè¿™ä¸ªæ–‡ä»¶çš„ç¨‹åºåº”è¯¥è¿è¡Œåœ¨å®æ¨¡å¼ä¸‹çš„ã€‚<br>1ï¼Œä¸ºå•¥åœ¨è¿˜æ²¡æœ‰è¿›å…¥ä¿æŠ¤æ¨¡å¼çš„æ—¶å€™å°±å¯ä»¥æ“ä½œespã€eaxã€ebxè¿™ç§å¯„å­˜å™¨ï¼Ÿ<br>2ï¼Œå®æ¨¡å¼ä¸‹å¯ä»¥ç›´æ¥è°ƒç”¨äº†inithead_entryè¿™ç§Cè¯­è¨€å‡½æ•°ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: GRUBåŠ è½½æ—¶å°±æ˜¯ä¿æŠ¤æ¨¡å¼ äº† </p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-06-18 16:31:09</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/13/02/5b/ce326cfc.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>äºŒä¸‰å­ä¹Ÿ</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆæœ‰ä¸ªé—®é¢˜ï¼š0x200000ã€‚åœ¨x86-64å¹³å°ä¸‹ï¼Œè¿™ä¸ªå€¼æ˜¯grubé»˜è®¤å°†multiboot2å®šä¹‰çš„æ–‡ä»¶åŠ è½½åˆ°çš„ä½ç½®å—ï¼Ÿå¦‚æœæ˜¯çš„è¯ï¼Œè¿™ä¸ªå€¼æ˜¯æ‰‹å†Œæä¾›çš„ï¼Ÿè¿˜æ˜¯è°ƒè¯•å‡ºæ¥çš„ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ˜¯æˆ‘æŒ‡å®šçš„ åœ¨å¼•å¯¼å¤´ä¸­ </p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-06-02 18:08:02</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="http://thirdwx.qlogo.cn/mmopen/vi_32/J3dqALgicfVklewMjVkpyLbTk9YiamnBf5QQZ3NPHGlMeVSdLDB5yHLicEZHKBbUets76KOFwbl9ju0xJw1VeGa1A/132"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>é£ç¿”</span>
  </div>
  <div class="_2_QraFYR_0">lmoskrlimgè¿™ä¸ªå·¥å…·ä»å“ªé‡Œæ‰¾ï¼Œåœ¨centosä¸Šæ²¡æœ‰æ‰¾åˆ°ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æˆ‘åœ¨ä»£ç ç›®å½•ä¸­æä¾›äº†</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-06-02 15:02:38</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/28/a2/6e/340fcbb9.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Ticks</span>
  </div>
  <div class="_2_QraFYR_0">éš¾å´©ï¼Œæ“ä½œç³»ç»Ÿä»£ç æ¶‰å«Œè¿è§„ï¼Œè¿™GiteeçœŸå¥½ç©ã€‚</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2023-04-02 21:51:47</div>
  </div>
</div>
</div>
</li>
</ul>