<audio title="40_ç§ä¸€ç§Linuxï¼šè¯¦è§£socketçš„æ¥å£å®ç°" src="https://static001.geekbang.org/resource/audio/6e/8f/6e5ccedyy9e554980901876fc35a278f.mp3" controls="controls"></audio> 
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯LMOSã€‚</p><p>ä¸ŠèŠ‚è¯¾ï¼Œæˆ‘ä»¬ä¸€èµ·äº†è§£äº†å¥—æ¥å­—çš„å·¥ä½œæœºåˆ¶å’Œæ•°æ®ç»“æ„ï¼Œä½†å¥—æ¥å­—æœ‰å“ªäº›åŸºæœ¬æ¥å£å®ç°å‘¢ï¼Ÿç›¸ä¿¡å­¦å®Œè¿™èŠ‚è¯¾ï¼Œä½ å°±èƒ½å¤Ÿè§£å†³è¿™ä¸ªé—®é¢˜äº†ã€‚</p><p>ä»Šå¤©æˆ‘ä¼šå’Œä½ æ¢è®¨å¥—æ¥å­—ä»åˆ›å»ºã€åè®®æ¥å£æ³¨å†Œä¸åˆå§‹åŒ–è¿‡ç¨‹ï¼Œè¿˜ä¼šä¸ºä½ æ·±å…¥åˆ†æå¥—æ¥å­—ç³»ç»Ÿï¼Œæ˜¯æ€æ ·è°ƒç”¨å„ä¸ªåŠŸèƒ½å‡½æ•°çš„ã€‚é€šè¿‡è¿™èŠ‚è¯¾ï¼Œç›¸ä¿¡ä½ å¯ä»¥å­¦ä¼šåŸºäºå¥—æ¥å­—æ¥ç¼–å†™ç½‘ç»œåº”ç”¨ç¨‹åºã€‚æœ‰äº†ä¹‹å‰çš„åŸºç¡€ï¼Œæƒ³ç†è§£è¿™èŠ‚è¯¾å¹¶ä¸éš¾ï¼Œè®©æˆ‘ä»¬æ­£å¼å¼€å§‹å§ã€‚</p><h2>å¥—æ¥å­—æ¥å£</h2><p>å¥—æ¥å­—æ¥å£æœ€åˆæ˜¯BSDæ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œåœ¨åº”ç”¨å±‚ä¸TCP/IPåè®®æ ˆä¹‹é—´æ¥ä¾›äº†ä¸€å¥—æ ‡å‡†çš„ç‹¬ç«‹äºåè®®çš„æ¥å£ã€‚</p><p>Linuxå†…æ ¸å®ç°çš„å¥—æ¥å­—æ¥å£ï¼Œå°†UNIXçš„â€œä¸€åˆ‡éƒ½æ˜¯æ–‡ä»¶æ“ä½œâ€çš„æ¦‚å¿µåº”ç”¨åœ¨äº†ç½‘ç»œè¿æ¥è®¿é—®ä¸Šï¼Œè®©åº”ç”¨ç¨‹åºå¯ä»¥ç”¨å¸¸è§„æ–‡ä»¶æ“ä½œAPIè®¿é—®ç½‘ç»œè¿æ¥ã€‚</p><p>ä»TCP/IPåè®®æ ˆçš„è§’åº¦æ¥çœ‹ï¼Œä¼ è¾“å±‚ä»¥ä¸Šçš„éƒ½æ˜¯åº”ç”¨ç¨‹åºçš„ä¸€éƒ¨åˆ†ï¼ŒLinuxä¸ä¼ ç»Ÿçš„UNIXç±»ä¼¼ï¼ŒTCP/IPåè®®æ ˆé©»ç•™åœ¨å†…æ ¸ä¸­ï¼Œä¸å†…æ ¸çš„å…¶ä»–ç»„ä»¶å…±äº«å†…å­˜ã€‚ä¼ è¾“å±‚ä»¥ä¸Šæ‰§è¡Œçš„ç½‘ç»œåŠŸèƒ½ï¼Œéƒ½æ˜¯åœ¨ç”¨æˆ·åœ°å€ç©ºé—´å®Œæˆçš„ã€‚</p><p>Linuxä½¿ç”¨å†…æ ¸å¥—æ¥å­—æ¦‚å¿µä¸ç”¨æˆ·ç©ºé—´å¥—æ¥å­—é€šä¿¡ï¼Œè¿™æ ·å¯ä»¥è®©å®ç°å’Œæ“ä½œå˜å¾—æ›´ç®€å•ã€‚Linuxæä¾›äº†ä¸€å¥—APIå’Œå¥—æ¥å­—æ•°æ®ç»“æ„ï¼Œè¿™äº›æœåŠ¡å‘ä¸‹ä¸å†…æ ¸æ¥å£ï¼Œå‘ä¸Šä¸ç”¨æˆ·ç©ºé—´æ¥å£ï¼Œåº”ç”¨ç¨‹åºæ­£æ˜¯ä½¿ç”¨è¿™ä¸€å¥—APIè®¿é—®å†…æ ¸ä¸­çš„ç½‘ç»œåŠŸèƒ½ã€‚</p><!-- [[[read_end]]] --><h3>å¥—æ¥å­—çš„åˆ›å»º</h3><p>åœ¨åº”ç”¨ç¨‹åºä½¿ç”¨TCP/IPåè®®æ ˆçš„åŠŸèƒ½ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»è°ƒç”¨å¥—æ¥å­—åº“å‡½æ•°APIåˆ›å»ºä¸€ä¸ªæ–°çš„å¥—æ¥å­—ï¼Œåˆ›å»ºå¥½ä»¥åï¼Œå¯¹åº“å‡½æ•°åˆ›å»ºå¥—æ¥å­—çš„è°ƒç”¨ï¼Œå°±ä¼šè½¬æ¢ä¸ºå†…æ ¸å¥—æ¥å­—åˆ›å»ºå‡½æ•°çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p><p>è¿™æ—¶ï¼Œå®Œæˆçš„æ˜¯é€šç”¨å¥—æ¥å­—åˆ›å»ºçš„åˆå§‹åŒ–åŠŸèƒ½ï¼Œè·Ÿå…·ä½“çš„åè®®æ—å¹¶ä¸ç›¸å…³ã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹å…·ä½“æ˜¯è¿™æ ·çš„ï¼Œåœ¨åº”ç”¨ç¨‹åºä¸­æ‰§è¡Œsocketå‡½æ•°ï¼Œsocketäº§ç”Ÿç³»ç»Ÿè°ƒç”¨ä¸­æ–­æ‰§è¡Œå†…æ ¸çš„å¥—æ¥å­—åˆ†è·¯å‡½æ•°sys_socketcallï¼Œåœ¨sys_socketcallå¥—æ¥å­—å‡½æ•°åˆ†è·¯å™¨ä¸­å°†è°ƒç”¨ä¼ é€åˆ°sys_socketå‡½æ•°ï¼Œç”±sys_socketå‡½æ•°è°ƒç”¨å¥—æ¥å­—çš„é€šç”¨åˆ›å»ºå‡½æ•°sock_createã€‚</p><p>sock_createå‡½æ•°å®Œæˆé€šç”¨å¥—æ¥å­—åˆ›å»ºã€åˆå§‹åŒ–ä»»åŠ¡åï¼Œå†è°ƒç”¨ç‰¹å®šåè®®æ—çš„å¥—æ¥å­—åˆ›å»ºå‡½æ•°ã€‚</p><p>è¿™æ ·æè¿°ä½ å¯èƒ½è¿˜æ²¡æœ‰ç›´è§‚æ„Ÿå—ï¼Œæˆ‘ç‰¹æ„ç”»äº†å›¾ï¼Œå¸®ä½ æ¢³ç†socketåˆ›å»ºçš„æµç¨‹ï¼Œä½ å¯ä»¥å¯¹ç…§å›¾ç‰‡ä»”ç»†ä½“ä¼šè°ƒç”¨è¿‡ç¨‹ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/31/ef/313d5d8c3b3224633fab2bd121006aef.jpg?wh=2655x2255" alt="" title="socketåˆ›å»ºç¤ºæ„å›¾"></p><p>ç»“åˆå›¾è§£ï¼Œæˆ‘å†ç”¨ä¸€ä¸ªå…·ä½“ä¾‹å­å¸®ä½ åŠ æ·±ç†è§£ï¼Œæ¯”å¦‚ç”±AF_INETåè®®æ—çš„inet_createå‡½æ•°å®Œæˆå¥—æ¥å­—ä¸ç‰¹å®šåè®®æ—çš„å…³è”ã€‚</p><p>ä¸€ä¸ªæ–°çš„struct socketæ•°æ®ç»“æ„èµ·å§‹ç”±sock_createå‡½æ•°åˆ›å»ºï¼Œ<strong>è¯¥å‡½æ•°ç›´æ¥è°ƒç”¨__sock_createå‡½æ•°ï¼Œ__sock_createå‡½æ•°çš„ä»»åŠ¡æ˜¯ä¸ºå¥—æ¥å­—é¢„ç•™éœ€è¦çš„å†…å­˜ç©ºé—´ï¼Œç”±sock_allocå‡½æ•°å®Œæˆè¿™é¡¹åŠŸèƒ½ã€‚</strong></p><p>è¿™ä¸ªsock_allocå‡½æ•°ä¸ä»…ä¼šä¸ºstruct socketæ•°æ®ç»“æ„å®ä¾‹é¢„ç•™ç©ºé—´ï¼Œä¹Ÿä¼šä¸ºstruct inodeæ•°æ®ç»“æ„å®ä¾‹åˆ†é…éœ€è¦çš„å†…å­˜ç©ºé—´ï¼Œè¿™æ ·å¯ä»¥ä½¿ä¸¤ä¸ªæ•°æ®ç»“æ„çš„å®ä¾‹ç›¸å…³è”ã€‚__sock_createå‡½æ•°ä»£ç å¦‚ä¸‹ã€‚</p><pre><code>static int __sock_create(struct net *net, int family, int type, int protocol,
 struct socket **res, int kern)
{
int err;
struct socket *sock;
const struct net_proto_family *pf;
// é¦–å…ˆæ£€éªŒæ˜¯å¦æ”¯æŒåè®®æ—
/*
* æ£€æŸ¥æ˜¯å¦åœ¨å†…æ ¸æ”¯æŒçš„socketèŒƒå›´å†…
*/
if (family &lt; 0 || family &gt;= NPROTO)
return -EAFNOSUPPORT;
if (type &lt; 0 || type &gt;= SOCK_MAX)
return -EINVAL;
/*
* ä¸ºæ–°çš„å¥—æ¥å­—åˆ†é…å†…å­˜ç©ºé—´ï¼Œåˆ†é…æˆåŠŸåè¿”å›æ–°çš„æŒ‡é’ˆ
*/

sock = sock_alloc();
}
</code></pre><p>sock_allocå‡½æ•°å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>static struct socket *sock_alloc(void) {
struct inode *inode;
struct socket *sock;
    // åˆå§‹åŒ–ä¸€ä¸ªå¯ç”¨çš„inodeèŠ‚ç‚¹ï¼Œ åœ¨fs/inode.cä¸­
    inode = new_inode(sock_mnt-&gt;mnt_sb);
    if (!inode)
    return NULL;
    // å®é™…åˆ›å»ºçš„æ˜¯socket_allocå¤åˆå¯¹è±¡ï¼Œå› æ­¤è¦ä½¿ç”¨SOCKET_Iå®ä»inodeä¸­å–å‡ºå…³è”çš„socketå¯¹è±¡ç”¨äºè¿”å›
    sock = SOCKET_I(inode);

    kmemcheck_annotate_bitfield(sock, type);
    // æ–‡ä»¶ç±»å‹ä¸ºå¥—æ¥å­—
    inode-&gt;i_mode = S_IFSOCK | S_IRWXUGO;
    inode-&gt;i_uid = current_fsuid();
    inode-&gt;i_gid = current_fsgid();

    percpu_add(sockets_in_use, 1);
return sock;
}
</code></pre><p>å½“å…·ä½“çš„åè®®ä¸æ–°å¥—æ¥å­—ç›¸è¿æ—¶ï¼Œå…¶å†…éƒ¨çŠ¶æ€çš„ç®¡ç†ç”±åè®®è‡ªèº«ç»´æŠ¤ã€‚</p><p>ç°åœ¨ï¼Œå‡½æ•°å°†struct socketæ•°æ®ç»“æ„çš„struct proto_ops *opsè®¾ç½®ä¸ºNULLã€‚éšåï¼Œå½“æŸä¸ªåè®®æ—ä¸­çš„åè®®æˆå‘˜çš„å¥—æ¥å­—åˆ›å»ºå‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œopså°†æŒ‡å‘åè®®å®ä¾‹çš„æ“ä½œå‡½æ•°ã€‚è¿™æ—¶å°†struct socketæ•°æ®ç»“æ„çš„flagsæ•°æ®åŸŸè®¾ç½®ä¸º0ï¼Œåˆ›å»ºæ—¶è¿˜æ²¡æœ‰ä»»ä½•æ ‡å¿—éœ€è¦è®¾ç½®ã€‚</p><p>åœ¨ä¹‹åçš„è°ƒç”¨ä¸­ï¼Œåº”ç”¨ç¨‹åºè°ƒç”¨sendæˆ–receiveå¥—æ¥å­—åº“å‡½æ•°æ—¶ä¼šè®¾ç½®flagsæ•°æ®åŸŸã€‚æœ€åå°†å…¶ä»–ä¸¤ä¸ªæ•°æ®åŸŸskå’Œfileåˆå§‹åŒ–ä¸ºNULLã€‚skæ•°æ®åŸŸéšåä¼šæŠŠç”±åè®®ç‰¹æœ‰çš„å¥—æ¥å­—åˆ›å»ºå‡½æ•°è®¾ç½®ä¸ºæŒ‡å‘å†…éƒ¨å¥—æ¥å­—ç»“æ„ã€‚fileå°†åœ¨è°ƒç”¨sock_ma_fdå‡½æ•°æ—¶è®¾ç½®ä¸ºåˆ†é…çš„æ–‡ä»¶è¿”å›çš„æŒ‡é’ˆã€‚</p><p>æ–‡ä»¶æŒ‡é’ˆç”¨äºè®¿é—®æ‰“å¼€å¥—æ¥å­—çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶çŠ¶æ€ã€‚åœ¨sock_allocå‡½æ•°è¿”å›åï¼Œsock_createå‡½æ•°è°ƒç”¨åè®®æ—çš„å¥—æ¥å­—åˆ›å»ºå‡½æ•°err =pf-&gt;create(net, sock, protocol)ï¼Œå®ƒé€šè¿‡è®¿é—®net_familiesæ•°ç»„è·å–åè®®æ—çš„åˆ›å»ºå‡½æ•°ï¼Œå¯¹äºTCP/IPåè®®æ ˆï¼Œåè®®æ—å°†è®¾ç½®ä¸ºAF_INETã€‚</p><h3>å¥—æ¥å­—çš„ç»‘å®š</h3><p>åˆ›å»ºå®Œå¥—æ¥å­—åï¼Œåº”ç”¨ç¨‹åºéœ€è¦è°ƒç”¨sys_bindå‡½æ•°æŠŠå¥—æ¥å­—å’Œåœ°å€ç»‘å®šèµ·æ¥ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>asmlinkage long sysbind (bind, int, fd, struct sockaddr __user *, umyaddr, int, addrlen)
{
	struct socket *sock;
	struct sockaddr_storage address;
	int err, fput_needed;
 
	/*
	 * è·å–socketå®ä¾‹ã€‚
	 */
	sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);
	if (sock) {
		err = move_addr_to_kernel(umyaddr, addrlen, (struct sockaddr *)&amp;address);
		if (err &gt;= 0) {
			err = security_socket_bind(sock,
						   (struct sockaddr *)&amp;address,
						   addrlen);
			/*
			 * å¦‚æœæ˜¯TCPå¥—æ¥å­—ï¼Œsock-&gt;opsæŒ‡å‘çš„æ˜¯inet_stream_opsï¼Œ
			 * sock-&gt;opsæ˜¯åœ¨inet_create()å‡½æ•°ä¸­åˆå§‹åŒ–ï¼Œæ‰€ä»¥bindæ¥å£
			 * è°ƒç”¨çš„æ˜¯inet_bind()å‡½æ•°ã€‚
			 */
			if (!err)
				err = sock-&gt;ops-&gt;bind(sock,
						      (struct sockaddr *)
						      &amp;address, addrlen);
		}
		fput_light(sock-&gt;file, fput_needed);
	}
	return err;
}
</code></pre><p>ç»“åˆä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œsys_bindå‡½æ•°é¦–å…ˆä¼šæŸ¥æ‰¾å¥—æ¥å­—å¯¹åº”çš„socketå®ä¾‹ï¼Œè°ƒç”¨<strong>sockfd_lookup_light</strong>ã€‚åœ¨ç»‘å®šä¹‹å‰ï¼Œå°†ç”¨æˆ·ç©ºé—´çš„åœ°å€æ‹·è´åˆ°å†…æ ¸ç©ºé—´çš„ç¼“å†²åŒºä¸­ï¼Œåœ¨æ‹·è´è¿‡ç¨‹ä¸­ä¼šæ£€æŸ¥ç”¨æˆ·ä¼ å…¥çš„åœ°å€æ˜¯å¦æ­£ç¡®ã€‚</p><p>ç­‰ä¸Šè¿°çš„å‡†å¤‡å·¥ä½œå®Œæˆåï¼Œå°±ä¼šè°ƒç”¨<strong>inet_bindå‡½æ•°</strong>æ¥å®Œæˆç»‘å®šæ“ä½œã€‚<strong>inet_bind</strong>å‡½æ•°ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>int inet_bind(struct socket *sock, struct sockaddr *uaddr, int addr_len)
{
    struct sockaddr_in *addr = (struct sockaddr_in *)uaddr;
    struct sock *sk = sock-&gt;sk;  
    struct inet_sock *inet = inet_sk(sk);
    unsigned short snum;
    int chk_addr_ret;
    int err;

    if (sk-&gt;sk_prot-&gt;bind) {/* å¦‚æœä¼ è¾“å±‚æ¥å£ä¸Šå®ç°äº†bindè°ƒç”¨ï¼Œåˆ™å›è°ƒå®ƒã€‚ç›®å‰åªæœ‰SOCK_RAWç±»å‹çš„ä¼ è¾“å±‚å®ç°äº†è¯¥æ¥å£raw_bind */
        err = sk-&gt;sk_prot-&gt;bind(sk, uaddr, addr_len);
        goto out;
    }
    err = -EINVAL;
    if (addr_len &lt; sizeof(struct sockaddr_in))
        goto out;
    err = -EADDRNOTAVAIL;
    if (!sysctl_ip_nonlocal_bind &amp;&amp;/* å¿…é¡»ç»‘å®šåˆ°æœ¬åœ°æ¥å£çš„åœ°å€ */
        !inet-&gt;freebind &amp;&amp;
        addr-&gt;sin_addr.s_addr != INADDR_ANY &amp;&amp;/* ç»‘å®šåœ°å€ä¸åˆæ³• */
        chk_addr_ret != RTN_LOCAL &amp;&amp;
        chk_addr_ret != RTN_MULTICAST &amp;&amp;
        chk_addr_ret != RTN_BROADCAST)
        goto out;

    snum = ntohs(addr-&gt;sin_port);
    err = -EACCES;
    if (snum &amp;&amp; snum &lt; PROT_SOCK &amp;&amp; !capable(CAP_NET_BIND_SERVICE))
        goto out;

    lock_sock(sk);/* å¯¹å¥—æ¥å£è¿›è¡ŒåŠ é”ï¼Œå› ä¸ºåé¢è¦å¯¹å…¶çŠ¶æ€è¿›è¡Œåˆ¤æ–­ */

    /* Check these errors (active socket, double bind). */
    err = -EINVAL;
    /**
     * å¦‚æœçŠ¶æ€ä¸ä¸ºCLOSEï¼Œè¡¨ç¤ºå¥—æ¥å£å·²ç»å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œä¸èƒ½å†ç»‘å®š
     * æˆ–è€…å·²ç»æŒ‡å®šäº†æœ¬åœ°ç«¯å£å·ï¼Œä¹Ÿä¸èƒ½å†ç»‘å®š
     */
    if (sk-&gt;sk_state != TCP_CLOSE || inet-&gt;num)
        goto out_release_sock;

    /* è®¾ç½®åœ°å€åˆ°ä¼ è¾“æ§åˆ¶å—ä¸­ */
    inet-&gt;rcv_saddr = inet-&gt;saddr = addr-&gt;sin_addr.s_addr;
    /* å¦‚æœæ˜¯å¹¿æ’­æˆ–è€…å¤šæ’­åœ°å€ï¼Œåˆ™æºåœ°å€ä½¿ç”¨è®¾å¤‡åœ°å€ã€‚ */
    if (chk_addr_ret == RTN_MULTICAST || chk_addr_ret == RTN_BROADCAST)
        inet-&gt;saddr = 0;  /* Use device */

    /* è°ƒç”¨ä¼ è¾“å±‚çš„get_portæ¥è¿›è¡Œåœ°å€ç»‘å®šã€‚å¦‚tcp_v4_get_portæˆ–udp_v4_get_port */
    if (sk-&gt;sk_prot-&gt;get_port(sk, snum)) {
        â€¦
    }

    /* è®¾ç½®æ ‡å¿—ï¼Œè¡¨ç¤ºå·²ç»ç»‘å®šäº†æœ¬åœ°åœ°å€å’Œç«¯å£ */
    if (inet-&gt;rcv_saddr)
        sk-&gt;sk_userlocks |= SOCK_BINDADDR_LOCK;
    if (snum)
        sk-&gt;sk_userlocks |= SOCK_BINDPORT_LOCK;
    inet-&gt;sport = htons(inet-&gt;num);
    /* è¿˜æ²¡æœ‰è¿æ¥åˆ°å¯¹æ–¹ï¼Œæ¸…é™¤è¿œç«¯åœ°å€å’Œç«¯å£ */
    inet-&gt;daddr = 0;
    inet-&gt;dport = 0;
    /* æ¸…é™¤è·¯ç”±ç¼“å­˜ */
    sk_dst_reset(sk);
    err = 0;
out_release_sock:
    release_sock(sk);
out:
    return err;
}
</code></pre><h3>ä¸»åŠ¨è¿æ¥</h3><p>å› ä¸ºåº”ç”¨ç¨‹åºå¤„ç†çš„æ˜¯é¢å‘è¿æ¥çš„ç½‘ç»œæœåŠ¡ï¼ˆSOCK_STREAMæˆ–SOCK_SEQPACKETï¼‰ï¼Œæ‰€ä»¥åœ¨äº¤æ¢æ•°æ®ä¹‹å‰ï¼Œéœ€è¦åœ¨è¯·æ±‚è¿æ¥æœåŠ¡çš„è¿›ç¨‹ï¼ˆå®¢æˆ·ï¼‰ä¸æä¾›æœåŠ¡çš„è¿›ç¨‹ï¼ˆæœåŠ¡å™¨ï¼‰ä¹‹é—´å»ºç«‹è¿æ¥ã€‚</p><p>å½“åº”ç”¨ç¨‹åºè°ƒç”¨<strong>connect</strong>å‡½æ•°å‘å‡ºè¿æ¥è¯·æ±‚æ—¶ï¼Œå†…æ ¸ä¼šå¯åŠ¨å‡½æ•°<strong>sys_connect</strong>ï¼Œè¯¦ç»†ä»£ç å¦‚ä¸‹ã€‚</p><pre><code>int __sys_connect(int fd, struct sockaddr __user *uservaddr, int addrlen)
{
	int ret = -EBADF;
	struct fd f;
	f = fdget(fd);
	if (f.file) {
		struct sockaddr_storage address;
		ret = move_addr_to_kernel(uservaddr, addrlen, &amp;address);
		if (!ret)
            // è°ƒç”¨__sys_connect_file
			ret = __sys_connect_file(f.file, &amp;address, addrlen, 0);
		fdput(f);
	}
	return ret;
}
</code></pre><p>è¿æ¥æˆåŠŸä¼šè¿”å›socketçš„æè¿°ç¬¦ï¼Œå¦åˆ™ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ç ã€‚</p><h3>ç›‘å¬å¥—æ¥å­—</h3><p>è°ƒç”¨listenå‡½æ•°æ—¶ï¼Œåº”ç”¨ç¨‹åºè§¦å‘å†…æ ¸çš„<strong>sys_listen</strong>å‡½æ•°ï¼ŒæŠŠå¥—æ¥å­—æè¿°ç¬¦fdå¯¹åº”çš„å¥—æ¥å­—è®¾ç½®ä¸ºç›‘å¬æ¨¡å¼ï¼Œè§‚å¯Ÿè¿æ¥è¯·æ±‚ã€‚è¯¦ç»†ä»£ç ä½ å¯ä»¥çœ‹çœ‹åé¢çš„å†…å®¹ã€‚</p><pre><code>int __sys_listen(int fd, int backlog)
{
	struct socket *sock;
	int err, fput_needed;
	int somaxconn;
    // é€šè¿‡å¥—æ¥å­—æè¿°ç¬¦æ‰¾åˆ°struct socket
	sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);
	if (sock) {
		somaxconn = sock_net(sock-&gt;sk)-&gt;core.sysctl_somaxconn;
		if ((unsigned int)backlog &gt; somaxconn)
			backlog = somaxconn;
		err = security_socket_listen(sock, backlog);
		if (!err)
            // æ ¹æ®å¥—æ¥å­—ç±»å‹è°ƒç”¨ç›‘å¬å‡½æ•°
			err = sock-&gt;ops-&gt;listen(sock, backlog);
		fput_light(sock-&gt;file, fput_needed);
	}
	return err;
}
</code></pre><h3>è¢«åŠ¨æ¥æ”¶è¿æ¥</h3><p>å‰é¢è¯´è¿‡ä¸»åŠ¨è¿æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹è¢«åŠ¨æ¥å—è¿æ¥çš„æƒ…å†µã€‚æ¥å—ä¸€ä¸ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ä¼šè°ƒç”¨<strong>accept</strong>å‡½æ•°ï¼Œåº”ç”¨ç¨‹åºè§¦å‘å†…æ ¸å‡½æ•°<strong>sys_accept</strong>ï¼Œç­‰å¾…æ¥æ”¶è¿æ¥è¯·æ±‚ã€‚å¦‚æœå…è®¸è¿æ¥ï¼Œåˆ™é‡æ–°åˆ›å»ºä¸€ä¸ªä»£è¡¨è¯¥è¿æ¥çš„å¥—æ¥å­—ï¼Œå¹¶è¿”å›å…¶å¥—æ¥å­—æè¿°ç¬¦ï¼Œä»£ç å¦‚ä¸‹ã€‚</p><pre><code>int __sys_accept4_file(struct file *file, unsigned file_flags,
		       struct sockaddr __user *upeer_sockaddr,
		       int __user *upeer_addrlen, int flags,
		       unsigned long nofile)
{
	struct socket *sock, *newsock;
	struct file *newfile;
	int err, len, newfd;
	struct sockaddr_storage address;
	if (flags &amp; ~(SOCK_CLOEXEC | SOCK_NONBLOCK))
		return -EINVAL;
	if (SOCK_NONBLOCK != O_NONBLOCK &amp;&amp; (flags &amp; SOCK_NONBLOCK))
		flags = (flags &amp; ~SOCK_NONBLOCK) | O_NONBLOCK;
	sock = sock_from_file(file, &amp;err);
	if (!sock)
		goto out;
	err = -ENFILE;
    // åˆ›å»ºä¸€ä¸ªæ–°å¥—æ¥å­—
	newsock = sock_alloc();
	if (!newsock)
		goto out;
	newsock-&gt;type = sock-&gt;type;
	newsock-&gt;ops = sock-&gt;ops;
	__module_get(newsock-&gt;ops-&gt;owner);
	newfd = __get_unused_fd_flags(flags, nofile);
	if (unlikely(newfd &lt; 0)) {
		err = newfd;
		sock_release(newsock);
		goto out;
	}
	newfile = sock_alloc_file(newsock, flags, sock-&gt;sk-&gt;sk_prot_creator-&gt;name);
	if (IS_ERR(newfile)) {
		err = PTR_ERR(newfile);
		put_unused_fd(newfd);
		goto out;
	}
	err = security_socket_accept(sock, newsock);
	if (err)
		goto out_fd;
    // æ ¹æ®å¥—æ¥å­—ç±»å‹è°ƒç”¨ä¸åŒçš„å‡½æ•°inet_accept
	err = sock-&gt;ops-&gt;accept(sock, newsock, sock-&gt;file-&gt;f_flags | file_flags,
					false);
	if (err &lt; 0)
		goto out_fd;
	if (upeer_sockaddr) {
		len = newsock-&gt;ops-&gt;getname(newsock,
					(struct sockaddr *)&amp;address, 2);
		if (len &lt; 0) {
			err = -ECONNABORTED;
			goto out_fd;
		}
        // ä»å†…æ ¸å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´
		err = move_addr_to_user(&amp;address,
					len, upeer_sockaddr, upeer_addrlen);
		if (err &lt; 0)
			goto out_fd;
	}
	/* File flags are not inherited via accept() unlike another OSes. */
	fd_install(newfd, newfile);
	err = newfd;
out:
	return err;
out_fd:
	fput(newfile);
	put_unused_fd(newfd);
	goto out;
}
</code></pre><p>è¿™ä¸ªæ–°çš„å¥—æ¥å­—æè¿°ç¬¦ä¸æœ€åˆåˆ›å»ºå¥—æ¥å­—æ—¶ï¼Œè®¾ç½®çš„å¥—æ¥å­—åœ°å€æ—ä¸å¥—æ¥å­—ç±»å‹ã€ä½¿ç”¨çš„åè®®ä¸€æ ·ã€‚åŸæ¥åˆ›å»ºçš„å¥—æ¥å­—ä¸ä¸è¿æ¥å…³è”ï¼Œå®ƒç»§ç»­åœ¨åŸå¥—æ¥å­—ä¸Šä¾¦å¬ï¼Œä»¥ä¾¿æ¥æ”¶å…¶ä»–è¿æ¥è¯·æ±‚ã€‚</p><h3>å‘é€æ•°æ®</h3><p>å¥—æ¥å­—åº”ç”¨ä¸­æœ€ç®€å•çš„ä¼ é€å‡½æ•°æ˜¯<strong>send</strong>ï¼Œsendå‡½æ•°çš„ä½œç”¨ç±»ä¼¼äºwriteï¼Œä½†sendå‡½æ•°å…è®¸åº”ç”¨ç¨‹åºæŒ‡å®šæ ‡å¿—ï¼Œè§„å®šå¦‚ä½•å¯¹å¾…ä¼ é€æ•°æ®ã€‚è°ƒç”¨sendå‡½æ•°æ—¶ï¼Œä¼šè§¦å‘å†…æ ¸çš„<strong>sys_send</strong>å‡½æ•°ï¼ŒæŠŠå‘é€ç¼“å†²åŒºçš„æ•°æ®å‘é€å‡ºå»ã€‚</p><p><strong>sys_send</strong>å‡½æ•°å…·ä½“è°ƒç”¨æµç¨‹å¦‚ä¸‹ã€‚</p><p>1.åº”ç”¨ç¨‹åºçš„æ•°æ®è¢«å¤åˆ¶åˆ°å†…æ ¸åï¼Œsys_sendå‡½æ•°è°ƒç”¨<strong>sock_sendmsg</strong>ï¼Œä¾æ®åè®®æ—ç±»å‹æ¥æ‰§è¡Œå‘é€æ“ä½œã€‚<br>
2.å¦‚æœæ˜¯INETåè®®æ—å¥—æ¥å­—ï¼Œsock_sendmsgå°†è°ƒç”¨inet_sendmsgå‡½æ•°ã€‚<br>
3.å¦‚æœé‡‡ç”¨TCPåè®®ï¼Œinet_sendmsgå‡½æ•°å°†è°ƒç”¨tcp_sendmsgï¼Œå¹¶æŒ‰ç…§TCPåè®®è§„åˆ™æ¥å‘é€æ•°æ®åŒ…ã€‚</p><p>sendå‡½æ•°è¿”å›å‘é€æˆåŠŸï¼Œå¹¶ä¸æ„å‘³ç€åœ¨è¿æ¥çš„å¦ä¸€ç«¯çš„è¿›ç¨‹å¯ä»¥æ”¶åˆ°æ•°æ®ï¼Œè¿™é‡Œåªèƒ½ä¿è¯å‘é€sendå‡½æ•°æ‰§è¡ŒæˆåŠŸï¼Œå‘é€ç»™ç½‘ç»œè®¾å¤‡é©±åŠ¨ç¨‹åºçš„æ•°æ®æ²¡æœ‰å‡ºé”™ã€‚</p><h3>æ¥æ”¶æ•°æ®</h3><p><strong>recv</strong>å‡½æ•°ä¸æ–‡ä»¶è¯»readå‡½æ•°ç±»ä¼¼ï¼Œrecvå‡½æ•°ä¸­å¯ä»¥æŒ‡å®šæ ‡å¿—æ¥æ§åˆ¶å¦‚ä½•æ¥æ”¶æ•°æ®ï¼Œè°ƒç”¨recvå‡½æ•°æ—¶ï¼Œåº”ç”¨ç¨‹åºä¼šè§¦å‘å†…æ ¸çš„sys_recvå‡½æ•°ï¼ŒæŠŠç½‘ç»œä¸­çš„æ•°æ®é€’äº¤åˆ°åº”ç”¨ç¨‹åºã€‚å½“ç„¶ï¼Œreadã€recvfromå‡½æ•°ä¹Ÿä¼šè§¦å‘sys_recvå‡½æ•°ã€‚å…·ä½“æµç¨‹å¦‚ä¸‹ã€‚</p><p>1.ä¸ºæŠŠå†…æ ¸çš„ç½‘ç»œæ•°æ®è½¬å…¥åº”ç”¨ç¨‹åºçš„æ¥æ”¶ç¼“å†²åŒºï¼Œsys_recvå‡½æ•°ä¾æ¬¡è°ƒç”¨<strong>sys_recvfromã€sock_recvfromå’Œ__sock_recvmsg</strong>ï¼Œå¹¶ä¾æ®åè®®æ—ç±»å‹æ¥æ‰§è¡Œå…·ä½“çš„æ¥æ”¶æ“ä½œã€‚<br>
2.å¦‚æœæ˜¯INETåè®®æ—å¥—æ¥å­—ï¼Œ__sock_recvmsgå°†è°ƒç”¨sock_common_recvmsgå‡½æ•°ã€‚<br>
3.å¦‚æœé‡‡ç”¨TCPåè®®ï¼Œsock_common_recvmsgå‡½æ•°å°†è°ƒç”¨tcp_recvmsgï¼ŒæŒ‰ç…§TCPåè®®è§„åˆ™æ¥æ¥æ”¶æ•°æ®åŒ…</p><p>å¦‚æœæ¥æ”¶æ–¹æƒ³è·å–æ•°æ®åŒ…å‘é€ç«¯çš„æ ‡è¯†ç¬¦ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥è°ƒç”¨<strong>sys_recvfrom</strong>å‡½æ•°æ¥è·å–æ•°æ®åŒ…å‘é€æ–¹çš„æºåœ°å€ï¼Œä¸‹é¢æ˜¯<strong>sys_recvfrom</strong>å‡½æ•°çš„å®ç°ã€‚</p><pre><code>int __sys_recvfrom(int fd, void __user *ubuf, size_t size, unsigned int flags,
		   struct sockaddr __user *addr, int __user *addr_len)
{
	struct socket *sock;
	struct iovec iov;
	struct msghdr msg;
	struct sockaddr_storage address;
	int err, err2;
	int fput_needed;
	err = import_single_range(READ, ubuf, size, &amp;iov, &amp;msg.msg_iter);
	if (unlikely(err))
		return err;
    // é€šè¿‡å¥—æ¥å­—æè¿°ç¬¦æ‰¾åˆ°struct socket
	sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);
	if (!sock)
		goto out;
	msg.msg_control = NULL;
	msg.msg_controllen = 0;
	/* Save some cycles and don't copy the address if not needed */
	msg.msg_name = addr ? (struct sockaddr *)&amp;address : NULL;
	/* We assume all kernel code knows the size of sockaddr_storage */
	msg.msg_namelen = 0;
	msg.msg_iocb = NULL;
	msg.msg_flags = 0;
	if (sock-&gt;file-&gt;f_flags &amp; O_NONBLOCK)
		flags |= MSG_DONTWAIT;
    // sock_recvmsgä¸ºå…·ä½“çš„æ¥æ”¶å‡½æ•°
	err = sock_recvmsg(sock, &amp;msg, flags);
	if (err &gt;= 0 &amp;&amp; addr != NULL) {
        // ä»å†…æ ¸å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´
		err2 = move_addr_to_user(&amp;address,
					 msg.msg_namelen, addr, addr_len);
		if (err2 &lt; 0)
			err = err2;
	}
	fput_light(sock-&gt;file, fput_needed);
out:
	return err;
}
</code></pre><h3>å…³é—­è¿æ¥</h3><p>æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•å…³é—­è¿æ¥ã€‚å½“åº”ç”¨ç¨‹åºè°ƒç”¨shutdownå‡½æ•°å…³é—­è¿æ¥æ—¶ï¼Œå†…æ ¸ä¼šå¯åŠ¨å‡½æ•°sys_shutdownï¼Œä»£ç å¦‚ä¸‹ã€‚</p><pre><code>int __sys_shutdown(int fd, int how)
{
	int err, fput_needed;
	struct socket *sock;
	sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);/* é€šè¿‡å¥—æ¥å­—ï¼Œæè¿°ç¬¦æ‰¾åˆ°å¯¹åº”çš„ç»“æ„*/
	if (sock != NULL) {
		err = security_socket_shutdown(sock, how);
		if (!err)
             /* æ ¹æ®å¥—æ¥å­—åè®®æ—è°ƒç”¨å…³é—­å‡½æ•°*/
			err = sock-&gt;ops-&gt;shutdown(sock, how);
    		fput_light(sock-&gt;file, fput_needed);
	}
	return err;
}
</code></pre><h2>é‡ç‚¹å›é¡¾</h2><p>å¥½ï¼Œè¿™èŠ‚è¯¾çš„å†…å®¹å‘Šä¸€æ®µè½äº†ï¼Œæˆ‘æ¥ç»™ä½ åšä¸ªæ€»ç»“ã€‚è¿™èŠ‚è¯¾æˆ‘ä»¬ç»§ç»­ç ”ç©¶äº†å¥—æ¥å­—åœ¨Linuxå†…æ ¸ä¸­çš„å®ç°ã€‚</p><p>å¥—æ¥å­—æ˜¯UNIXå…¼å®¹ç³»ç»Ÿçš„ä¸€å¤§ç‰¹è‰²ï¼ŒLinuxåœ¨æ­¤åŸºç¡€ä¸Šå®ç°äº†å†…æ ¸å¥—æ¥å­—ä¸åº”ç”¨ç¨‹åºå¥—æ¥å­—æ¥å£ï¼Œåœ¨ç”¨æˆ·åœ°å€ç©ºé—´ä¸å†…æ ¸åœ°å€ç©ºé—´ä¹‹é—´æä¾›äº†ä¸€å¥—æ ‡å‡†æ¥å£ï¼Œå®ç°åº”ç”¨å¥—æ¥å­—åº“å‡½æ•°ä¸å†…æ ¸åŠŸèƒ½ä¹‹é—´çš„ä¸€ä¸€å¯¹åº”ï¼Œç®€åŒ–äº†ç”¨æˆ·åœ°å€ç©ºé—´ä¸å†…æ ¸åœ°å€ç©ºé—´äº¤æ¢æ•°æ®çš„è¿‡ç¨‹ã€‚</p><p>é€šè¿‡åº”ç”¨å¥—æ¥å­—APIç¼–å†™ç½‘ç»œåº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨Linuxå†…æ ¸TCP/IPåè®®æ ˆæä¾›çš„ç½‘ç»œé€šä¿¡æœåŠ¡ï¼Œåœ¨ç½‘ç»œä¸Šå®ç°åº”ç”¨æ•°æ®å¿«é€Ÿã€æœ‰æ•ˆçš„ä¼ é€ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¥—æ¥å­—ç¼–ç¨‹è¿˜å¯ä»¥ä½¿æˆ‘ä»¬è·å–ç½‘ç»œã€ä¸»æœºçš„å„ç§ç®¡ç†ã€ç»Ÿè®¡ä¿¡æ¯ã€‚</p><p>åˆ›å»ºå¥—æ¥å­—åº”ç”¨ç¨‹åºä¸€èˆ¬è¦ç»è¿‡åé¢è¿™6ä¸ªæ­¥éª¤ã€‚</p><p>1.åˆ›å»ºå¥—æ¥å­—ã€‚<br>
2.å°†å¥—æ¥å­—ä¸åœ°å€ç»‘å®šï¼Œè®¾ç½®å¥—æ¥å­—é€‰é¡¹ã€‚<br>
3.å»ºç«‹å¥—æ¥å­—ä¹‹é—´çš„è¿æ¥ã€‚<br>
4.ç›‘å¬å¥—æ¥å­—<br>
5.æ¥æ”¶ã€å‘é€æ•°æ®ã€‚<br>
6.å…³é—­ã€é‡Šæ”¾å¥—æ¥å­—ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>æˆ‘ä»¬äº†è§£çš„TCPä¸‰æ¬¡æ¡æ‰‹ï¼Œå‘ç”Ÿåœ¨socketçš„å“ªå‡ ä¸ªå‡½æ•°ä¸­å‘¢ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè·Ÿæˆ‘äº¤æµï¼Œä¹Ÿæ¨èä½ æŠŠè¿™èŠ‚è¯¾è½¬å‘ç»™æœ‰éœ€è¦çš„æœ‹å‹ã€‚</p><p>æˆ‘æ˜¯LMOSï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼</p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>neohope</span>
  </div>
  <div class="_2_QraFYR_0">å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹åˆ†æä¸‹ã€V5.8ï¼Œæ­£å¸¸æµç¨‹ã€‘<br>5ã€å®¢æˆ·ç«¯æ”¶åˆ°FINåŒ…ï¼Œå­çŠ¶æ€ä»TCP_FIN_WAIT2å˜ä¸ºTCP_TIME_WAITï¼Œè¿”å›ACKåŒ…<br>Aã€çŠ¶æ€å’Œå­çŠ¶æ€éƒ½ä¸ºTCP_TIME_WAIT<br>ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;<br>-&gt;if (sk-&gt;sk_state == TCP_TIME_WAIT) goto do_time_wait;<br>-&gt;do_time_wait:<br>-&gt;tcp_timewait_state_process<br>-&gt;-&gt;if (tw-&gt;tw_substate == TCP_FIN_WAIT2)<br>-&gt;-&gt;tw-&gt;tw_substate = TCP_TIME_WAIT;<br>-&gt;-&gt;inet_twsk_rescheduleï¼Œé‡æ–°è®¾ç½®å›è°ƒæ—¶é—´<br>-&gt;-&gt;return TCP_TW_ACK;<br><br>Bã€è¿”å›ACK<br>-&gt;case TCP_TW_ACK:<br>-&gt;tcp_v4_timewait_ack(sk, skb);<br><br>6ã€æœåŠ¡ç«¯æ”¶åˆ°ACKåŒ…ï¼ŒçŠ¶æ€ä»TCP_LAST_ACKå˜ä¸ºTCP_CLOSE<br>ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_state_process<br>-&gt;case TCP_LAST_ACK:<br>-&gt;tcp_done<br>-&gt;-&gt;tcp_set_state(sk, TCP_CLOSE);<br><br>7ã€å®¢æˆ·ç«¯è¶…æ—¶å›è°ƒ<br>Aã€è¶…æ—¶æ—¶é—´å®šä¹‰<br>#define TCP_TIMEWAIT_LEN (60*HZ)<br>#define TCP_FIN_TIMEOUT TCP_TIMEWAIT_LEN<br><br>Bã€è¶…æ—¶åï¼Œå›è°ƒtw_timer_handler-&gt;inet_twsk_killï¼Œè¿›è¡Œinet_timewait_sockæ¸…ç†å·¥ä½œ<br><br>Cã€æ²¡æœ‰æ‰¾åˆ°çŠ¶æ€å˜ä»TCP_TIME_WAITå˜ä¸ºTCP_CLOSEçš„ä»£ç <br><br>Dã€åªçœ‹æ²¡è°ƒï¼Œæœ‰é—®é¢˜çš„ï¼Œæ¬¢è¿å°ä¼™ä¼´å‘Šè¯‰ä¸€ä¸‹</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: 66666</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-15 00:01:47</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>neohope</span>
  </div>
  <div class="_2_QraFYR_0">å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹åˆ†æä¸Šã€V5.8ï¼Œæ­£å¸¸æµç¨‹ã€‘<br>1ã€å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥ï¼ŒçŠ¶æ€ä»TCP_ESTABLISHEDå˜ä¸ºTCP_FIN_WAIT1ï¼Œå‘é€FINåŒ…ç»™æœåŠ¡ç«¯<br>Aã€çŠ¶æ€å˜ä¸ºTCP_FIN_WAIT1<br>tcp_close-&gt;tcp_close_state<br>-&gt;tcp_set_state(sk, new_state[TCP_ESTABLISHED])ï¼Œä¹Ÿå°±æ˜¯TCP_FIN_WAIT1<br><br>Bã€å‘é€FINåŒ…<br>tcp_close-&gt;tcp_close_state<br>-&gt;tcp_send_fin<br><br>2ã€æœåŠ¡ç«¯æ”¶åˆ°FINåŒ…ï¼ŒçŠ¶æ€ä»TCP_ESTABLISHEDå˜ä¸ºTCP_CLOSE_WAITï¼Œå¹¶è¿”å›ACKåŒ…<br>Aã€çŠ¶æ€å˜ä¸ºTCP_CLOSE_WAIT<br>ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_established<br>-&gt;tcp_data_queue<br>-&gt;-&gt;tcp_fin<br>-&gt;-&gt;-&gt;inet_csk_schedule_ack; å®‰æ’ack<br>-&gt;-&gt;-&gt;sk-&gt;sk_shutdown |= RCV_SHUTDOWN; æ¨¡æ‹Ÿäº†close<br>-&gt;-&gt;-&gt;sock_set_flag(sk, SOCK_DONE);<br>-&gt;-&gt;-&gt;case TCP_ESTABLISHED:<br>-&gt;-&gt;-&gt;tcp_set_state(sk, TCP_CLOSE_WAIT); ä¿®æ”¹çŠ¶æ€<br>-&gt;-&gt;inet_csk(sk)-&gt;icsk_ack.pending |= ICSK_ACK_NOW;  ACSæ˜¯å¦ç«‹å³å‘é€<br><br>Bã€å‘é€ACKåŒ…<br>ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_establishedã€æ¥ä¸Šé¢ã€‘<br>-&gt;tcp_ack_snd_check-&gt;__tcp_ack_snd_check-&gt;tcp_send_ack<br><br>3ã€å®¢æˆ·ç«¯æ”¶åˆ°ACKåŒ…ï¼ŒçŠ¶æ€ä»TCP_FIN_WAIT1å˜ä¸ºTCP_FIN_WAIT2ï¼Œç„¶åè¢«æ›¿æ¢ä¸ºçŠ¶æ€TCP_TIME_WAITï¼Œå­çŠ¶æ€TCP_FIN_WAIT2<br>ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_state_process<br>-&gt;case TCP_FIN_WAIT1:<br>-&gt;tcp_set_state(sk, TCP_FIN_WAIT2);<br>-&gt;tcp_time_wait(sk, TCP_FIN_WAIT2, tmo);<br>-&gt;-&gt;tw = inet_twsk_alloc(sk, tcp_death_row, state);<br>-&gt;-&gt;-&gt;tw-&gt;tw_state = TCP_TIME_WAIT;   <br>-&gt;-&gt;-&gt;tw-&gt;tw_substate = TCP_FIN_WAIT2;<br>-&gt;-&gt;-&gt;timer_setup(&amp;tw-&gt;tw_timer, tw_timer_handler, TIMER_PINNED);<br><br>4ã€æœåŠ¡ç«¯çŠ¶æ€ä»TCP_CLOSE_WAITå˜ä¸ºTCP_LAST_ACKï¼Œå‘é€FINåŒ…<br>Aã€çŠ¶æ€å˜ä¸ºTCP_LAST_ACK<br>tcp_close-&gt;tcp_close_state<br>-&gt;tcp_set_state(sk, new_state[TCP_CLOSE_WAIT])ï¼Œä¹Ÿå°±æ˜¯TCP_LAST_ACK<br><br>Bã€å‘é€FINåŒ…<br>tcp_close-&gt;tcp_close_state<br>-&gt;tcp_send_fin</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-15 00:01:16</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>neohope</span>
  </div>
  <div class="_2_QraFYR_0">ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹åˆ†æã€V5.8ï¼Œæ­£å¸¸æµç¨‹ã€‘<br>1ã€å®¢æˆ·ç«¯å‘èµ·ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼ŒçŠ¶æ€è°ƒå˜ä¸ºTCP_SYN_SENTï¼Œå‘é€SYNåŒ…<br>connect-&gt;__sys_connect-&gt;__sys_connect_file-&gt;ã€sock-&gt;ops-&gt;connectã€‘tcp_v4_connect<br>Aã€çŠ¶æ€å˜åŒ–<br>-&gt;tcp_set_state(sk, TCP_SYN_SENT);<br>Bã€å‘é€SYN<br>-&gt;tcp_connect-&gt;tcp_send_syn_data<br><br>2ã€æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯çš„SYNåŒ…ï¼Œåˆå§‹åŒ–socketï¼ŒçŠ¶æ€ä»TCP_LISTENå˜ä¸ºTCP_NEW_SYN_RECVï¼Œå‘é€ç¬¬äºŒæ¬¡æ¡æ‰‹SYN_ACKåŒ…<br>Aã€æ”¶åˆ°è¿æ¥ï¼Œåˆå§‹åŒ–socket<br>accept-&gt;__sys_accept4-&gt;__sys_accept4_file-&gt;ã€sock-&gt;ops-&gt;acceptã€‘inet_csk_accept<br><br>Bã€æ”¶åˆ°SYNï¼Œæ”¹å˜çŠ¶æ€<br>ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_state_process-&gt;<br>-&gt;case TCP_LISTEN:<br>-&gt;[sock-&gt;ops-&gt;conn_request]tcp_v4_conn_request-&gt;tcp_conn_request<br>-&gt;-&gt;inet_reqsk_alloc<br>-&gt;-&gt;-&gt;ireq-&gt;ireq_state = TCP_NEW_SYN_RECV;<br><br>Cã€å‘é€SYN_ACKåŒ…<br>-&gt;[sock-&gt;ops-&gt;conn_request]tcp_v4_conn_request-&gt;tcp_conn_requestã€å’ŒBè·¯å¾„ä¸€æ ·ã€‘<br>-&gt;-&gt;ã€af_ops-&gt;send_synackã€‘tcp_v4_send_synack<br>-&gt;-&gt;-&gt;tcp_make_synack<br>-&gt;-&gt;-&gt;__tcp_v4_send_check<br><br>3ã€å®¢æˆ·ç«¯æ”¶åˆ°SYN_ACKåŒ…ï¼ŒçŠ¶æ€ä»TCP_SYN_SENTå˜ä¸ºTCP_ESTABLISHEDï¼Œå¹¶å‘é€ACKåŒ…<br>Aã€æ”¶åˆ°SYN_ACKåŒ…<br>ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_state_process<br>-&gt;case TCP_SYN_SENT:<br>-&gt;tcp_rcv_synsent_state_process-&gt;tcp_finish_connect<br>-&gt;-&gt;tcp_set_state(sk, TCP_ESTABLISHED);<br><br>Bã€å‘é€ACKåŒ…<br>-&gt;tcp_rcv_synsent_state_process-&gt;tcp_send_ack-&gt;__tcp_send_ack<br><br>4ã€æœåŠ¡ç«¯æ”¶åˆ°ACKåŒ…ï¼ŒçŠ¶æ€ä»TCP_NEW_SYN_RECVå˜ä¸ºTCP_SYN_RECVã€å®é™…ä¸Šæ˜¯æ–°å»ºäº†ä¸€ä¸ªsockã€‘<br>ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;<br>-&gt;if (sk-&gt;sk_state == TCP_NEW_SYN_RECV)<br>-&gt;tcp_check_req<br>-&gt;-&gt;ã€inet_csk(sk)-&gt;icsk_af_ops-&gt;syn_recv_sockã€‘tcp_v4_syn_recv_sock-&gt;tcp_create_openreq_child-&gt;inet_csk_clone_lock<br>-&gt;-&gt;-&gt;inet_sk_set_state(newsk, TCP_SYN_RECV);<br><br>5ã€æœåŠ¡ç«¯çŠ¶æ€ä»TCP_SYN_RECVå˜ä¸ºTCP_ESTABLISHED<br>ã€tcp_protocol.handlerã€‘tcp_v4_rcv-&gt;tcp_v4_do_rcv-&gt;tcp_rcv_state_process<br>-&gt;case TCP_SYN_RECV:<br>-&gt;tcp_set_state(sk, TCP_ESTABLISHED);<br><br>åªçœ‹æ²¡è°ƒï¼Œæœ‰é—®é¢˜çš„æ¬¢è¿å„ä½å°ä¼™ä¼´æŒ‡å‡ºã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ˜¯çš„ æ€»ç»“åˆ°ä½</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-14 23:08:42</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/1a/85/87/727142bc.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>MacBao</span>
  </div>
  <div class="_2_QraFYR_0">æœåŠ¡å™¨ç«¯å¤„äºlistençŠ¶æ€ï¼Œå®¢æˆ·ç«¯connectå‘èµ·TCPä¸‰æ¬¡æ¡æ‰‹ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-09 08:18:39</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>pedro</span>
  </div>
  <div class="_2_QraFYR_0">ä»Šå¤©çš„é—®é¢˜ä¸å¥½å›ç­”ï¼Œå› ä¸ºæ–‡ä¸­æ— æ˜æ˜¾ä¸‰æ¬¡æ¡æ‰‹çš„ä»£ç ï¼Œè€Œä¸”ä¸‰æ¬¡æ¡æ‰‹çš„æœºåˆ¶å…¶å®æ¯”è¾ƒå¤æ‚ï¼Œæ¶‰åŠåˆ°å‡ ä¸ªçŠ¶æ€å’Œå‡ ä¸ªé˜Ÿåˆ—ä¹‹é—´çš„åˆ‡æ¢ï¼Œç¬¼ç»Ÿçš„ connect å’Œ accept å‡½æ•°æ˜¯è¯´ä¸æ¸…æ¥šçš„ï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹çœ‹è¿™é‡Œï¼š<br>https:&#47;&#47;blog.csdn.net&#47;tennysonsky&#47;article&#47;details&#47;45621341<br><br>å½“ç„¶è¿™äº›ä¸èƒ½å…¨ä¿¡ï¼Œæ‰€ä»¥è¿˜æ˜¯å¾—è‡ªå·±çœ‹linuxå†…æ ¸ä»£ç ï¼Œå¾…æˆ‘çœ‹äº†å†æ¥è¡¥å……ğŸ˜‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å¥½çš„ æœŸå¾…</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-09 07:45:48</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/28/b4/7c/59e24b60.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ç‹å­è™¾</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œtcpåœ¨è°ƒç”¨listençš„æ—¶å€™ï¼Œæœ‰å…¨è¿æ¥é˜Ÿåˆ—çš„æ¦‚å¿µï¼Œä¸€èˆ¬ä¸Šé™æ˜¯128ã€‚ä½†æ˜¯é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬æ¯”å¦‚å®ç°å•æœºç™¾ä¸‡é“¾æ¥çš„æ—¶å€™ï¼Œä¸€ä¸ªserverç«¯çš„æºç»„ï¼ˆserver_ip+portï¼‰ï¼Œæ¯”å¦‚æœ‰65535ä¸ªclientï¼Œé‚£ä¼šä¸ä¼šå—é™äºè¿™ä¸ªå…¨è¿æ¥é˜Ÿåˆ—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: ä¼šï¼Œä½† linuxå¯ä»¥ä¿®æ”¹ &#47;proc&#47;sys&#47;net&#47;core&#47;somaxconn</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-04-09 09:50:20</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/26/eb/d7/90391376.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>ifelse</span>
  </div>
  <div class="_2_QraFYR_0">nice</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: good</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-02-25 19:54:59</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src=""
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>GeekCoder</span>
  </div>
  <div class="_2_QraFYR_0">èƒ½è®²è®²epollå—ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æœ¬è¯¾ç¨‹æ˜¯oså®ç°è¯¾ç¨‹ ä¸ä¼šè®²åˆ°è¿™ä¸ª</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-10-24 15:17:05</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>pedro</span>
  </div>
  <div class="_2_QraFYR_0">è¿™é‡Œæœ‰ä¸€ç¯‡ä¸‰æ¬¡æ¡æ‰‹çš„æºç å›¾è§£ï¼šhttps:&#47;&#47;mp.weixin.qq.com&#47;s&#47;vlrzGc5bFrPIr9a7HIr2eA</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: è°¢è°¢ è€é“</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-09 14:26:11</div>
  </div>
</div>
</div>
</li>
</ul>