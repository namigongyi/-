<audio title="31_ç§ä¸€ç§Linuxï¼šå¦‚ä½•è·å–æ‰€æœ‰è®¾å¤‡ä¿¡æ¯ï¼Ÿ" src="https://static001.geekbang.org/resource/audio/45/1a/45316e5b1aacb41a63c187ca49dc441a.mp3" controls="controls"></audio> 
<p>ä½ å¥½ï¼Œæˆ‘æ˜¯LMOSã€‚</p><p>å‰é¢æˆ‘ä»¬å·²ç»å®Œæˆäº†Cosmosçš„é©±åŠ¨è®¾å¤‡çš„å»ºç«‹ï¼Œè¿˜å†™å¥½äº†ä¸€ä¸ªçœŸå®çš„è®¾å¤‡é©±åŠ¨ã€‚</p><p>ä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹Linuxæ˜¯å¦‚ä½•ç®¡ç†è®¾å¤‡çš„ã€‚æˆ‘ä»¬å°†ä»Linuxå¦‚ä½•ç»„ç»‡è®¾å¤‡å¼€å§‹ï¼Œç„¶åç ”ç©¶è®¾å¤‡é©±åŠ¨ç›¸å…³çš„æ•°æ®ç»“æ„ï¼Œæœ€åæˆ‘ä»¬è¿˜æ˜¯è¦ä¸€èµ·å†™ä¸€ä¸ªLinuxè®¾å¤‡é©±åŠ¨å®ä¾‹ï¼Œè¿™æ ·æ‰èƒ½çœŸæ­£ç†è§£å®ƒã€‚</p><h2>æ„Ÿå—ä¸€ä¸‹Linuxä¸‹çš„è®¾å¤‡ä¿¡æ¯</h2><p>Linuxçš„è®¾è®¡å“²å­¦å°±æ˜¯ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œå„ç§è®¾å¤‡åœ¨Linuxç³»ç»Ÿä¸‹è‡ªç„¶ä¹Ÿæ˜¯ä¸€ä¸ªä¸ªæ–‡ä»¶ã€‚ä¸è¿‡è¿™ä¸ªæ–‡ä»¶å¹¶ä¸å¯¹åº”ç£ç›˜ä¸Šçš„æ•°æ®æ–‡ä»¶ï¼Œè€Œæ˜¯å¯¹åº”ç€å­˜åœ¨å†…å­˜å½“ä¸­çš„è®¾å¤‡æ–‡ä»¶ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯¹è®¾å¤‡æ–‡ä»¶è¿›è¡Œæ“ä½œï¼Œå°±ç­‰åŒäºæ“ä½œå…·ä½“çš„è®¾å¤‡ã€‚</p><p>æ—¢ç„¶æˆ‘ä»¬äº†è§£ä¸‡äº‹ä¸‡ç‰©ï¼Œéƒ½æ˜¯ä»æœ€ç›´è§‚çš„æ„Ÿå—å¼€å§‹çš„ï¼Œæƒ³è¦ç†è§£Linuxå¯¹è®¾å¤‡çš„ç®¡ç†ï¼Œè‡ªç„¶ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ã€‚é‚£ä¹ˆLinuxè®¾å¤‡æ–‡ä»¶åœ¨å“ªä¸ªç›®å½•ä¸‹å‘¢ï¼Ÿå…¶å®ç°åœ¨æˆ‘ä»¬åœ¨/sys/busç›®å½•ä¸‹ï¼Œå°±å¯ä»¥æŸ¥çœ‹æ‰€æœ‰çš„è®¾å¤‡äº†ã€‚</p><p>Linuxç”¨BUSï¼ˆæ€»çº¿ï¼‰ç»„ç»‡è®¾å¤‡å’Œé©±åŠ¨ï¼Œæˆ‘ä»¬åœ¨/sys/busç›®å½•ä¸‹è¾“å…¥treeå‘½ä»¤ï¼Œå°±å¯ä»¥çœ‹åˆ°æ‰€æœ‰æ€»çº¿ä¸‹çš„æ‰€æœ‰è®¾å¤‡äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://static001.geekbang.org/resource/image/56/28/567588d1ca461ed56c4cd3447d9dff28.jpg?wh=990x1047" alt="" title="Linuxè®¾å¤‡æ–‡ä»¶"></p><p>ä¸Šå›¾ä¸­ï¼Œæ˜¾ç¤ºäº†éƒ¨åˆ†Linuxè®¾å¤‡æ–‡ä»¶ï¼Œæœ‰äº›è®¾å¤‡æ–‡ä»¶æ˜¯é“¾æ¥åˆ°å…¶å®ƒç›®å½•ä¸‹æ–‡ä»¶ï¼Œè¿™ä¸æ˜¯é‡ç‚¹ï¼Œé‡ç‚¹æ˜¯ä½ è¦åœ¨å¿ƒä¸­æœ‰è¿™ä¸ªç›®å½•å±‚æ¬¡ç»“æ„ï¼Œå³<strong>æ€»çº¿ç›®å½•ä¸‹æœ‰è®¾å¤‡ç›®å½•ï¼Œè®¾å¤‡ç›®å½•ä¸‹æ˜¯è®¾å¤‡æ–‡ä»¶</strong>ã€‚</p><!-- [[[read_end]]] --><h2>æ•°æ®ç»“æ„</h2><p>æˆ‘ä»¬æ¥ç€åˆšæ‰çš„å›¾å¾€ä¸‹è¯´ï¼Œæˆ‘ä»¬èƒ½æ„Ÿè§‰åˆ°Linuxçš„é©±åŠ¨æ¨¡å‹è‡³å°‘æœ‰ä¸‰ä¸ªæ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œåˆ†åˆ«æ˜¯æ€»çº¿ã€è®¾å¤‡å’Œé©±åŠ¨ï¼Œä½†æ˜¯è¦åƒä¸Šå›¾é‚£æ ·æœ‰å±‚æ¬¡åŒ–åœ°ç»„ç»‡å®ƒä»¬ï¼Œåªæœ‰æ€»çº¿ã€è®¾å¤‡ã€é©±åŠ¨è¿™ä¸‰ä¸ªæ•°æ®ç»“æ„æ˜¯ä¸å¤Ÿçš„ï¼Œè¿˜å¾—æœ‰ä¸¤ä¸ªæ•°æ®ç»“æ„æ¥ç»„ç»‡å®ƒä»¬ï¼Œé‚£å°±æ˜¯kobjectå’Œksetï¼Œä¸‹é¢æˆ‘ä»¬å°±å»ç ”ç©¶å®ƒä»¬ã€‚</p><h3>kobjectä¸kset</h3><p>kobjectå’Œksetæ˜¯æ„æˆ/sysç›®å½•ä¸‹çš„ç›®å½•èŠ‚ç‚¹å’Œæ–‡ä»¶èŠ‚ç‚¹çš„æ ¸å¿ƒï¼Œä¹Ÿæ˜¯å±‚æ¬¡åŒ–ç»„ç»‡æ€»çº¿ã€è®¾å¤‡ã€é©±åŠ¨çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œkobjectã€ksetæ•°æ®ç»“æ„éƒ½èƒ½è¡¨ç¤ºä¸€ä¸ªç›®å½•æˆ–è€…æ–‡ä»¶èŠ‚ç‚¹ã€‚ä¸‹é¢æˆ‘ä»¬å…ˆæ¥ç ”ç©¶ä¸€ä¸‹kobjectæ•°æ®ç»“æ„ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>struct kobject {
    const char      *name;           //åç§°ï¼Œåæ˜ åœ¨sysfsä¸­
    struct list_head    entry;       //æŒ‚å…¥ksetç»“æ„çš„é“¾è¡¨
    struct kobject      *parent;     //æŒ‡å‘çˆ¶ç»“æ„ 
    struct kset     *kset;           //æŒ‡å‘æ‰€å±çš„kset
    struct kobj_type    *ktype;
    struct kernfs_node  *sd;         //æŒ‡å‘sysfsæ–‡ä»¶ç³»ç»Ÿç›®å½•é¡¹ 
    struct kref     kref;            //å¼•ç”¨è®¡æ•°å™¨ç»“æ„
    unsigned int state_initialized:1;//åˆå§‹åŒ–çŠ¶æ€
    unsigned int state_in_sysfs:1;   //æ˜¯å¦åœ¨sysfsä¸­
    unsigned int state_add_uevent_sent:1;
    unsigned int state_remove_uevent_sent:1;
    unsigned int uevent_suppress:1;
};
</code></pre><p>æ¯ä¸€ä¸ª kobjectï¼Œéƒ½å¯¹åº”ç€ /sysç›®å½•ä¸‹ï¼ˆå…¶å®æ˜¯sysfsæ–‡ä»¶ç³»ç»ŸæŒ‚è½½åœ¨/sysç›®å½•ä¸‹ï¼‰ çš„ä¸€ä¸ªç›®å½•æˆ–è€…æ–‡ä»¶ï¼Œç›®å½•æˆ–è€…æ–‡ä»¶çš„åå­—å°±æ˜¯kobjectç»“æ„ä¸­çš„nameã€‚</p><p>æˆ‘ä»¬ä»kobjectç»“æ„ä¸­å¯ä»¥çœ‹å‡ºï¼Œå®ƒæŒ‚è½½åœ¨ksetä¸‹ï¼Œå¹¶ä¸”æŒ‡å‘äº†ksetï¼Œé‚£ksetæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬æ¥åˆ†æåˆ†æï¼Œå®ƒæ˜¯kobjectç»“æ„çš„å®¹å™¨å—ï¼Ÿ</p><p>å…¶å®æ˜¯ä¹Ÿä¸æ˜¯ï¼Œå› ä¸ºksetç»“æ„ä¸­æœ¬èº«åˆåŒ…å«ä¸€ä¸ªkobjectç»“æ„ï¼Œæ‰€ä»¥å®ƒæ—¢æ˜¯kobjectçš„å®¹å™¨ï¼ŒåŒæ—¶æœ¬èº«è¿˜æ˜¯ä¸€ä¸ªkobjectã€‚ksetç»“æ„ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>struct kset {
    struct list_head list; //æŒ‚è½½kobjectç»“æ„çš„é“¾è¡¨
    spinlock_t list_lock; //è‡ªæ—‹é”
    struct kobject kobj;//è‡ªèº«åŒ…å«ä¸€ä¸ªkobjectç»“æ„
    const struct kset_uevent_ops *uevent_ops;//æš‚æ—¶ä¸å…³æ³¨
} __randomize_layout;
</code></pre><p>çœ‹åˆ°è¿™é‡Œä½ åº”è¯¥çŸ¥é“äº†ï¼Œksetä¸ä»…ä»…è‡ªå·±æ˜¯ä¸ªkobjectï¼Œè¿˜èƒ½æŒ‚è½½å¤šä¸ªkobjectï¼Œè¿™è¯´æ˜ksetæ˜¯kobjectçš„é›†åˆå®¹å™¨ã€‚åœ¨Linuxå†…æ ¸ä¸­ï¼Œè‡³å°‘æœ‰ä¸¤ä¸ªé¡¶å±‚ksetï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>struct kset *devices_kset;//ç®¡ç†æ‰€æœ‰è®¾å¤‡
static struct kset *bus_kset;//ç®¡ç†æ‰€æœ‰æ€»çº¿
static struct kset *system_kset;
int __init devices_init(void)
{
    devices_kset = kset_create_and_add(&quot;devices&quot;, &amp;device_uevent_ops, NULL);//å»ºç«‹è®¾å¤‡kset
    return 0;
}
int __init buses_init(void)
{
    bus_kset = kset_create_and_add(&quot;bus&quot;, &amp;bus_uevent_ops, NULL);//å»ºç«‹æ€»çº¿kset
    if (!bus_kset)
        return -ENOMEM;
    system_kset = kset_create_and_add(&quot;system&quot;, NULL, &amp;devices_kset-&gt;kobj);//åœ¨è®¾å¤‡ksetä¹‹ä¸‹å»ºç«‹systemçš„kset
    if (!system_kset)
        return -ENOMEM;
    return 0;
}
</code></pre><p>æˆ‘çŸ¥é“ï¼Œä½ å¯èƒ½å¾ˆéš¾æƒ³è±¡è®¸å¤šä¸ªksetå’Œkobjectåœ¨é€»è¾‘ä¸Šå½¢æˆçš„å±‚æ¬¡ç»“æ„ï¼Œæ‰€ä»¥æˆ‘ä¸ºä½ ç”»äº†ä¸€å¹…å›¾ï¼Œä½ å¯ä»¥ç»“åˆè¿™å¼ ç¤ºæ„å›¾ç†è§£è¿™ä¸ªç»“æ„ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/bc/da/bcd9216d04b1f2ec6yy67ddf18052fda.jpg?wh=5039x4605" alt="" title="ksetä¸kobject"></p><p>ä¸Šå›¾ä¸­å±•ç¤ºäº†ä¸€ä¸ªç±»ä¼¼æ–‡ä»¶ç›®å½•çš„ç»“æ„ï¼Œè¿™æ­£æ˜¯ksetä¸kobjectè®¾è®¡çš„ç›®æ ‡ä¹‹ä¸€ã€‚ksetä¸kobjectç»“æ„åªæ˜¯åŸºç¡€æ•°æ®ç»“æ„ï¼Œä½†æ˜¯ä»…ä»…åªæœ‰å®ƒçš„è¯ï¼Œä¹Ÿå°±åªèƒ½å®ç°è¿™ä¸ªå±‚æ¬¡ç»“æ„ï¼Œå…¶å®ƒçš„ä»€ä¹ˆä¹Ÿä¸èƒ½å¹²ï¼Œæ ¹æ®æˆ‘ä»¬ä»¥å¾€çš„ç»éªŒå¯ä»¥çŒœå‡ºï¼Œksetä¸kobjectç»“æ„è‚¯å®šæ˜¯åµŒå…¥åˆ°æ›´é«˜çº§çš„æ•°æ®ç»“æ„ä¹‹ä¸­ä½¿ç”¨ï¼Œä¸‹é¢æˆ‘ä»¬ç»§ç»­æ¢ç´¢ã€‚</p><h3>æ€»çº¿</h3><p>ksetã€kobjectç»“æ„åªæ˜¯å¼€èƒƒèœï¼Œè¿™ä¸ªåŸºç¡€äº†è§£äº†ï¼Œæˆ‘ä»¬è¿˜è¦å›åˆ°ç ”ç©¶Linuxè®¾å¤‡ä¸é©±åŠ¨çš„æ­£é¢˜ä¸Šã€‚æˆ‘ä»¬ä¹‹å‰è¯´è¿‡äº†ï¼ŒLinuxç”¨æ€»çº¿ç»„ç»‡è®¾å¤‡å’Œé©±åŠ¨ï¼Œç”±æ­¤å¯è§æ€»çº¿æ˜¯Linuxè®¾å¤‡çš„åŸºç¡€ï¼Œå®ƒå¯ä»¥è¡¨ç¤ºCPUä¸è®¾å¤‡çš„è¿æ¥ï¼Œé‚£ä¹ˆæ€»çº¿çš„æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆæ ·å‘¢ï¼Ÿæˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ã€‚</p><p>LinuxæŠŠæ€»çº¿æŠ½è±¡æˆbus_typeç»“æ„ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>struct bus_type {
    const char      *name;//æ€»çº¿åç§°
    const char      *dev_name;//ç”¨äºåˆ—ä¸¾è®¾å¤‡ï¼Œå¦‚ï¼ˆ&quot;foo%u&quot;, dev-&gt;idï¼‰
    struct device       *dev_root;//çˆ¶è®¾å¤‡
    const struct attribute_group **bus_groups;//æ€»çº¿çš„é»˜è®¤å±æ€§
    const struct attribute_group **dev_groups;//æ€»çº¿ä¸Šè®¾å¤‡çš„é»˜è®¤å±æ€§
    const struct attribute_group **drv_groups;//æ€»çº¿ä¸Šé©±åŠ¨çš„é»˜è®¤å±æ€§
    //æ¯å½“æœ‰æ–°çš„è®¾å¤‡æˆ–é©±åŠ¨ç¨‹åºè¢«æ·»åŠ åˆ°è¿™ä¸ªæ€»çº¿ä¸Šæ—¶è°ƒç”¨
    int (*match)(struct device *dev, struct device_driver *drv);
    //å½“ä¸€ä¸ªè®¾å¤‡è¢«æ·»åŠ ã€ç§»é™¤æˆ–å…¶ä»–ä¸€äº›äº‹æƒ…æ—¶è¢«è°ƒç”¨äº§ç”Ÿueventæ¥æ·»åŠ ç¯å¢ƒå˜é‡ã€‚
    int (*uevent)(struct device *dev, struct kobj_uevent_env *env);
    //å½“ä¸€ä¸ªæ–°çš„è®¾å¤‡æˆ–é©±åŠ¨ç¨‹åºæ·»åŠ åˆ°è¿™ä¸ªæ€»çº¿æ—¶è¢«è°ƒç”¨ï¼Œå¹¶å›è°ƒç‰¹å®šé©±åŠ¨ç¨‹åºæ¢æŸ¥å‡½æ•°ï¼Œä»¥åˆå§‹åŒ–åŒ¹é…çš„è®¾å¤‡
    int (*probe)(struct device *dev);
    //å°†è®¾å¤‡çŠ¶æ€åŒæ­¥åˆ°è½¯ä»¶çŠ¶æ€æ—¶è°ƒç”¨
    void (*sync_state)(struct device *dev);
    //å½“ä¸€ä¸ªè®¾å¤‡ä»è¿™ä¸ªæ€»çº¿ä¸Šåˆ é™¤æ—¶è¢«è°ƒç”¨
    int (*remove)(struct device *dev);
    //å½“ç³»ç»Ÿå…³é—­æ—¶è¢«è°ƒç”¨
    void (*shutdown)(struct device *dev);
    //è°ƒç”¨ä»¥ä½¿è®¾å¤‡é‡æ–°ä¸Šçº¿ï¼ˆåœ¨ä¸‹çº¿åï¼‰
    int (*online)(struct device *dev);
    //è°ƒç”¨ä»¥ä½¿è®¾å¤‡ç¦»çº¿ï¼Œä»¥ä¾¿çƒ­ç§»é™¤ã€‚å¯èƒ½ä¼šå¤±è´¥ã€‚
    int (*offline)(struct device *dev);
    //å½“è¿™ä¸ªæ€»çº¿ä¸Šçš„è®¾å¤‡æƒ³è¿›å…¥ç¡çœ æ¨¡å¼æ—¶è°ƒç”¨
    int (*suspend)(struct device *dev, pm_message_t state);
    //è°ƒç”¨ä»¥ä½¿è¯¥æ€»çº¿ä¸Šçš„ä¸€ä¸ªè®¾å¤‡è„±ç¦»ç¡çœ æ¨¡å¼
    int (*resume)(struct device *dev);
    //è°ƒç”¨ä»¥æ‰¾å‡ºè¯¥æ€»çº¿ä¸Šçš„ä¸€ä¸ªè®¾å¤‡æ”¯æŒå¤šå°‘ä¸ªè™šæ‹Ÿè®¾å¤‡åŠŸèƒ½
    int (*num_vf)(struct device *dev);
    //è°ƒç”¨ä»¥åœ¨è¯¥æ€»çº¿ä¸Šçš„è®¾å¤‡é…ç½®DMA
    int (*dma_configure)(struct device *dev);
    //è¯¥æ€»çº¿çš„ç”µæºç®¡ç†æ“ä½œï¼Œå›è°ƒç‰¹å®šçš„è®¾å¤‡é©±åŠ¨çš„pm-ops
    const struct dev_pm_ops *pm;
    //æ­¤æ€»çº¿çš„IOMMUå…·ä½“æ“ä½œï¼Œç”¨äºå°†IOMMUé©±åŠ¨ç¨‹åºå®ç°åˆ°æ€»çº¿ä¸Š
    const struct iommu_ops *iommu_ops;
    //é©±åŠ¨æ ¸å¿ƒçš„ç§æœ‰æ•°æ®ï¼Œåªæœ‰é©±åŠ¨æ ¸å¿ƒèƒ½å¤Ÿæ¥è§¦è¿™ä¸ª
    struct subsys_private *p;
    struct lock_class_key lock_key;
    //å½“æ¢æµ‹æˆ–ç§»é™¤è¯¥æ€»çº¿ä¸Šçš„ä¸€ä¸ªè®¾å¤‡æ—¶ï¼Œè®¾å¤‡é©±åŠ¨æ ¸å¿ƒåº”è¯¥é”å®šè¯¥è®¾å¤‡
    bool need_parent_lock;
};
</code></pre><p>å¯ä»¥çœ‹å‡ºï¼Œä¸Šé¢ä»£ç çš„bus_typeç»“æ„ä¸­ï¼ŒåŒ…æ‹¬æ€»çº¿åå­—ã€æ€»çº¿å±æ€§ï¼Œè¿˜æœ‰æ“ä½œè¯¥æ€»çº¿ä¸‹æ‰€æœ‰è®¾å¤‡é€šç”¨æ“ä½œå‡½æ•°çš„æŒ‡é’ˆï¼Œå…¶å„ä¸ªå‡½æ•°çš„åŠŸèƒ½æˆ‘åœ¨ä»£ç æ³¨é‡Šä¸­å·²ç»å†™æ¸…æ¥šäº†ã€‚</p><p>ä»è¿™ä¸€ç‚¹å¯ä»¥å‘ç°ï¼Œ<strong>æ€»çº¿ä¸ä»…ä»…æ˜¯ç»„ç»‡è®¾å¤‡å’Œé©±åŠ¨çš„å®¹å™¨ï¼Œè¿˜æ˜¯åŒç±»è®¾å¤‡çš„å…±æœ‰åŠŸèƒ½çš„æŠ½è±¡å±‚ã€‚</strong>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹subsys_privateï¼Œå®ƒæ˜¯æ€»çº¿çš„é©±åŠ¨æ ¸å¿ƒçš„ç§æœ‰æ•°æ®ï¼Œå…¶ä¸­æœ‰æˆ‘ä»¬æƒ³çŸ¥é“çš„ç§˜å¯†ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//é€šè¿‡kobjectæ‰¾åˆ°å¯¹åº”çš„subsys_private
#define to_subsys_private(obj) container_of(obj, struct subsys_private, subsys.kobj)
struct subsys_private {
    struct kset subsys;//å®šä¹‰è¿™ä¸ªå­ç³»ç»Ÿç»“æ„çš„kset
    struct kset *devices_kset;//è¯¥æ€»çº¿çš„&quot;è®¾å¤‡&quot;ç›®å½•ï¼ŒåŒ…å«æ‰€æœ‰çš„è®¾å¤‡
    struct list_head interfaces;//æ€»çº¿ç›¸å…³æ¥å£çš„åˆ—è¡¨
    struct mutex mutex;//ä¿æŠ¤è®¾å¤‡ï¼Œå’Œæ¥å£åˆ—è¡¨
    struct kset *drivers_kset;//è¯¥æ€»çº¿çš„&quot;é©±åŠ¨&quot;ç›®å½•ï¼ŒåŒ…å«æ‰€æœ‰çš„é©±åŠ¨
    struct klist klist_devices;//æŒ‚è½½æ€»çº¿ä¸Šæ‰€æœ‰è®¾å¤‡çš„å¯è¿­ä»£é“¾è¡¨
    struct klist klist_drivers;//æŒ‚è½½æ€»çº¿ä¸Šæ‰€æœ‰é©±åŠ¨çš„å¯è¿­ä»£é“¾è¡¨
    struct blocking_notifier_head bus_notifier;
    unsigned int drivers_autoprobe:1;
    struct bus_type *bus;   //æŒ‡å‘æ‰€å±æ€»çº¿
    struct kset glue_dirs;
    struct class *class;//æŒ‡å‘è¿™ä¸ªç»“æ„æ‰€å…³è”ç±»ç»“æ„çš„æŒ‡é’ˆ
};
</code></pre><p>çœ‹åˆ°è¿™é‡Œï¼Œä½ åº”è¯¥æ˜ç™½ksetçš„ä½œç”¨äº†ï¼Œæˆ‘ä»¬é€šè¿‡bus_ksetå¯ä»¥æ‰¾åˆ°æ‰€æœ‰çš„ksetï¼Œé€šè¿‡ksetåˆèƒ½æ‰¾åˆ°subsys_privateï¼Œå†é€šè¿‡subsys_privateå°±å¯ä»¥æ‰¾åˆ°æ€»çº¿äº†ï¼Œä¹Ÿå¯ä»¥æ‰¾åˆ°è¯¥æ€»çº¿ä¸Šæ‰€æœ‰çš„è®¾å¤‡ä¸é©±åŠ¨ã€‚</p><h3>è®¾å¤‡</h3><p>è™½ç„¶LinuxæŠ½è±¡å‡ºäº†æ€»çº¿ç»“æ„ï¼Œä½†æ˜¯Linuxè¿˜éœ€è¦è¡¨ç¤ºä¸€ä¸ªè®¾å¤‡ï¼Œä¸‹é¢æˆ‘ä»¬æ¥æ¢ç´¢Linuxæ˜¯å¦‚ä½•è¡¨ç¤ºä¸€ä¸ªè®¾å¤‡çš„ã€‚</p><p>å…¶å®ï¼Œåœ¨Linuxç³»ç»Ÿä¸­è®¾å¤‡ä¹Ÿæ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œé‡Œé¢åŒ…å«äº†ä¸€ä¸ªè®¾å¤‡çš„æ‰€æœ‰ä¿¡æ¯ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>struct device {
    struct kobject kobj;
    struct device       *parent;//æŒ‡å‘çˆ¶è®¾å¤‡
    struct device_private   *p;//è®¾å¤‡çš„ç§æœ‰æ•°æ®
    const char      *init_name; //è®¾å¤‡åˆå§‹åŒ–åå­—
    const struct device_type *type;//è®¾å¤‡ç±»å‹
    struct bus_type *bus;  //æŒ‡å‘è®¾å¤‡æ‰€å±æ€»çº¿
    struct device_driver *driver;//æŒ‡å‘è®¾å¤‡çš„é©±åŠ¨
    void        *platform_data;//è®¾å¤‡å¹³å°æ•°æ®
    void        *driver_data;//è®¾å¤‡é©±åŠ¨çš„ç§æœ‰æ•°æ®
    struct dev_links_info   links;//è®¾å¤‡ä¾›åº”å•†é“¾æ¥
    struct dev_pm_info  power;//ç”¨äºè®¾å¤‡çš„ç”µæºç®¡ç†
    struct dev_pm_domain    *pm_domain;//æä¾›åœ¨ç³»ç»Ÿæš‚åœæ—¶æ‰§è¡Œè°ƒç”¨
#ifdef CONFIG_GENERIC_MSI_IRQ
    struct list_head    msi_list;//ä¸»æœºçš„MSIæè¿°ç¬¦é“¾è¡¨
#endif
    struct dev_archdata archdata;
    struct device_node  *of_node; //ç”¨è®¿é—®è®¾å¤‡æ ‘èŠ‚ç‚¹
    struct fwnode_handle    *fwnode; //è®¾å¤‡å›ºä»¶èŠ‚ç‚¹
    dev_t           devt;   //ç”¨äºåˆ›å»ºsysfs &quot;dev&quot;
    u32         id; //è®¾å¤‡å®ä¾‹id
    spinlock_t      devres_lock;//è®¾å¤‡èµ„æºé“¾è¡¨é”
    struct list_head    devres_head;//è®¾å¤‡èµ„æºé“¾è¡¨
    struct class        *class;//è®¾å¤‡çš„ç±»
    const struct attribute_group **groups;  //å¯é€‰çš„å±æ€§ç»„
    void    (*release)(struct device *dev);//åœ¨æ‰€æœ‰å¼•ç”¨ç»“æŸåé‡Šæ”¾è®¾å¤‡
    struct iommu_group  *iommu_group;//è¯¥è®¾å¤‡å±äºçš„IOMMUç»„
    struct dev_iommu    *iommu;//æ¯ä¸ªè®¾å¤‡çš„é€šç”¨IOMMUè¿è¡Œæ—¶æ•°æ®
};
</code></pre><p>deviceç»“æ„å¾ˆå¤§ï¼Œè¿™é‡Œåˆ é™¤äº†æˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒçš„å†…å®¹ã€‚å¦å¤–ï¼Œæˆ‘ä»¬çœ‹åˆ°deviceç»“æ„ä¸­åŒæ ·åŒ…å«äº†kobjectç»“æ„ï¼Œè¿™ä½¿å¾—è®¾å¤‡å¯ä»¥åŠ å…¥ksetå’Œkobjectç»„å»ºçš„å±‚æ¬¡ç»“æ„ä¸­ã€‚deviceç»“æ„ä¸­æœ‰æ€»çº¿å’Œé©±åŠ¨æŒ‡é’ˆï¼Œè¿™èƒ½å¸®åŠ©è®¾å¤‡æ‰¾åˆ°è‡ªå·±çš„é©±åŠ¨ç¨‹åºå’Œæ€»çº¿ã€‚</p><h3>é©±åŠ¨</h3><p>æœ‰äº†è®¾å¤‡ç»“æ„ï¼Œè¿˜éœ€è¦æœ‰è®¾å¤‡å¯¹åº”çš„é©±åŠ¨ï¼ŒLinuxæ˜¯å¦‚ä½•è¡¨ç¤ºä¸€ä¸ªé©±åŠ¨çš„å‘¢ï¼ŸåŒæ ·ä¹Ÿæ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå…¶ä¸­åŒ…å«äº†é©±åŠ¨ç¨‹åºçš„ç›¸å…³ä¿¡æ¯ã€‚å…¶å®åœ¨deviceç»“æ„ä¸­æˆ‘ä»¬å°±çœ‹åˆ°äº†ï¼Œå°±æ˜¯device_driverç»“æ„ï¼Œä»£ç å¦‚ä¸‹ã€‚</p><pre><code>struct device_driver {
    const char      *name;//é©±åŠ¨åç§°
    struct bus_type     *bus;//æŒ‡å‘æ€»çº¿
    struct module       *owner;//æ¨¡å—æŒæœ‰è€…
    const char      *mod_name;//ç”¨äºå†…ç½®æ¨¡å—
    bool suppress_bind_attrs;//ç¦ç”¨é€šè¿‡sysfsçš„ç»‘å®š/è§£ç»‘
    enum probe_type probe_type;//è¦ä½¿ç”¨çš„æ¢æŸ¥ç±»å‹ï¼ˆåŒæ­¥æˆ–å¼‚æ­¥ï¼‰
    const struct of_device_id   *of_match_table;//å¼€æ”¾å›ºä»¶è¡¨
    const struct acpi_device_id *acpi_match_table;//ACPIåŒ¹é…è¡¨
    //è¢«è°ƒç”¨æ¥æŸ¥è¯¢ä¸€ä¸ªç‰¹å®šè®¾å¤‡çš„å­˜åœ¨
    int (*probe) (struct device *dev);
    //å°†è®¾å¤‡çŠ¶æ€åŒæ­¥åˆ°è½¯ä»¶çŠ¶æ€æ—¶è°ƒç”¨
    void (*sync_state)(struct device *dev);
    //å½“è®¾å¤‡è¢«ä»ç³»ç»Ÿä¸­ç§»é™¤æ—¶è¢«è°ƒç”¨ï¼Œä»¥ä¾¿è§£é™¤è®¾å¤‡ä¸è¯¥é©±åŠ¨çš„ç»‘å®š
    int (*remove) (struct device *dev);
    //å…³æœºæ—¶è°ƒç”¨ï¼Œä½¿è®¾å¤‡åœæ­¢
    void (*shutdown) (struct device *dev);
    //è°ƒç”¨ä»¥ä½¿è®¾å¤‡è¿›å…¥ç¡çœ æ¨¡å¼ï¼Œé€šå¸¸æ˜¯è¿›å…¥ä¸€ä¸ªä½åŠŸç‡çŠ¶æ€
    int (*suspend) (struct device *dev, pm_message_t state);
    //è°ƒç”¨ä»¥ä½¿è®¾å¤‡ä»ç¡çœ æ¨¡å¼ä¸­æ¢å¤
    int (*resume) (struct device *dev);
    //é»˜è®¤å±æ€§
    const struct attribute_group **groups;
    //ç»‘å®šè®¾å¤‡çš„å±æ€§
    const struct attribute_group **dev_groups;
    //è®¾å¤‡ç”µæºæ“ä½œ
    const struct dev_pm_ops *pm;
    //å½“sysfsç›®å½•è¢«å†™å…¥æ—¶è¢«è°ƒç”¨
    void (*coredump) (struct device *dev);
    //é©±åŠ¨ç¨‹åºç§æœ‰æ•°æ®
    struct driver_private *p;
};
struct driver_private {
    struct kobject kobj;
    struct klist klist_devices;//é©±åŠ¨ç®¡ç†çš„æ‰€æœ‰è®¾å¤‡çš„é“¾è¡¨
    struct klist_node knode_bus;//åŠ å…¥busé“¾è¡¨çš„èŠ‚ç‚¹
    struct module_kobject *mkobj;//æŒ‡å‘ç”¨kobjectç®¡ç†æ¨¡å—èŠ‚ç‚¹
    struct device_driver *driver;//æŒ‡å‘é©±åŠ¨æœ¬èº«
};
</code></pre><p>åœ¨device_driverç»“æ„ä¸­ï¼ŒåŒ…å«äº†é©±åŠ¨ç¨‹åºçš„åå­—ã€é©±åŠ¨ç¨‹åºæ‰€åœ¨æ¨¡å—ã€è®¾å¤‡æ¢æŸ¥å’Œç”µæºç›¸å…³çš„å›è°ƒå‡½æ•°çš„æŒ‡é’ˆã€‚åœ¨driver_privateç»“æ„ä¸­åŒæ ·åŒ…å«äº†kobjectç»“æ„ï¼Œç”¨äºç»„ç»‡æ‰€æœ‰çš„é©±åŠ¨ï¼Œè¿˜æŒ‡å‘äº†é©±åŠ¨æœ¬èº«ï¼Œä½ å‘ç°æ²¡æœ‰ï¼Œbus_typeä¸­çš„subsys_privateç»“æ„çš„æœºåˆ¶å¦‚å‡ºä¸€è¾™ã€‚</p><h3>æ–‡ä»¶æ“ä½œå‡½æ•°</h3><p>å‰é¢æˆ‘ä»¬å­¦ä¹ çš„éƒ½æ˜¯Linuxé©±åŠ¨ç¨‹åºçš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å¾ˆå°‘ç”¨åˆ°ï¼Œåªæ˜¯ä¸ºäº†è®©ä½ äº†è§£æœ€åŸºç¡€çš„åŸç†ã€‚</p><p>å…¶å®ï¼Œåœ¨Linuxç³»ç»Ÿä¸­æä¾›äº†æ›´ä¸ºé«˜çº§çš„å°è£…ï¼ŒLinuxå°†è®¾å¤‡åˆ†æˆå‡ ç±»åˆ†åˆ«æ˜¯ï¼šå­—ç¬¦è®¾å¤‡ã€å—è®¾å¤‡ã€ç½‘ç»œè®¾å¤‡ä»¥åŠæ‚é¡¹è®¾å¤‡ã€‚å…·ä½“æƒ…å†µä½ å¯ä»¥å‚è€ƒæˆ‘åé¢æ¢³ç†çš„å›¾è¡¨ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/a4/79/a4104a41c67d94f6c9a7de94a05c6a79.jpg?wh=1554x683" alt="" title="è®¾å¤‡ç±»å‹ä¸€è§ˆè¡¨"></p><p>è¿™äº›ç±»å‹çš„è®¾å¤‡çš„æ•°æ®ç»“æ„ï¼Œéƒ½ä¼šç›´æ¥æˆ–è€…é—´æ¥åŒ…å«åŸºç¡€çš„deviceç»“æ„ï¼Œæˆ‘ä»¬ä»¥æ‚é¡¹è®¾å¤‡ä¸ºä¾‹å­ç ”ç©¶ä¸€ä¸‹ï¼ŒLinuxç”¨miscdeviceç»“æ„è¡¨ç¤ºä¸€ä¸ªæ‚é¡¹è®¾å¤‡ï¼Œä»£ç å¦‚ä¸‹ã€‚</p><pre><code>struct miscdevice  {
    int minor;//è®¾å¤‡å·
    const char *name;//è®¾å¤‡åç§°
    const struct file_operations *fops;//æ–‡ä»¶æ“ä½œå‡½æ•°ç»“æ„
    struct list_head list;//é“¾è¡¨
    struct device *parent;//æŒ‡å‘çˆ¶è®¾å¤‡çš„deviceç»“æ„
    struct device *this_device;//æŒ‡å‘æœ¬è®¾å¤‡çš„deviceç»“æ„
    const struct attribute_group **groups;
    const char *nodename;//èŠ‚ç‚¹åå­—
    umode_t mode;//è®¿é—®æƒé™
};
</code></pre><p>miscdeviceç»“æ„å°±æ˜¯ä¸€ä¸ªæ‚é¡¹è®¾å¤‡ï¼Œå®ƒä¸€èˆ¬åœ¨é©±åŠ¨ç¨‹åºä»£ç æ–‡ä»¶ä¸­é™æ€å®šä¹‰ã€‚æˆ‘ä»¬æ¸…æ¥šåœ°çœ‹è§æœ‰ä¸ªthis_deviceæŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ä¸‹å±‚çš„ã€å±äºè¿™ä¸ªæ‚é¡¹è®¾å¤‡çš„deviceç»“æ„ã€‚</p><p>ä½†æ˜¯è¿™é‡Œé‡ç‚¹æ˜¯<strong>file_operationsç»“æ„</strong>ï¼Œè®¾å¤‡ä¸€ç»æ³¨å†Œï¼Œå°±ä¼šåœ¨sysç›¸å…³çš„ç›®å½•ä¸‹å»ºç«‹è®¾å¤‡å¯¹åº”çš„æ–‡ä»¶ç»“ç‚¹ï¼Œå¯¹è¿™ä¸ªæ–‡ä»¶ç»“ç‚¹æ‰“å¼€ã€è¯»å†™ç­‰æ“ä½œï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°é©±åŠ¨ç¨‹åºå¯¹åº”çš„å‡½æ•°ï¼Œè€Œå¯¹åº”çš„å‡½æ•°æŒ‡é’ˆå°±ä¿å­˜åœ¨file_operationsç»“æ„ä¸­ï¼Œæˆ‘ä»¬ç°åœ¨æ¥çœ‹çœ‹è¿™ä¸ªç»“æ„ã€‚</p><pre><code>struct file_operations {
    struct module *owner;//æ‰€åœ¨çš„æ¨¡å—
    loff_t (*llseek) (struct file *, loff_t, int);//è°ƒæ•´è¯»å†™åç§»
    ssize_t (*read) (struct file *, char __user *, size_t, loff_t *);//è¯»
    ssize_t (*write) (struct file *, const char __user *, size_t, loff_t *);//å†™
    int (*mmap) (struct file *, struct vm_area_struct *);//æ˜ å°„
    int (*open) (struct inode *, struct file *);//æ‰“å¼€
    int (*flush) (struct file *, fl_owner_t id);//åˆ·æ–°
    int (*release) (struct inode *, struct file *);//å…³é—­
} __randomize_layout;
</code></pre><p>file_operationsç»“æ„ä¸­çš„å‡½æ•°æŒ‡é’ˆæœ‰31ä¸ªï¼Œæˆ‘åˆ é™¤äº†æˆ‘ä»¬ä¸ç†Ÿæ‚‰çš„å‡½æ•°æŒ‡é’ˆï¼Œæˆ‘ä»¬äº†è§£åŸç†ï¼Œä¸éœ€è¦ææ¸…æ¥šæ‰€æœ‰å‡½æ•°æŒ‡é’ˆçš„åŠŸèƒ½ã€‚</p><p>é‚£ä¹ˆï¼ŒLinuxå¦‚ä½•è°ƒç”¨åˆ°è¿™ä¸ªfile_operationsç»“æ„ä¸­çš„å‡½æ•°å‘¢ï¼Ÿæˆ‘ä»¥æ‰“å¼€æ“ä½œä¸ºä¾‹ç»™ä½ è®²è®²ï¼ŒLinuxçš„æ‰“å¼€ç³»ç»Ÿè°ƒç”¨æ¥å£ä¼šè°ƒç”¨filp_openå‡½æ•°ï¼Œfilp_openå‡½æ•°çš„è°ƒç”¨è·¯å¾„å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//filp_open
//file_open_name
//do_filp_open
//path_openat
static int do_o_path(struct nameidata *nd, unsigned flags, struct file *file)
{
    struct path path;
    int error = path_lookupat(nd, flags, &amp;path);//è§£ææ–‡ä»¶è·¯å¾„å¾—åˆ°æ–‡ä»¶inodeèŠ‚ç‚¹
    if (!error) {
        audit_inode(nd-&gt;name, path.dentry, 0);
        error = vfs_open(&amp;path, file);//vfså±‚æ‰“å¼€æ–‡ä»¶æ¥å£
        path_put(&amp;path);
    }
    return error;
}
int vfs_open(const struct path *path, struct file *file)
{
    file-&gt;f_path = *path;
    return do_dentry_open(file, d_backing_inode(path-&gt;dentry), NULL);
}
static int do_dentry_open(struct file *f, struct inode *inode,int (*open)(struct inode *, struct file *))
{
    //ç•¥è¿‡æˆ‘ä»¬ä¸æƒ³çœ‹çš„ä»£ç 
    f-&gt;f_op = fops_get(inode-&gt;i_fop);//è·å–æ–‡ä»¶èŠ‚ç‚¹çš„file_operations
    if (!open)//å¦‚æœopenä¸ºç©ºåˆ™è°ƒç”¨file_operationsç»“æ„ä¸­çš„openå‡½æ•°
        open = f-&gt;f_op-&gt;open;
    if (open) {
        error = open(inode, f);
    }
    //ç•¥è¿‡æˆ‘ä»¬ä¸æƒ³çœ‹çš„ä»£ç 
    return 0;
}
</code></pre><p>çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±çŸ¥é“äº†ï¼Œfile_operationsç»“æ„çš„åœ°å€å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶çš„inodeç»“æ„ä¸­ã€‚åœ¨Linuxç³»ç»Ÿä¸­ï¼Œéƒ½æ˜¯ç”¨inodeç»“æ„è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶ï¼Œä¸ç®¡å®ƒæ˜¯æ•°æ®æ–‡ä»¶è¿˜æ˜¯è®¾å¤‡æ–‡ä»¶ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»æ¸…æ¥šäº†æ–‡ä»¶æ“ä½œå‡½æ•°ä»¥åŠå®ƒçš„è°ƒç”¨æµç¨‹ã€‚</p><h2>é©±åŠ¨ç¨‹åºå®ä¾‹</h2><p>æˆ‘ä»¬æƒ³è¦çœŸæ­£ç†è§£Linuxè®¾å¤‡é©±åŠ¨ï¼Œæœ€å¥½çš„æ–¹æ¡ˆå°±æ˜¯å†™ä¸€ä¸ªçœŸå®çš„é©±åŠ¨ç¨‹åºå®ä¾‹ã€‚ä¸‹é¢æˆ‘ä»¬ä¸€èµ·åº”ç”¨å‰é¢çš„åŸºç¡€ï¼Œç»“åˆLinuxæä¾›çš„é©±åŠ¨ç¨‹åºå¼€å‘æ¥å£ï¼Œä¸€èµ·å®ç°ä¸€ä¸ªçœŸå®é©±åŠ¨ç¨‹åºã€‚</p><p>è¿™ä¸ªé©±åŠ¨ç¨‹åºçš„ä¸»è¦å·¥ä½œï¼Œå°±æ˜¯è·å–æ‰€æœ‰æ€»çº¿å’Œå…¶ä¸‹æ‰€æœ‰è®¾å¤‡çš„åå­—ã€‚ä¸ºæ­¤æˆ‘ä»¬éœ€è¦å…ˆäº†è§£é©±åŠ¨ç¨‹åºçš„æ•´ä½“æ¡†æ¶ï¼Œæ¥ç€å»ºç«‹æˆ‘ä»¬æ€»çº¿å’Œè®¾å¤‡ï¼Œç„¶åå®ç°é©±åŠ¨ç¨‹åºçš„æ‰“å¼€ã€å…³é—­ï¼Œè¯»å†™æ“ä½œå‡½æ•°ï¼Œæœ€åæˆ‘ä»¬å†™ä¸ªåº”ç”¨ç¨‹åºï¼Œæ¥æµ‹è¯•æˆ‘ä»¬çš„é©±åŠ¨ç¨‹åºã€‚</p><h3>é©±åŠ¨ç¨‹åºæ¡†æ¶</h3><p>Linuxå†…æ ¸çš„é©±åŠ¨ç¨‹åºæ˜¯åœ¨ä¸€ä¸ªå¯åŠ è½½çš„å†…æ ¸æ¨¡å—ä¸­å®ç°ï¼Œå¯åŠ è½½çš„å†…æ ¸æ¨¡å—åªéœ€è¦ä¸¤ä¸ªå‡½æ•°å’Œæ¨¡å—ä¿¡æ¯å°±è¡Œï¼Œä½†æ˜¯æˆ‘ä»¬è¦åœ¨æ¨¡å—ä¸­å®ç°æ€»çº¿å’Œè®¾å¤‡é©±åŠ¨ï¼Œæ‰€ä»¥éœ€è¦æ›´å¤šçš„å‡½æ•°å’Œæ•°æ®ç»“æ„ï¼Œå®ƒä»¬çš„ä»£ç å¦‚ä¸‹ã€‚</p><pre><code>#define DEV_NAME  &quot;devicesinfo&quot;
#define BUS_DEV_NAME  &quot;devicesinfobus&quot;

static int misc_find_match(struct device *dev, void *data)
{
    printk(KERN_EMERG &quot;device name is:%s\n&quot;, dev-&gt;kobj.name);
    return 0;
}
//å¯¹åº”äºè®¾å¤‡æ–‡ä»¶çš„è¯»æ“ä½œå‡½æ•°
static ssize_t misc_read (struct file *pfile, char __user *buff, size_t size, loff_t *off)
{
    printk(KERN_EMERG &quot;line:%d,%s is call\n&quot;,__LINE__,__FUNCTION__);
    return 0;
}
//å¯¹åº”äºè®¾å¤‡æ–‡ä»¶çš„å†™æ“ä½œå‡½æ•°
static ssize_t misc_write(struct file *pfile, const char __user *buff, size_t size, loff_t *off)
{
    printk(KERN_EMERG &quot;line:%d,%s is call\n&quot;,__LINE__,__FUNCTION__);    
    return 0;
}
//å¯¹åº”äºè®¾å¤‡æ–‡ä»¶çš„æ‰“å¼€æ“ä½œå‡½æ•°
static int  misc_open(struct inode *pinode, struct file *pfile)
{
    printk(KERN_EMERG &quot;line:%d,%s is call\n&quot;,__LINE__,__FUNCTION__);
    return 0;
} 
//å¯¹åº”äºè®¾å¤‡æ–‡ä»¶çš„å…³é—­æ“ä½œå‡½æ•°
static int misc_release(struct inode *pinode, struct file *pfile)
{
    printk(KERN_EMERG &quot;line:%d,%s is call\n&quot;,__LINE__,__FUNCTION__);
    return 0;
}

static int devicesinfo_bus_match(struct device *dev, struct device_driver *driver)
{
        return !strncmp(dev-&gt;kobj.name, driver-&gt;name, strlen(driver-&gt;name));
}
//å¯¹åº”äºè®¾å¤‡æ–‡ä»¶çš„æ“ä½œå‡½æ•°ç»“æ„
static const  struct file_operations misc_fops = {
    .read     = misc_read,
    .write    = misc_write,
    .release  = misc_release,
    .open     = misc_open,
};
//miscè®¾å¤‡çš„ç»“æ„
static struct miscdevice  misc_dev =  {
    .fops  =  &amp;misc_fops,         //è®¾å¤‡æ–‡ä»¶æ“ä½œæ–¹æ³•
    .minor =  255,                //æ¬¡è®¾å¤‡å·
    .name  =  DEV_NAME,           //è®¾å¤‡å/dev/ä¸‹çš„è®¾å¤‡èŠ‚ç‚¹å
};
//æ€»çº¿ç»“æ„
struct bus_type devicesinfo_bus = {
        .name = BUS_DEV_NAME, //æ€»çº¿åå­—
        .match = devicesinfo_bus_match, //æ€»çº¿matchå‡½æ•°æŒ‡é’ˆ
};
//å†…æ ¸æ¨¡å—å…¥å£å‡½æ•°
static int __init miscdrv_init(void)
{
    printk(KERN_EMERG &quot;INIT misc\n&quot;)ï¼›
    return 0;
}
//å†…æ ¸æ¨¡å—é€€å‡ºå‡½æ•°
static void  __exit miscdrv_exit(void)
{
    printk(KERN_EMERG &quot;EXIT,misc\n&quot;);
}
module_init(miscdrv_init);//ç”³æ˜å†…æ ¸æ¨¡å—å…¥å£å‡½æ•°
module_exit(miscdrv_exit);//ç”³æ˜å†…æ ¸æ¨¡å—é€€å‡ºå‡½æ•°
MODULE_LICENSE(&quot;GPL&quot;);//æ¨¡å—è®¸å¯
MODULE_AUTHOR(&quot;LMOS&quot;);//æ¨¡å—å¼€å‘è€…
</code></pre><p>ä¸€ä¸ªæœ€ç®€å•çš„é©±åŠ¨ç¨‹åºæ¡†æ¶çš„å†…æ ¸æ¨¡å—å°±å†™å¥½äº†ï¼Œè¯¥æœ‰çš„å‡½æ•°å’Œæ•°æ®ç»“æ„éƒ½æœ‰äº†ï¼Œé‚£äº›æ•°æ®ç»“æ„éƒ½æ˜¯é™æ€å®šä¹‰çš„ï¼Œå®ƒä»¬çš„å†…éƒ¨å­—æ®µæˆ‘ä»¬åœ¨å‰é¢ä¹Ÿå·²ç»äº†è§£äº†ã€‚è¿™ä¸ªæ¨¡å—ä¸€æ—¦åŠ è½½å°±ä¼šæ‰§è¡Œmiscdrv_initå‡½æ•°ï¼Œå¸è½½æ—¶å°±ä¼šæ‰§è¡Œmiscdrv_exitå‡½æ•°ã€‚</p><h3>å»ºç«‹è®¾å¤‡</h3><p>Linuxç³»ç»Ÿä¹Ÿæä¾›äº†å¾ˆå¤šä¸“ç”¨æ¥å£å‡½æ•°ï¼Œç”¨æ¥å»ºç«‹æ€»çº¿å’Œè®¾å¤‡ã€‚ä¸‹é¢æˆ‘ä»¬å…ˆæ¥å»ºç«‹ä¸€ä¸ªæ€»çº¿ï¼Œç„¶ååœ¨æ€»çº¿ä¸‹å»ºç«‹ä¸€ä¸ªè®¾å¤‡ã€‚</p><p>é¦–å…ˆæ¥è¯´è¯´å»ºç«‹ä¸€ä¸ªæ€»çº¿ï¼ŒLinuxç³»ç»Ÿæä¾›äº†ä¸€ä¸ªbus_registerå‡½æ•°å‘å†…æ ¸æ³¨å†Œä¸€ä¸ªæ€»çº¿ï¼Œç›¸å½“äºå»ºç«‹äº†ä¸€ä¸ªæ€»çº¿ï¼Œæˆ‘ä»¬éœ€è¦åœ¨miscdrv_initå‡½æ•°ä¸­è°ƒç”¨å®ƒï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>static int __init miscdrv_init(void)
{
    printk(KERN_EMERG &quot;INIT misc\n&quot;);
    busok = bus_register(&amp;devicesinfo_bus);//æ³¨å†Œæ€»çº¿
    return 0;
}
</code></pre><p>bus_registerå‡½æ•°ä¼šåœ¨ç³»ç»Ÿä¸­æ³¨å†Œä¸€ä¸ªæ€»çº¿ï¼Œæ‰€éœ€å‚æ•°å°±æ˜¯æ€»çº¿ç»“æ„çš„åœ°å€(&amp;devicesinfo_bus)ï¼Œè¿”å›é0è¡¨ç¤ºæ³¨å†Œå¤±è´¥ã€‚ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œåœ¨bus_registerå‡½æ•°ä¸­éƒ½åšäº†äº›ä»€ä¹ˆäº‹æƒ…ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>int bus_register(struct bus_type *bus)
{
    int retval;
    struct subsys_private *priv;
    //åˆ†é…ä¸€ä¸ªsubsys_privateç»“æ„
    priv = kzalloc(sizeof(struct subsys_private), GFP_KERNEL);
    //bus_typeå’Œsubsys_privateç»“æ„äº’ç›¸æŒ‡å‘
    priv-&gt;bus = bus;
    bus-&gt;p = priv;
    //æŠŠæ€»çº¿çš„åç§°åŠ å…¥subsys_privateçš„kobjectä¸­
    retval = kobject_set_name(&amp;priv-&gt;subsys.kobj, &quot;%s&quot;, bus-&gt;name);
    priv-&gt;subsys.kobj.kset = bus_kset;//æŒ‡å‘bus_kset
    //æŠŠsubsys_privateä¸­çš„ksetæ³¨å†Œåˆ°ç³»ç»Ÿä¸­
    retval = kset_register(&amp;priv-&gt;subsys);
    //å»ºç«‹æ€»çº¿çš„æ–‡ä»¶ç»“æ„åœ¨sysfsä¸­
    retval = bus_create_file(bus, &amp;bus_attr_uevent);
    //å»ºç«‹subsys_privateä¸­çš„deviceså’Œdriversçš„kset
    priv-&gt;devices_kset = kset_create_and_add(&quot;devices&quot;, NULL,
                         &amp;priv-&gt;subsys.kobj);
    priv-&gt;drivers_kset = kset_create_and_add(&quot;drivers&quot;, NULL,
                         &amp;priv-&gt;subsys.kobj);
    //å»ºç«‹subsys_privateä¸­çš„deviceså’Œdriversé“¾è¡¨ï¼Œç”¨äºå±äºæ€»çº¿çš„è®¾å¤‡å’Œé©±åŠ¨
    klist_init(&amp;priv-&gt;klist_devices, klist_devices_get, klist_devices_put);
    klist_init(&amp;priv-&gt;klist_drivers, NULL, NULL);
    return 0;
}
</code></pre><p>æˆ‘åˆ é™¤äº†å¾ˆå¤šä½ ä¸ç”¨å…³æ³¨çš„ä»£ç ï¼Œçœ‹åˆ°è¿™é‡Œï¼Œä½ åº”è¯¥çŸ¥é“æ€»çº¿æ˜¯æ€ä¹ˆé€šè¿‡subsys_privateæŠŠè®¾å¤‡å’Œé©±åŠ¨å…³è”èµ·æ¥çš„ï¼ˆé€šè¿‡bus_typeå’Œsubsys_privateç»“æ„äº’ç›¸æŒ‡å‘ï¼‰ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆå»ºç«‹è®¾å¤‡ã€‚æˆ‘ä»¬è¿™é‡Œå»ºç«‹ä¸€ä¸ªmiscæ‚é¡¹è®¾å¤‡ã€‚miscæ‚é¡¹è®¾å¤‡éœ€è¦å®šä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œç„¶åè°ƒç”¨miscæ‚é¡¹è®¾å¤‡æ³¨å†Œæ¥å£å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹ã€‚</p><pre><code>#define DEV_NAME  &quot;devicesinfo&quot;
static const  struct file_operations misc_fops = {
    .read     = misc_read,
    .write    = misc_write,
    .release  = misc_release,
    .open     = misc_open,
};
static struct miscdevice  misc_dev =  {
    .fops  =  &amp;misc_fops,         //è®¾å¤‡æ–‡ä»¶æ“ä½œæ–¹æ³•
    .minor =  255,                //æ¬¡è®¾å¤‡å·
    .name  =  DEV_NAME,           //è®¾å¤‡å/dev/ä¸‹çš„è®¾å¤‡èŠ‚ç‚¹å
};
static int __init miscdrv_init(void)
{
    misc_register(&amp;misc_dev);//æ³¨å†Œmiscæ‚é¡¹è®¾å¤‡
    printk(KERN_EMERG &quot;INIT misc busok\n&quot;);
    busok = bus_register(&amp;devicesinfo_bus);//æ³¨å†Œæ€»çº¿
    return 0;
}
</code></pre><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œé™æ€å®šä¹‰äº†miscdeviceç»“æ„çš„å˜é‡misc_devï¼Œmiscdeviceç»“æ„æˆ‘ä»¬åœ¨å‰é¢å·²ç»äº†è§£è¿‡äº†ï¼Œæœ€åè°ƒç”¨misc_registerå‡½æ•°æ³¨å†Œäº†miscæ‚é¡¹è®¾å¤‡ã€‚</p><p>misc_registerå‡½æ•°åˆ°åº•åšäº†ä»€ä¹ˆï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>int misc_register(struct miscdevice *misc)
{
    dev_t dev;
    int err = 0;
    bool is_dynamic = (misc-&gt;minor == MISC_DYNAMIC_MINOR);
    INIT_LIST_HEAD(&amp;misc-&gt;list);
    mutex_lock(&amp;misc_mtx);
    if (is_dynamic) {//minoræ¬¡è®¾å¤‡å·å¦‚æœç­‰äº255å°±è‡ªåŠ¨åˆ†é…æ¬¡è®¾å¤‡
        int i = find_first_zero_bit(misc_minors, DYNAMIC_MINORS);
        if (i &gt;= DYNAMIC_MINORS) {
            err = -EBUSY;
            goto out;
        }
        misc-&gt;minor = DYNAMIC_MINORS - i - 1;
        set_bit(i, misc_minors);
    } else {//å¦åˆ™æ£€æŸ¥æ¬¡è®¾å¤‡å·æ˜¯å¦å·²ç»è¢«å æœ‰
        struct miscdevice *c;
        list_for_each_entry(c, &amp;misc_list, list) {
            if (c-&gt;minor == misc-&gt;minor) {
                err = -EBUSY;
                goto out;
            }
        }
    }
    dev = MKDEV(MISC_MAJOR, misc-&gt;minor);//åˆå¹¶ä¸»ã€æ¬¡è®¾å¤‡å·
    //å»ºç«‹è®¾å¤‡
    misc-&gt;this_device =
        device_create_with_groups(misc_class, misc-&gt;parent, dev,
                      misc, misc-&gt;groups, &quot;%s&quot;, misc-&gt;name);
    //æŠŠè¿™ä¸ªmiscåŠ å…¥åˆ°å…¨å±€misc_listé“¾è¡¨
    list_add(&amp;misc-&gt;list, &amp;misc_list);
 out:
    mutex_unlock(&amp;misc_mtx);
    return err;
}
</code></pre><p>å¯ä»¥çœ‹å‡ºï¼Œmisc_registerå‡½æ•°åªæ˜¯è´Ÿè´£åˆ†é…è®¾å¤‡å·ï¼Œä»¥åŠæŠŠmiscdevåŠ å…¥é“¾è¡¨ï¼ŒçœŸæ­£çš„æ ¸å¿ƒå·¥ä½œç”±device_create_with_groupså‡½æ•°æ¥å®Œæˆï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>struct device *device_create_with_groups(struct class *class,
                     struct device *parent, dev_t devt,void *drvdata,const struct attribute_group **groups,const char *fmt, ...)
{
    va_list vargs;
    struct device *dev;
    va_start(vargs, fmt);
    dev = device_create_groups_vargs(class, parent, devt, drvdata, groups,fmt, vargs);
    va_end(vargs);
    return dev;
}
struct device *device_create_groups_vargs(struct class *class, struct device *parent, dev_t devt, void *drvdata,const struct attribute_group **groups,const char *fmt, va_list args)
{
    struct device *dev = NULL;
    int retval = -ENODEV;
    dev = kzalloc(sizeof(*dev), GFP_KERNEL);//åˆ†é…è®¾å¤‡ç»“æ„çš„å†…å­˜ç©ºé—´
    device_initialize(dev);//åˆå§‹åŒ–è®¾å¤‡ç»“æ„
    dev-&gt;devt = devt;//è®¾ç½®è®¾å¤‡å·
    dev-&gt;class = class;//è®¾ç½®è®¾å¤‡ç±»
    dev-&gt;parent = parent;//è®¾ç½®è®¾å¤‡çš„çˆ¶è®¾å¤‡
    dev-&gt;groups = groups;////è®¾ç½®è®¾å¤‡å±æ€§
    dev-&gt;release = device_create_release;
    dev_set_drvdata(dev, drvdata);//è®¾ç½®miscdevçš„åœ°å€åˆ°è®¾å¤‡ç»“æ„ä¸­
    retval = kobject_set_name_vargs(&amp;dev-&gt;kobj, fmt, args);//æŠŠåç§°è®¾ç½®åˆ°è®¾å¤‡çš„kobjextä¸­å»
    retval = device_add(dev);//æŠŠè®¾å¤‡åŠ å…¥åˆ°ç³»ç»Ÿä¸­
    if (retval)
        goto error;
    return dev;//è¿”å›è®¾å¤‡
error:
    put_device(dev);
    return ERR_PTR(retval);
}
</code></pre><p>åˆ°è¿™é‡Œï¼Œmiscè®¾å¤‡çš„æ³¨å†Œå°±ææ¸…æ¥šäº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹çœ‹çœ‹ç»“æœï¼Œçœ‹çœ‹Linuxç³»ç»Ÿæ˜¯ä¸æ˜¯å¤šäº†ä¸€ä¸ªæ€»çº¿å’Œè®¾å¤‡ã€‚</p><p>ä½ å¯ä»¥åœ¨æœ¬è¯¾ç¨‹çš„ä»£ç ç›®å½•ä¸­ï¼Œæ‰§è¡ŒmakeæŒ‡ä»¤ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªmiscdvrv.koå†…æ ¸æ¨¡å—æ–‡ä»¶ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªæ¨¡å—æ–‡ä»¶åŠ è½½åˆ°Linuxç³»ç»Ÿä¸­å°±è¡Œäº†ã€‚</p><p>ä¸ºäº†çœ‹åˆ°æ•ˆæœï¼Œæˆ‘ä»¬è¿˜å¿…é¡»è¦åšå¦ä¸€ä»¶äº‹æƒ…ã€‚ åœ¨ç»ˆç«¯ä¸­ç”¨sudo cat /proc/kmsg æŒ‡ä»¤è¯»å–/proc/kmsgæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æ˜¯å†…æ ¸prinkå‡½æ•°è¾“å‡ºä¿¡æ¯çš„æ–‡ä»¶ã€‚æŒ‡ä»¤å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>#ç¬¬ä¸€æ­¥åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤
sudo cat /proc/kmsg
#ç¬¬äºŒæ­¥åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤
make
sudo insmod miscdrv.ko
#ä¸ç”¨è¿™ä¸ªæ¨¡å—äº†å¯ä»¥ç”¨ä»¥ä¸‹æŒ‡ä»¤å¸è½½
sudo rmmod miscdrv.ko
</code></pre><p>insmodæŒ‡ä»¤æ˜¯åŠ è½½ä¸€ä¸ªå†…æ ¸æ¨¡å—ï¼Œä¸€æ—¦åŠ è½½æˆåŠŸå°±ä¼šæ‰§è¡Œmiscdrv_initå‡½æ•°ã€‚å¦‚æœä¸å‡ºæ„å¤–ï¼Œä½ åœ¨ç»ˆç«¯ä¸­ä¼šçœ‹åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºçš„æƒ…å†µã€‚</p><p><img src="https://static001.geekbang.org/resource/image/93/3b/93a929ea1218c7f934713fbf03ba643b.jpg?wh=846x449" alt="" title="é©±åŠ¨æµ‹è¯•"></p><p>è¿™è¯´æ˜æˆ‘ä»¬è®¾å¤‡å·²ç»å»ºç«‹äº†ï¼Œä½ åº”è¯¥å¯ä»¥åœ¨/devç›®å½•çœ‹åˆ°ä¸€ä¸ªdevicesinfoæ–‡ä»¶ï¼ŒåŒæ—¶ä½ åœ¨/sys/bus/ç›®å½•ä¸‹ä¹Ÿå¯ä»¥çœ‹åˆ°ä¸€ä¸ªdevicesinfobusæ–‡ä»¶ã€‚è¿™å°±æ˜¯æˆ‘ä»¬å»ºç«‹çš„è®¾å¤‡å’Œæ€»çº¿çš„æ–‡ä»¶èŠ‚ç‚¹çš„åç§°ã€‚</p><h3>æ‰“å¼€ã€å…³é—­ã€è¯»å†™å‡½æ•°</h3><p>å»ºç«‹äº†è®¾å¤‡å’Œæ€»çº¿ï¼Œæœ‰äº†è®¾å¤‡æ–‡ä»¶èŠ‚ç‚¹ï¼Œåº”ç”¨ç¨‹åºå°±å¯ä»¥æ‰“å¼€ã€å…³é—­ä»¥åŠè¯»å†™è¿™ä¸ªè®¾å¤‡æ–‡ä»¶äº†ã€‚</p><p>è™½ç„¶ç°åœ¨ç¡®å®å¯ä»¥æ“ä½œè®¾å¤‡æ–‡ä»¶äº†ï¼Œåªä¸è¿‡è¿˜ä¸èƒ½å®Œæˆä»»ä½•å®é™…åŠŸèƒ½ï¼Œå› ä¸ºæˆ‘ä»¬åªæ˜¯å†™å¥½äº†æ¡†æ¶å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸‹é¢å°±å»å†™å¥½å¹¶å¡«å……è¿™äº›æ¡†æ¶å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>//æ‰“å¼€
static int  misc_open(struct inode *pinode, struct file *pfile)
{
    printk(KERN_EMERG &quot;line:%d,%s is call\n&quot;,__LINE__,__FUNCTION__);//æ‰“å°è¿™ä¸ªå‡½æ•°æ‰€åœ¨æ–‡ä»¶çš„è¡Œå·å’Œåç§°
    return 0;
}
//å…³é—­ 
static int misc_release(struct inode *pinode, struct file *pfile)
{
    printk(KERN_EMERG &quot;line:%d,%s is call\n&quot;,__LINE__,__FUNCTION__);//æ‰“å°è¿™ä¸ªå‡½æ•°æ‰€åœ¨æ–‡ä»¶çš„è¡Œå·å’Œåç§°
    return 0;
}
//å†™
static ssize_t misc_write(struct file *pfile, const char __user *buff, size_t size, loff_t *off)
{
    printk(KERN_EMERG &quot;line:%d,%s is call\n&quot;,__LINE__,__FUNCTION__);//æ‰“å°è¿™ä¸ªå‡½æ•°æ‰€åœ¨æ–‡ä»¶çš„è¡Œå·å’Œåç§°    
    return 0;
}
</code></pre><p>ä»¥ä¸Šä¸‰ä¸ªå‡½æ•°ï¼Œä»ç„¶æ²¡å¹²ä»€ä¹ˆå®é™…å·¥ä½œï¼Œå°±æ˜¯æ‰“å°è¯¥å‡½æ•°æ‰€åœ¨æ–‡ä»¶çš„è¡Œå·å’Œåç§°ï¼Œç„¶åè¿”å›0å°±å®Œäº‹äº†ã€‚å›åˆ°å‰é¢ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯è¦è·å–Linuxä¸­æ‰€æœ‰æ€»çº¿ä¸Šçš„æ‰€æœ‰è®¾å¤‡ï¼Œæ‰€ä»¥åœ¨è¯»å‡½æ•°ä¸­æ¥å®ç°æ˜¯åˆç†çš„ã€‚</p><p>å…·ä½“å®ç°çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>#define to_subsys_private(obj) container_of(obj, struct subsys_private, subsys.kobj)//ä»kobjectä¸Šè·å–subsys_privateçš„åœ°å€
struct kset *ret_buskset(void)
{
    struct subsys_private *p;
    if(busok)
        return NULL;
    if(!devicesinfo_bus.p)
        return NULL;
    p = devicesinfo_bus.p;
    if(!p-&gt;subsys.kobj.kset)
        return NULL;
    //è¿”å›devicesinfo_busæ€»çº¿ä¸Šçš„ksetï¼Œæ­£æ˜¯bus_kset
    return p-&gt;subsys.kobj.kset;
}
static int misc_find_match(struct device *dev, void *data)
{
    struct bus_type* b = (struct bus_type*)data;
    printk(KERN_EMERG &quot;%s----&gt;device name is:%s\n&quot;, b-&gt;name, dev-&gt;kobj.name);//æ‰“å°æ€»çº¿åç§°å’Œè®¾å¤‡åç§°
    return 0;
}
static ssize_t misc_read (struct file *pfile, char __user *buff, size_t size, loff_t *off)
{
    struct kobject* kobj;
    struct kset* kset;
    struct subsys_private* p;
    kset = ret_buskset();//è·å–bus_ksetçš„åœ°å€
    if(!kset)
        return 0;
    printk(KERN_EMERG &quot;line:%d,%s is call\n&quot;,__LINE__,__FUNCTION__);//æ‰“å°è¿™ä¸ªå‡½æ•°æ‰€åœ¨æ–‡ä»¶çš„è¡Œå·å’Œåç§°
    //æ‰«ææ‰€æœ‰æ€»çº¿çš„kobject
    list_for_each_entry(kobj, &amp;kset-&gt;list, entry)
    {
        p = to_subsys_private(kobj);
        printk(KERN_EMERG &quot;Bus name is:%s\n&quot;,p-&gt;bus-&gt;name);
        //éå†å…·ä½“æ€»çº¿ä¸Šçš„æ‰€æœ‰è®¾å¤‡
        bus_for_each_dev(p-&gt;bus, NULL, p-&gt;bus, misc_find_match);
    }
    return 0;
}
</code></pre><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ˜¯ä¸èƒ½è·å–bus_ksetåœ°å€çš„ï¼Œå®ƒæ˜¯æ‰€æœ‰æ€»çº¿çš„æ ¹ï¼ŒåŒ…å«äº†æ‰€æœ‰æ€»çº¿çš„kobjectï¼ŒLinuxä¸ºäº†ä¿æŠ¤bus_ksetï¼Œå¹¶æ²¡æœ‰åœ¨bus_typeç»“æ„ä¸­ç›´æ¥åŒ…å«kobjectï¼Œè€Œæ˜¯è®©æ€»çº¿æŒ‡å‘ä¸€ä¸ªsubsys_privateç»“æ„ï¼Œåœ¨å…¶ä¸­åŒ…å«äº†kobjectç»“æ„ã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦æ³¨å†Œä¸€ä¸ªæ€»çº¿ï¼Œè¿™æ ·å°±èƒ½æ‹”å‡ºèåœå¸¦å‡ºæ³¥ï¼Œå¾—åˆ°bus_ksetï¼Œæ ¹æ®å®ƒåˆèƒ½æ‰¾åˆ°æ‰€æœ‰subsys_privateç»“æ„ä¸­çš„kobjectï¼Œæ¥ç€æ‰¾åˆ°subsys_privateç»“æ„ï¼Œåå‘æŸ¥è¯¢åˆ°bus_typeç»“æ„çš„åœ°å€ã€‚</p><p>ç„¶åè°ƒç”¨Linuxæä¾›çš„bus_for_each_devå‡½æ•°ï¼Œå°±å¯ä»¥éå†ä¸€ä¸ªæ€»çº¿ä¸Šçš„æ‰€æœ‰è®¾å¤‡ï¼Œå®ƒæ¯éå†åˆ°ä¸€ä¸ªè®¾å¤‡ï¼Œå°±è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ç”¨å‚æ•°çš„æ–¹å¼ä¼ ç»™å®ƒçš„ï¼Œåœ¨æˆ‘ä»¬ä»£ç ä¸­å°±æ˜¯misc_find_matchå‡½æ•°ã€‚</p><p>åœ¨è°ƒç”¨misc_find_matchå‡½æ•°æ—¶ï¼Œä¼šæŠŠä¸€ä¸ªè®¾å¤‡ç»“æ„çš„åœ°å€å’Œå¦ä¸€ä¸ªæŒ‡é’ˆä½œä¸ºå‚æ•°ä¼ é€’è¿›æ¥ã€‚æœ€åå°±èƒ½æ‰“å°æ¯ä¸ªè®¾å¤‡çš„åç§°äº†ã€‚</p><h3>æµ‹è¯•é©±åŠ¨</h3><p>é©±åŠ¨ç¨‹åºå·²ç»å†™å¥½ï¼ŒåŠ è½½ä¹‹åä¼šè‡ªåŠ¨å»ºç«‹è®¾å¤‡æ–‡ä»¶ï¼Œä½†æ˜¯é©±åŠ¨ç¨‹åºä¸ä¼šä¸»åŠ¨å·¥ä½œï¼Œæˆ‘ä»¬è¿˜éœ€è¦å†™ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œå¯¹è®¾å¤‡æ–‡ä»¶è¿›è¡Œè¯»å†™ï¼Œæ‰èƒ½æµ‹è¯•é©±åŠ¨ã€‚æˆ‘ä»¬è¿™é‡Œè¿™ä¸ªé©±åŠ¨å¯¹æ‰“å¼€ã€å…³é—­ã€å†™æ“ä½œæ²¡æœ‰ä»€ä¹ˆå®é™…çš„å“åº”ï¼Œä½†æ˜¯åªè¦ä¸€è¯»å°±ä¼šæ‰“å°æ‰€æœ‰è®¾å¤‡çš„ä¿¡æ¯äº†ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥å†™å¥½è¿™ä¸ªåº”ç”¨ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;fcntl.h&gt;
#define DEV_NAME &quot;/dev/devicesinfo&quot;
int main(void)
{
    char buf[] = {0, 0, 0, 0};
    int fd;
    //æ‰“å¼€è®¾å¤‡æ–‡ä»¶
    fd = open(DEV_NAME, O_RDWR);
    if (fd &lt; 0) {
        printf(&quot;æ‰“å¼€ :%s å¤±è´¥!\n&quot;, DEV_NAME);
    }
    //å†™æ•°æ®åˆ°å†…æ ¸ç©ºé—´
    write(fd, buf, 4);
    //ä»å†…æ ¸ç©ºé—´ä¸­è¯»å–æ•°æ®
    read(fd, buf, 4);
    //å…³é—­è®¾å¤‡,ä¹Ÿå¯ä»¥ä¸è°ƒç”¨ï¼Œç¨‹åºå…³é—­æ—¶ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨
    close(fd);
    return 0;
}
</code></pre><p>ä½ å¯ä»¥è¿™æ ·æ“ä½œï¼šåˆ‡æ¢åˆ°æœ¬è¯¾ç¨‹çš„ä»£ç ç›®å½•makeä¸€ä¸‹ï¼Œç„¶ååŠ è½½miscdrv.koæ¨¡å—ï¼Œæœ€ååœ¨ç»ˆç«¯ä¸­æ‰§è¡Œsudo ./appï¼Œå°±èƒ½åœ¨å¦ä¸€ä¸ªå·²ç»æ‰§è¡Œäº†sudo cat /proc/kmsgçš„ç»ˆç«¯ä¸­ï¼Œçœ‹åˆ°åé¢å›¾ç‰‡è¿™æ ·å½¢å¼çš„æ•°æ®ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/29/1c/29e4b5f1a05d114423b3e69b796ccc1c.jpg?wh=990x1047" alt="" title="è·å–è®¾å¤‡åç§°"></p><p>ä¸Šå›¾æ˜¯æˆ‘ç³»ç»Ÿä¸­æ€»çº¿åå’Œè®¾å¤‡åï¼Œä½ çš„è®¡ç®—æœºä¸Šå¯èƒ½ç•¥æœ‰å·®å¼‚ï¼Œå› ä¸ºæˆ‘ä»¬çš„è®¡ç®—æœºç¡¬ä»¶å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥æœ‰å·®å¼‚æ˜¯æ­£å¸¸çš„ï¼Œä¸å¿…å¥‡æ€ªã€‚</p><h2>é‡ç‚¹å›é¡¾</h2><p>å°½ç®¡Linuxé©±åŠ¨æ¨¡å‹å¼‚å¸¸å¤æ‚ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä»¥æœ€å°çš„æˆæœ¬ï¼Œé¢†ä¼šäº†Linuxé©±åŠ¨æ¨¡å‹è®¾è®¡çš„è¦ç‚¹ï¼Œè¿˜åŠ¨æ‰‹å†™äº†ä¸ªå°å°çš„é©±åŠ¨ç¨‹åºã€‚ç°åœ¨æˆ‘æ¥ä¸ºä½ æ¢³ç†ä¸€ä¸‹è¿™èŠ‚è¯¾çš„é‡ç‚¹ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡æŸ¥çœ‹sysç›®å½•ä¸‹çš„æ–‡ä»¶å±‚æ¬¡ç»“æ„ï¼Œç›´è§‚æ„Ÿå—äº†ä¸€ä¸‹Linuxç³»ç»Ÿçš„æ€»çº¿ã€è®¾å¤‡ã€é©±åŠ¨æ˜¯ä»€ä¹ˆæƒ…å†µã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬äº†è§£ä¸€äº›é‡è¦çš„æ•°æ®ç»“æ„ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯æ€»çº¿ã€é©±åŠ¨ã€è®¾å¤‡ã€æ–‡ä»¶æ“ä½œå‡½æ•°ç»“æ„ï¼Œè¿˜æœ‰éå¸¸å…³é”®çš„<strong>ksetå’Œkobject</strong>ï¼Œè¿™ä¸¤ä¸ªç»“æ„ä¸€èµ·ç»„ç»‡äº†æ€»çº¿ã€è®¾å¤‡ã€é©±åŠ¨ï¼Œæœ€ç»ˆå½¢æˆäº†ç±»ç›®å½•æ–‡ä»¶è¿™æ ·çš„å±‚æ¬¡ç»“æ„ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬å»ºç«‹ä¸€ä¸ªé©±åŠ¨ç¨‹åºå®ä¾‹ï¼Œä»é©±åŠ¨ç¨‹åºæ¡†æ¶å¼€å§‹ï¼Œæˆ‘ä»¬äº†è§£å¦‚ä½•å»ºç«‹ä¸€ä¸ªæ€»çº¿å’Œè®¾å¤‡ï¼Œç¼–å†™äº†å¯¹åº”çš„æ–‡ä»¶æ“ä½œå‡½æ•°ï¼Œåœ¨è¯»æ“ä½œå‡½æ•°ä¸­å®ç°æ‰«æäº†æ‰€æœ‰æ€»çº¿ä¸Šçš„æ‰€æœ‰è®¾å¤‡ï¼Œå¹¶æ‰“å°æ€»çº¿åç§°å’Œè®¾å¤‡åç§°ï¼Œè¿˜å†™äº†ä¸ªåº”ç”¨ç¨‹åºè¿›è¡Œäº†æµ‹è¯•ï¼Œæ£€æŸ¥æœ‰æ²¡æœ‰è¾¾åˆ°é¢„æœŸçš„åŠŸèƒ½ã€‚</p><p>å¦‚æœä½ å¯¹Linuxæ˜¯æ€ä¹ˆåœ¨æ€»çº¿ä¸Šæ³¨å†Œè®¾å¤‡å’Œé©±åŠ¨ï¼Œåˆå¯¹é©±åŠ¨å’Œè®¾å¤‡æ€ä¹ˆè¿›è¡ŒåŒ¹é…æ„Ÿå…´è¶£çš„è¯ï¼Œä¹Ÿå¯ä»¥è‡ªå·±é˜…è¯»Linuxå†…æ ¸ä»£ç ï¼Œå…¶ä¸­æœ‰å¾ˆå¤šé©±åŠ¨å®ä¾‹ï¼Œä½ å¯ä»¥ç ”ç©¶å’Œå®éªŒï¼ŒåŠ¨æ‰‹å’ŒåŠ¨è„‘ç›¸ç»“åˆï¼Œæˆ‘ç›¸ä¿¡ä½ ä¸€å®šå¯ä»¥ææ¸…æ¥šçš„ã€‚</p><h2>æ€è€ƒé¢˜</h2><p>ä¸ºä»€ä¹ˆæ— è®ºæ˜¯æˆ‘ä»¬åŠ è½½miscdrv.koå†…æ ¸æ¨¡å—ï¼Œè¿˜æ˜¯è¿è¡Œappæµ‹è¯•ï¼Œéƒ½è¦åœ¨å‰é¢åŠ ä¸Šsudoå‘¢ï¼Ÿ</p><p>æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè®°å½•ä½ çš„å­¦ä¹ æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾åˆ†äº«ç»™ä½ èº«è¾¹çš„å°ä¼™ä¼´ï¼Œä¸€èµ·æ‹¿ä¸‹Linuxè®¾å¤‡é©±åŠ¨çš„å†…å®¹ã€‚</p><p>æˆ‘æ˜¯LMOSï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾è§ï¼</p>
<style>
    ul {
      list-style: none;
      display: block;
      list-style-type: disc;
      margin-block-start: 1em;
      margin-block-end: 1em;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
      padding-inline-start: 40px;
    }
    li {
      display: list-item;
      text-align: -webkit-match-parent;
    }
    ._2sjJGcOH_0 {
      list-style-position: inside;
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      margin-top: 26px;
      border-bottom: 1px solid rgba(233,233,233,0.6);
    }
    ._2sjJGcOH_0 ._3FLYR4bF_0 {
      width: 34px;
      height: 34px;
      -ms-flex-negative: 0;
      flex-shrink: 0;
      border-radius: 50%;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 {
      margin-left: 0.5rem;
      -webkit-box-flex: 1;
      -ms-flex-positive: 1;
      flex-grow: 1;
      padding-bottom: 20px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2zFoi7sd_0 {
      font-size: 16px;
      color: #3d464d;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      line-height: 34px;
    }
    ._2sjJGcOH_0 ._36ChpWj4_0 ._2_QraFYR_0 {
      margin-top: 12px;
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-all;
      line-height: 24px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 {
      margin-top: 18px;
      border-radius: 4px;
      background-color: #f6f7fb;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._10o3OAxT_0 ._3KxQPN3V_0 {
      color: #505050;
      -webkit-font-smoothing: antialiased;
      font-size: 14px;
      font-weight: 400;
      white-space: normal;
      word-break: break-word;
      padding: 20px 20px 20px 24px;
    }
    ._2sjJGcOH_0 ._3klNVc4Z_0 {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      -ms-flex-direction: row;
      flex-direction: row;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      margin-top: 15px;
    }
    ._2sjJGcOH_0 ._3Hkula0k_0 {
      color: #b2b2b2;
      font-size: 14px;
    }
</style><ul><li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>neohope</span>
  </div>
  <div class="_2_QraFYR_0"><br>å…³äºé©±åŠ¨ç¨‹åºDemo<br>ä¸€ã€miscdrvæ˜¯ä¸€ä¸ªå†…æ ¸æ¨¡å—<br>1ã€å››ä¸ªæ“ä½œå‡½æ•°ï¼Œå°è£…åœ¨file_operationsç»“æ„ä¸­ï¼ŒåŒ…æ‹¬ï¼š<br>misc_openåœ¨æ‰“å¼€è®¾å¤‡æ–‡ä»¶æ—¶æ‰§è¡Œ<br>misc_releaseåœ¨å…³é—­è®¾å¤‡æ–‡ä»¶æ—¶æ‰§è¡Œ<br>misc_readåœ¨è¯»å–è®¾å¤‡æ—¶æ‰§è¡Œ<br>misc_writeåœ¨å†™å…¥è®¾å¤‡æ—¶æ‰§è¡Œ<br>file_operationsåˆè¢«å°è£…åœ¨miscdeviceä¸­ï¼Œåœ¨æ³¨å†Œè®¾å¤‡æ—¶ä¼ å…¥<br><br>2ã€devicesinfo_bus_matchå‡½æ•°ç”¨äºæ€»çº¿è®¾å¤‡çš„è¿‡æ»¤ï¼Œè¢«å°è£…åœ¨bus_typeç»“æ„ä¸­<br>bus_typeæè¿°äº†æ€»çº¿ç»“æ„ï¼Œåœ¨æ€»çº¿æ³¨å†Œæ—¶ä¼ å…¥<br><br>3ã€module_initå’Œmodule_exitå£°æ˜å…¥å£å’Œå‡ºå£å‡½æ•°ï¼š<br>miscdrv_initæ³¨å†Œè®¾å¤‡å’Œæ€»çº¿ï¼Œåœ¨å®‰è£…å†…æ ¸æ¨¡å—æ—¶æ‰§è¡Œ<br>miscdrv_exitåæ³¨å†Œè®¾å¤‡å’Œæ€»çº¿ï¼Œåœ¨å¸è½½å†…æ ¸æ¨¡å—æ—¶æ‰§è¡Œ<br><br>4ã€åªæœ‰misc_readæ¯”è¾ƒå¤æ‚ï¼š<br>Aã€é€šè¿‡æ³¨å†Œæ—¶çš„devicesinfo_busè·å–ksetï¼Œæšä¸¾ksetä¸­çš„æ¯ä¸€ä¸ªkobj<br>Bã€å¯¹äºæ¯ä¸ªkobjï¼Œé€šè¿‡container_ofè½¬æ¢ä¸ºsubsys_private<br>Cã€å¯¹äºæ¯ä¸ªsubsys_privateï¼Œæšä¸¾å…¶busä¸­æ¯ä¸ªè®¾å¤‡ï¼Œå¹¶é€šè¿‡misc_find_matchå‡½æ•°è¿›è¡Œå¤„ç†<br>Dã€misc_find_matchä¼šåœ¨kmsgä¸­è¾“å‡ºè®¾å¤‡åç§°<br><br>äºŒã€app.c<br>å°±æ˜¯æ‰“å¼€è®¾å¤‡ï¼Œå†™ä¸€ä¸‹ï¼Œè¯»ä¸€ä¸‹ï¼Œå…³é—­è®¾å¤‡ï¼Œä¸»è¦æ˜¯è§¦å‘è®¾å¤‡è¾“å‡º<br><br>ä¸‰ã€æ‰§è¡Œé¡ºåºï¼Œéœ€è¦ä¸¤ä¸ªTerminalï¼ŒT1å’ŒT2<br>1ã€T1ï¼šmake<br>2ã€T1ï¼šsudo insmod miscdrv.ko<br>3ã€T2ï¼šsudo cat &#47;proc&#47;kmsg<br>4ã€T1ï¼šsudo .&#47;app<br>5ã€T2ï¼šctrl+c<br>6ã€T1ï¼šsudo rmmod miscdrv.ko</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: è€é“ å¯è°“ å­¦ä¹ èƒ½åŠ›çˆ†è¡¨</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-06 23:49:28</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>neohope</span>
  </div>
  <div class="_2_QraFYR_0">å…³äºæ•°æ®ç»“æ„<br>ä¸€ã€ç›®å½•ç»„ç»‡ç›¸å…³ç»“æ„<br>kobjectç»“æ„è¡¨ç¤ºsysfsä¸€ä¸ªç›®å½•æˆ–è€…æ–‡ä»¶èŠ‚ç‚¹ï¼ŒåŒæ—¶æä¾›äº†å¼•ç”¨è®¡æ•°æˆ–ç”Ÿå‘½å‘¨æœŸç®¡ç†ç›¸å…³åŠŸèƒ½ï¼›<br>ksetç»“æ„ï¼Œå¯ä»¥çœ‹ä½œä¸€ç±»ç‰¹æ®Šçš„kobjectï¼Œå¯ä»¥ä½œä¸ºkobjectçš„é›†åˆï¼›åŒæ—¶æ‰¿æ‹…äº†å‘é€ç”¨æˆ·æ¶ˆæ¯çš„åŠŸèƒ½ï¼›<br><br>Linuxé€šè¿‡kobjectå’Œ ksetæ¥ç»„ç»‡sysfsä¸‹çš„ç›®å½•ç»“æ„ã€‚ä½†ä¸¤è€…ä¹‹é—´å…³ç³»ï¼Œå´å¹¶éç®€å•çš„æ–‡ä»¶å’Œç›®å½•çš„å…³ç³»ã€‚æ¯ä¸ªkobjectçš„çˆ¶èŠ‚ç‚¹ï¼Œéœ€è¦é€šè¿‡parentå’Œksetä¸¤ä¸ªå±æ€§æ¥å†³å®šï¼š<br>Aã€æ— parentã€æ— ksetï¼Œåˆ™å°†åœ¨sysfsçš„æ ¹ç›®å½•ï¼ˆå³&#47;sys&#47;ï¼‰ä¸‹åˆ›å»ºç›®å½•ï¼›<br>Bã€æ— parentã€æœ‰ksetï¼Œåˆ™å°†åœ¨ksetä¸‹åˆ›å»ºç›®å½•ï¼›å¹¶å°†kobjåŠ å…¥kset.listï¼›<br>Cã€æœ‰parentã€æ— ksetï¼Œåˆ™å°†åœ¨parentä¸‹åˆ›å»ºç›®å½•ï¼›<br>Dã€æœ‰parentã€æœ‰ksetï¼Œåˆ™å°†åœ¨parentä¸‹åˆ›å»ºç›®å½•ï¼Œå¹¶å°†kobjåŠ å…¥kset.listï¼›<br><br>kobjectå’Œksetå¹¶ä¸ä¼šå•ç‹¬è¢«ä½¿ç”¨ï¼Œè€Œæ˜¯åµŒå…¥åˆ°å…¶ä»–ç»“æ„ä¸­å‘æŒ¥ä½œç”¨ã€‚<br><br>äºŒã€æ€»çº¿ä¸è®¾å¤‡ç»“æ„<br>bus_typeç»“æ„ï¼Œè¡¨ç¤ºä¸€ä¸ªæ€»çº¿ï¼Œå…¶ä¸­ subsys_privateä¸­åŒ…æ‹¬äº†ksetï¼›<br>deviceç»“æ„ï¼Œè¡¨ç¤ºä¸€ä¸ªè®¾å¤‡ï¼ŒåŒ…æ‹¬é©±åŠ¨æŒ‡é’ˆã€æ€»çº¿æŒ‡é’ˆå’Œkobjectï¼›<br>device_driverç»“æ„ï¼Œè¡¨ç¤ºä¸€ä¸ªé©±åŠ¨ï¼Œå…¶ä¸­ driver_privateåŒ…æ‹¬äº†kobjectï¼›<br>ä¸Šé¢è¯´çš„ksetå’Œkobjectçš„ç›®å½•ç»„ç»‡å…³ç³»ï¼Œèµ·å§‹å°±æ˜¯å­˜åœ¨äºè¿™äº›æ•°æ®ç»“æ„ä¸­çš„ï¼›<br>é€šè¿‡ksetå’Œkobjectå°±å¯ä»¥å®ç°æ€»çº¿æŸ¥æ‰¾ã€è®¾å¤‡æŸ¥æ‰¾ç­‰åŠŸèƒ½ï¼›<br><br>ä¸‰ã€åˆå§‹åŒ–<br>å…¨å±€ksetæŒ‡é’ˆdevices_ksetç®¡ç†æ‰€æœ‰è®¾å¤‡<br>å…¨å±€ksetæŒ‡é’ˆbus_ksetç®¡ç†æ‰€æœ‰æ€»çº¿<br><br>åˆå§‹åŒ–è°ƒç”¨é“¾è·¯ï¼š<br>kernel_init-&gt;kernel_init_freeable-&gt;do_basic_setup-&gt;driver_init<br>-&gt;devices_initè®¾å¤‡åˆå§‹åŒ–<br>-&gt;buses_initæ€»çº¿åˆå§‹åŒ–<br><br>å››ã€è®¾å¤‡åŠŸèƒ½å‡½æ•°è°ƒç”¨<br>miscdeviceç»“æ„ï¼Œè¡¨ç¤ºä¸€ä¸ªæ‚é¡¹è®¾å¤‡ï¼›<br>å…¶ä¸­ file_operationsåŒ…å«äº†å…¨éƒ¨åŠŸèƒ½å‡½æ•°æŒ‡é’ˆï¼›<br><br>ä»¥æ‰“å¼€ä¸€ä¸ªè®¾å¤‡æ–‡ä»¶ä¸ºä¾‹ï¼Œå…¶è°ƒç”¨é“¾è·¯ä¸ºï¼š<br>filp_open-&gt;file_open_name-&gt;do_filp_open-&gt;path_openat-&gt;do_o_path-&gt;vfs_open-&gt;do_dentry_open<br>é€šè¿‡file_operationsè·å–äº†openå‡½æ•°æŒ‡é’ˆï¼Œå¹¶è¿›è¡Œäº†è°ƒç”¨</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ˜¯çš„ å“ˆå“ˆ</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-06 23:42:02</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/2d/06/30/c26ea06a.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>è‰¾æ©å‡</span>
  </div>
  <div class="_2_QraFYR_0">ä»¥å‰ä½œä¸ºä½¿ç”¨è€…å»å†™é©±åŠ¨ï¼Œç°åœ¨ä»¥æä¾›è€…çš„è§’åº¦å»åˆ†æé©±åŠ¨ï¼Œåˆæ¥åˆ°äº†ç†Ÿæ‚‰çš„file_operationsç»“æ„äº†ï¼Œå†™è¿‡ç®€å•çš„å†…æ ¸2.6 å’Œ 3.4ç‰ˆæœ¬çš„é©±åŠ¨ï¼Œæ¯ä¸ªç‰ˆæœ¬éƒ½ç¨æœ‰åŒºåˆ«ï¼Œç›²çŒœè¿™ä¸ªæ˜¯5ç‰ˆæœ¬çš„ï¼Œæ¯•ç«Ÿæœ‰äº›é™Œç”Ÿçš„å‡½æ•°ï¼Œåˆšæ‰çœ‹åˆ°äº†ä¸€ä¸ªè¯„è®ºé©±åŠ¨æ˜¯å¦‚ä½•æ“ä½œç¡¬ä»¶çš„ï¼Œæ¥ä¸ªæœ€ç®€å•çš„æŒ‰é”®é©±åŠ¨å°±çŸ¥é“äº†ï¼Œè¿™è¿˜æ²¡è°ˆè°ˆè®¾å¤‡æ ‘ï¼Œè®¾å¤‡æ ‘ä¹Ÿåº”è¯¥è°ˆè°ˆï¼Œåˆ°åº•æ˜¯å“ªä¸ªå¤§èªæ˜æƒ³åˆ°çš„è®¾å¤‡æ ‘</div>
  <div class="_10o3OAxT_0">
    
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-05-09 16:22:59</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/27/f8/2c/92969c48.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>é’ç‰ç™½éœ²</span>
  </div>
  <div class="_2_QraFYR_0">åœ¨Linuxç³»ç»Ÿä¸­ï¼Œsudoå¯ä»¥è·å–è¶…çº§ç”¨æˆ·çš„æƒåˆ©ï¼Œå®ƒä¹‹åçš„å‘½ä»¤å¯ä»¥åœ¨å†…æ ¸æ€ä¸‹è¿›è¡Œå·¥ä½œã€‚<br>è€ŒåŠ è½½miscdrv.koæ¨¡å—å’Œappæµ‹è¯•éƒ½éœ€è¦åœ¨å†…æ ¸æ€ä¸‹è¿›è¡Œã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: æ˜¯çš„ </p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-07-19 09:23:17</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>pedro</span>
  </div>
  <div class="_2_QraFYR_0">åŠ è½½å†…æ ¸æ¨¡å—ï¼Œä½¿ç”¨å†…æ ¸é©±åŠ¨ï¼Œå¾— sudo æƒé™</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å“ˆå“ˆ è¿™é—®é¢˜åˆå¤ªç®€å•äº†</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-07-19 08:56:57</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/29/18/93/a1bbda42.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Zhang</span>
  </div>
  <div class="_2_QraFYR_0">ç»ˆäºçœ‹åˆ°è¿™äº†ï¼Œçœ‹åˆ°æ›™å…‰äº†æ„Ÿè§‰ï¼Œæ‰“ä¸ªå¡ï¼Œæ„Ÿè§‰ä»Šå¤©è¯¾åä½œä¸šç®€å•äº†</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ç¼–è¾‘å›å¤: 6666ï¼Œè¿›å±•å¾ˆå¿«å˜›ï¼Œç»§ç»­åŠ æ²¹ï¼</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-06-25 18:55:14</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src=""
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Geek_Lawrence</span>
  </div>
  <div class="_2_QraFYR_0">é©±åŠ¨ç¨‹åºä»ç„¶æ˜¯â€œè½¯ä»¶â€éƒ¨åˆ†ï¼Œâ€œè½¯ä»¶â€å¦‚ä½•é©±åŠ¨â€œç¡¬ä»¶â€ï¼Œè¿™éƒ¨åˆ†èƒ½å¦æ›´ç»†è‡´ç‚¹ï¼Œæƒ³äº†è§£ä¸‹é©±åŠ¨ç¨‹åºæ˜¯å¦‚ä½•è¿æ¥ç¡¬ä»¶å¹¶ä¸”é©±åŠ¨ç¡¬ä»¶å·¥ä½œçš„ï¼Œå…¶æ›´åŠ åº•å±‚çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: é‚£ä½ éœ€è¦äº†è§£æ¯ä¸€ç§è®¾å¤‡çš„ç¼–ç¨‹ç»†èŠ‚ ï¼Œè¿™é€šå¸¸éœ€è¦ç†Ÿè¯»æ¯ä¸€ç§è®¾å¤‡çš„ç¼–ç¨‹æ•°æ®æ‰‹å†Œ</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2022-01-29 21:19:08</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src=""
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>Mingjie</span>
  </div>
  <div class="_2_QraFYR_0">è€å¸ˆï¼ŒHDMIé©±åŠ¨æ˜¯å±äºå“ªç±»é©±åŠ¨è®¾å¤‡ï¼Ÿæˆ‘è§‰å¾—æ˜¯å—ç±»å‹è®¾å¤‡ï¼Œä¸æ˜¯æœ‰æ˜¾å­˜è¿™ä¸ªè¯´æ³•å˜›ï¼Œæˆ‘æƒ³çš„å¯¹å—</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å±äºæ˜¯MISC</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-11-28 21:56:47</div>
  </div>
</div>
</div>
</li>
<li>
<div class="_2sjJGcOH_0"><img src="https://static001.geekbang.org/account/avatar/00/27/ef/fa/5e9f3dc9.jpg"
  class="_3FLYR4bF_0">
<div class="_36ChpWj4_0">
  <div class="_2zFoi7sd_0"><span>é©°å¾€</span>
  </div>
  <div class="_2_QraFYR_0">æ—¢é™Œç”Ÿåˆç†Ÿæ‚‰çš„ä»£ç ã€‚æ›¾å‡ ä½•æ—¶ï¼Œå¤§å­¦çš„æ—¶å€™å°±æ˜¯ä»platform deviceå…¥æ‰‹ï¼Œæ·±å…¥å­¦ä¹ é©±åŠ¨è®¾å¤‡æ¨¡å‹ï¼Œç„¶è€Œç”±äºå·¥ä½œç¯å¢ƒï¼Œè¶Šå·¥ä½œè¶Šä¸Šå±‚ï¼Œæœ€ç»ˆæ²¡æœ‰è¸å…¥å†…æ ¸è¿™ç‰‡åœ£åœ°ã€‚å¦‚ä»Šå†å­¦æ“ä½œç³»ç»Ÿï¼Œå¸Œæœ›èƒ½å¤Ÿå€Ÿæ­¤æœºä¼šï¼Œäº†å´å½“å¹´çš„åˆå¿ƒğŸ˜„ã€‚</div>
  <div class="_10o3OAxT_0">
    <p class="_3KxQPN3V_0">ä½œè€…å›å¤: å“ˆå“ˆ  ç¨‹åºå‘˜çš„ä¸‰å¤§æµªæ¼«ä¹‹ä¸€</p>
  </div>
  <div class="_3klNVc4Z_0">
    <div class="_3Hkula0k_0">2021-08-31 10:17:20</div>
  </div>
</div>
</div>
</li>
</ul>